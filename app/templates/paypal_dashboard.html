{% extends "base.html" %}

{% block title %}PayPal - Gestione Piani{% endblock %}

{% block content %}
{% include 'paypal/paypal_dashboard.html' %}

<!-- Statistiche -->
<div id="top-cards" class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Piani Totali</h5>
                        <h3>{{ totale_piani }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-list fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Piani Attivi</h5>
                        <h3>{{ piani_attivi }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-play fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Importo Rimanente</h5>
                        <h3>€{{ "%.2f"|format(importo_rimanente_totale) }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-euro-sign fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Rate Non Pagate</h5>
                        <h3>{{ rate_non_pagate_totali }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rate in scadenza -->
{# Rate in scadenza rimossi: visualizziamo la prossima rata direttamente nella tabella dei piani in corso #}

<!-- Lista piani: separa In corso e Completati -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Piani in corso</h5>
        <button id="btn-nuovo-piano" class="btn btn-primary btn-sm" type="button" aria-controls="tmpl-nuovo-piano">
            <i class="fas fa-plus me-1"></i>Nuovo Piano
        </button>
    </div>
    
    <!-- Template Nuovo Piano (inserito dinamicamente) -->
    <template id="tmpl-nuovo-piano">
        <div id="card-nuovo-piano" class="card mb-3">
            <div class="card-header d-flex align-items-center">
                <h5 class="mb-0"><i class="fas fa-plus me-2"></i>Nuovo Piano</h5>
                <button type="button" class="btn btn-link p-0 ms-auto" aria-label="Chiudi" id="btn-close-nuovo-piano">
                    <i class="fas fa-times" style="font-size:1.25rem;color:#fff;"></i>
                </button>
            </div>
            <div class="card-body">
                <form id="form-nuovo-piano" method="POST" action="{{ url_for('paypal.nuovo') }}">
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label for="descrizione" class="form-label">Descrizione</label>
                            <input type="text" class="form-control" id="descrizione" name="descrizione" required placeholder="Es. iPhone 15" style="text-transform: uppercase;">
                        </div>
                        <div class="col-md-3 mb-2">
                            <label for="importo_totale" class="form-label">Importo Totale (€)</label>
                            <input type="number" class="form-control" id="importo_totale" name="importo_totale" step="0.01" min="0.01" required placeholder="0.00">
                        </div>
                        <div class="col-md-3 mb-2">
                            <label for="data_prima_rata" class="form-label">Data Prima Rata</label>
                            <input type="date" class="form-control" id="data_prima_rata" name="data_prima_rata" required>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label for="note" class="form-label">Note (opzionale)</label>
                        <textarea class="form-control" id="note" name="note" rows="2" placeholder="Note aggiuntive..."></textarea>
                    </div>
                    <!-- Save button placed here (right-aligned in body) -->
                    <div class="d-flex justify-content-end mt-2">
                        <button type="submit" id="btn-salva-piano" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Salva
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </template>
    <div class="card-body">
        {% set piani_in_corso = piani|rejectattr('stato', 'equalto', 'completato')|list if piani else [] %}
        {% if piani_in_corso %}
        <div id="piani-in-corso-container">
        <div class="table-responsive">
            <table id="table-piani-in-corso" class="table table-striped">
                <thead>
                    <tr>
                        <th class="text-center">Descrizione</th>
                        <th class="text-center">Importo Totale</th>
                        <th class="text-center">Importo Rata</th>
                        <th class="text-center">Importo Residuo</th>
                        <th class="text-center">Rate Pagate</th>
                        <th class="text-center">Prossima Scadenza</th>
                        
                        <th class="text-center">Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for piano in piani_in_corso %}
                    <tr>
                        <td class="text-start">
                            <strong>{{ piano.descrizione }}</strong>
                            {% if piano.note %}
                            <br><small class="text-muted">{{ piano.note[:50] }}{% if piano.note|length > 50 %}...{% endif %}</small>
                            {% endif %}
                        </td>
                        <td class="text-center">€{{ "%.2f"|format(piano.importo_totale) }}</td>
                        <td class="text-center">€{{ "%.2f"|format(piano.importo_rata) }}</td>
                        <td class="text-center">€{{ "%.2f"|format(piano.importo_rimanente or 0.0) }}</td>
                        <td class="text-center">
                            {% set pagate = (piano.rate|selectattr('stato', 'equalto', 'pagata')|list) if piano.rate else [] %}
                            {% set tot = (piano.rate|length) if piano.rate else 0 %}
                            {% set paid = pagate|length %}
                            <span class="badge bg-success">{{ paid }} / {{ tot }}</span>
                        </td>
                        <td class="text-center">
                            {# mostra la prossima rata non pagata; fallback alla prima rata #}
                            {% set prossime = (piano.rate|selectattr('stato', 'ne', 'pagata')|list) if piano.rate else [] %}
                            {% if prossime and prossime|length > 0 %}
                                {{ prossime[0].data_scadenza.strftime('%d/%m/%Y') }}
                            {% else %}
                                {{ piano.data_prima_rata.strftime('%d/%m/%Y') }}
                            {% endif %}
                        </td>
                        
                        <td class="text-center">
                            <div class="btn-group btn-group-sm" role="group">
                                {# dettaglio rimosso - lasciare solo modifica/elimina #}
                                <button type="button" class="btn btn-outline-primary btn-edit-piano" title="Modifica piano" aria-label="Modifica piano"
                                        data-edit-url="{{ url_for('paypal.modifica', piano_id=piano.id) }}"
                                        data-piano-id="{{ piano.id }}"
                                        data-descrizione="{{ piano.descrizione|e }}"
                                        data-importo-totale="{{ "%.2f"|format(piano.importo_totale) }}"
                                        data-importo-rata="{{ "%.2f"|format(piano.importo_rata) }}"
                                        data-data-prima-rata="{{ piano.data_prima_rata.strftime('%Y-%m-%d') }}"
                                        data-importo-rimanente="{{ "%.2f"|format(piano.importo_rimanente or 0.0) }}"
                                        data-note="{{ (piano.note or '')|e }}"
                                >
                                    <i class="fas fa-edit"></i>
                                </button>
                                <form method="POST" action="{{ url_for('paypal.elimina', piano_id=piano.id) }}" style="display:inline">
                                    <button type="submit" class="btn btn-outline-danger" title="Elimina piano" aria-label="Elimina piano" data-action="confirm-delete" data-message="Sei sicuro di voler eliminare questo piano?">
                                        <i class="fas fa-trash" aria-hidden="true"></i>
                                        <span class="visually-hidden">Elimina piano</span>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        </div>
        {% else %}
        <div class="text-center py-3 text-muted">Nessun piano in corso</div>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-check me-2"></i>Piani completati</h5>
        <button id="toggle-completati" class="btn btn-sm d-flex" type="button" data-bs-toggle="collapse" data-bs-target="#completatiCollapse" aria-expanded="false" aria-controls="completatiCollapse" aria-label="Mostra o nascondi piani completati" style="background: transparent; color: #ffffff; border: none; box-shadow: none; width:32px; height:32px; padding:0; align-items:center; justify-content:center;">
            <span id="toggle-icon"><i class="fas fa-eye-slash" style="width:32px; height:32px; display:inline-flex; align-items:center; justify-content:center; font-size:20px; line-height:1; color:inherit;"></i></span>
        </button>
    </div>
    <div id="completatiCollapse" class="collapse">
        <div class="card-body">
        {% set piani_completati = piani|selectattr('stato', 'equalto', 'completato')|list if piani else [] %}
        {% if piani_completati %}
        <div class="table-responsive">
            <table id="table-piani-completati" class="table table-striped" data-page-size="5" tabindex="-1">
                <thead>
                    <tr>
                        <th class="text-center">Descrizione</th>
                        <th class="text-center">Importo Totale</th>
                        <th class="text-center">Importo Rata</th>
                        <th class="text-center">Prima Rata</th>
                        <th class="text-center">Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for piano in piani_completati %}
                    <tr>
                        <td class="text-start">
                            <strong>{{ piano.descrizione }}</strong>
                        </td>
                        <td class="text-center">€{{ "%.2f"|format(piano.importo_totale) }}</td>
                        <td class="text-center">€{{ "%.2f"|format(piano.importo_rata) }}</td>
                        <td class="text-center">{{ piano.data_prima_rata.strftime('%d/%m/%Y') }}</td>
                        
                        <td class="text-center">
                            <div class="btn-group btn-group-sm" role="group">
                                {# dettaglio rimosso - lasciare solo modifica/elimina #}
                                <form method="POST" action="{{ url_for('paypal.elimina', piano_id=piano.id) }}" style="display:inline">
                                    <button type="submit" class="btn btn-outline-danger" title="Elimina piano" aria-label="Elimina piano" data-action="confirm-delete" data-message="Sei sicuro di voler eliminare questo piano?">
                                        <i class="fas fa-trash" aria-hidden="true"></i>
                                        <span class="visually-hidden">Elimina piano</span>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <nav id="pagination-completati" class="mt-2 d-flex justify-content-center" aria-label="Paginazione piani completati"></nav>
        {% else %}
        <div class="text-center py-3 text-muted">Nessun piano completato</div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.progress-bar[data-progress]').forEach(function(pb){
        var v = parseFloat(pb.dataset.progress) || 0;
        pb.style.width = v + '%';
    });
});
</script>
<script>
// Client-side pagination for the "Piani completati" table
document.addEventListener('DOMContentLoaded', function(){
    var table = document.getElementById('table-piani-completati');
    if (!table) return;
    var pageSize = parseInt(table.dataset.pageSize, 10) || 5;
    var tbody = table.querySelector('tbody');
    var rows = tbody ? Array.from(tbody.querySelectorAll('tr')) : [];
    var totalRows = rows.length;
    var totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
    var paginationNav = document.getElementById('pagination-completati');

    function renderPage(page) {
        var start = (page - 1) * pageSize;
        var end = start + pageSize;
        rows.forEach(function(r, idx){
            r.style.display = (idx >= start && idx < end) ? '' : 'none';
        });
        renderControls(page);
    }

    function renderControls(activePage){
        if (!paginationNav) return;
        paginationNav.innerHTML = '';
        if (totalPages <= 1) return;
        var ul = document.createElement('ul');
        ul.className = 'pagination';
        for (var i = 1; i <= totalPages; i++) {
            var li = document.createElement('li');
            li.className = 'page-item' + (i === activePage ? ' active' : '');
            var a = document.createElement('a');
            a.className = 'page-link';
            a.href = '#';
            a.textContent = i;
            (function(page){
                a.addEventListener('click', function(e){
                    e.preventDefault();
                    renderPage(page);
                });
            })(i);
            li.appendChild(a);
            ul.appendChild(li);
        }
        paginationNav.appendChild(ul);
    }

    // initialize to first page
    renderPage(1);
});
</script>
<script>
// Toggle icon for the completed section collapse
document.addEventListener('DOMContentLoaded', function(){
    var collapseEl = document.getElementById('completatiCollapse');
    var toggleIcon = document.getElementById('toggle-icon');
    var toggleBtn = document.getElementById('toggle-completati');
    if (!collapseEl || !toggleIcon || !toggleBtn) return;

    collapseEl.addEventListener('show.bs.collapse', function(){
        toggleIcon.innerHTML = '<i class="fas fa-eye" style="width:32px; height:32px; display:inline-flex; align-items:center; justify-content:center; font-size:20px; line-height:1; color:inherit;"></i>';
        // Scroll and focus the table so it's centered on screen
        var table = document.getElementById('table-piani-completati');
        if (table) {
            setTimeout(function(){
                table.scrollIntoView({behavior: 'smooth', block: 'center'});
                try { table.focus(); } catch(e){}
            }, 200);
        }
    });
    collapseEl.addEventListener('hide.bs.collapse', function(){
        toggleIcon.innerHTML = '<i class="fas fa-eye-slash" style="width:32px; height:32px; display:inline-flex; align-items:center; justify-content:center; font-size:20px; line-height:1; color:inherit;"></i>';
    });
});
</script>
<script>
// Inline Nuovo Piano: clone template, submit via fetch and update fragments (#piani-in-corso-container, #top-cards)
document.addEventListener('DOMContentLoaded', function(){
    var btnShow = document.getElementById('btn-nuovo-piano');
    var template = document.getElementById('tmpl-nuovo-piano');
    var pianiContainer = document.getElementById('piani-in-corso-container');
    var topCards = document.getElementById('top-cards');

    function ensureCardPresent() {
        var existing = document.getElementById('card-nuovo-piano');
        if (existing) return existing;
        if (!template) return null;
        var cardArea = document.querySelector('.card.mb-4'); // insert at top of the piani card
        var clone = template.content.cloneNode(true);
        if (cardArea && cardArea.parentNode) {
            cardArea.parentNode.insertBefore(clone, cardArea);
        } else {
            document.querySelector('main .container')?.appendChild(clone);
        }
        // after insertion, store default action and title so we can restore them later
        var created = document.getElementById('card-nuovo-piano');
        try {
            var f = created.querySelector('#form-nuovo-piano');
            if (f) created.dataset.defaultAction = f.action || '';
            var hdr = created.querySelector('.card-header h5');
            if (hdr) created.dataset.defaultTitle = hdr.innerHTML || 'Nuovo Piano';
        } catch(e){}
        return created;
    }

    if (btnShow) {
        btnShow.addEventListener('click', function(){
            var card = ensureCardPresent();
            if (!card) return;
            try {
                var dataInput = card.querySelector('#data_prima_rata');
                if (dataInput && !dataInput.value) dataInput.value = new Date().toISOString().split('T')[0];
                var desc = card.querySelector('#descrizione');
                if (desc && !desc.value) desc.value = '';
                // ensure all fields enabled when opening as "new" and restore title
                var form = card.querySelector('#form-nuovo-piano');
                if (form) {
                    form.action = card.dataset.defaultAction || form.action;
                    ['#importo_totale', '#data_prima_rata'].forEach(function(sel){ var el = form.querySelector(sel); if (el){ el.removeAttribute('readonly'); el.removeAttribute('disabled'); } });
                    var submitBtn = form.querySelector('#btn-salva-piano'); if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Salva';
                    var hdr = card.querySelector('.card-header h5'); if (hdr) hdr.innerHTML = (card.dataset.defaultTitle || '<i class="fas fa-plus me-2"></i>Nuovo Piano');
                    delete card.dataset.editing;
                }
            } catch(e){}
            try { card.querySelector('input,select,textarea').focus(); } catch(e){}
            setTimeout(function(){ card.scrollIntoView({behavior: 'smooth', block: 'center'}); }, 100);

            var btnClose = document.getElementById('btn-close-nuovo-piano');
            if (btnClose) btnClose.addEventListener('click', function(){ var c = document.getElementById('card-nuovo-piano'); if (c) c.remove(); });
        });
    }

    // Open the inline form populated for editing when clicking an edit button
    document.addEventListener('click', function(e){
        var btn = e.target.closest && e.target.closest('.btn-edit-piano');
        if (!btn) return;
        e.preventDefault();
        var card = ensureCardPresent();
        if (!card) return;
        var form = card.querySelector('#form-nuovo-piano');
        if (!form) return;
        // populate values
        try {
            var desc = form.querySelector('#descrizione'); if (desc) { desc.value = btn.dataset.descrizione || ''; desc.removeAttribute('disabled'); desc.removeAttribute('readonly'); }
            var note = form.querySelector('#note'); if (note) note.value = btn.dataset.note || '';
            var importo = form.querySelector('#importo_totale'); if (importo) { importo.value = btn.dataset.importoTotale || ''; importo.setAttribute('readonly', 'readonly'); importo.setAttribute('aria-readonly', 'true'); }
            var rata = form.querySelector('#importo_rata'); if (rata) { /* if present in future */ }
            var dataPrima = form.querySelector('#data_prima_rata'); if (dataPrima) { dataPrima.value = btn.dataset.dataPrimaRata || ''; dataPrima.setAttribute('readonly', 'readonly'); dataPrima.setAttribute('aria-readonly', 'true'); }
            // set action to edit URL
            form.action = btn.dataset.editUrl || form.action;
            // change submit button text
            var submitBtn = form.querySelector('#btn-salva-piano');
            if (submitBtn) { submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Salva Modifiche'; submitBtn.disabled = false; }
            // change header to indicate edit mode
            var hdr = card.querySelector('.card-header h5'); if (hdr) hdr.innerHTML = '<i class="fas fa-edit me-2"></i>Modifica Piano';
            card.dataset.editing = '1';
        } catch(err){}
        try { form.querySelector('#descrizione').focus(); } catch(e){}
        setTimeout(function(){ card.scrollIntoView({behavior: 'smooth', block: 'center'}); }, 100);
    });

    // Delegated close handler for the inline nuovo/modifica piano card
    // This uses event delegation so the close button works whether the card
    // was opened via 'Nuovo Piano' or via a modifica button (edit mode).
    document.addEventListener('click', function(e){
        var close = e.target.closest && e.target.closest('#btn-close-nuovo-piano');
        if (close) {
            var c = document.getElementById('card-nuovo-piano');
            if (c) c.remove();
        }
    });

    // Delegated submit handler for the new piano form (works for both create and edit)
    document.addEventListener('submit', function(e){
        if (!e.target || e.target.id !== 'form-nuovo-piano') return;
        e.preventDefault();
    var theForm = e.target;
    var submitBtn = theForm.querySelector('#btn-salva-piano') || theForm.querySelector('button[type=submit]');
        var origHtml = null;
        if (submitBtn) { submitBtn.disabled = true; origHtml = submitBtn.innerHTML; submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salva'; }

        var url = theForm.action;
        var formData = new FormData(theForm);
        fetch(url, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        }).then(function(resp){
            if (resp.ok) {
                var currentCard = document.getElementById('card-nuovo-piano'); if (currentCard) currentCard.remove();
                fetch(window.location.href, {credentials: 'same-origin'})
                    .then(function(r){ return r.text(); })
                    .then(function(html){
                        try {
                            var parser = new DOMParser();
                            var doc = parser.parseFromString(html, 'text/html');
                            var newPiani = doc.getElementById('piani-in-corso-container');
                            var newTop = doc.getElementById('top-cards');
                            if (newPiani && pianiContainer) pianiContainer.innerHTML = newPiani.innerHTML;
                            if (newTop && topCards) topCards.innerHTML = newTop.innerHTML;
                        } catch (err) { setTimeout(function(){ location.reload(); }, 250); }
                    }).catch(function(){ setTimeout(function(){ location.reload(); }, 250); });
            } else {
                resp.text().then(function(txt){ alert('Errore nel salvataggio: ' + txt); if (submitBtn) { submitBtn.disabled = false; submitBtn.innerHTML = origHtml; } });
            }
        }).catch(function(err){ alert('Errore di rete: ' + err); if (submitBtn) { submitBtn.disabled = false; submitBtn.innerHTML = origHtml; } });
    });
});
</script>
{% endblock %}

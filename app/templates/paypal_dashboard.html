{% extends "base.html" %}

{% block title %}PayPal - Gestione Piani{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="fab fa-paypal me-2"></i>Gestione Piani PayPal</h2>
        <p class="text-muted">Monitora e gestisci i tuoi piani di pagamento PayPal a 3 rate</p>
    </div>
    <div class="col-auto">
        <a href="{{ url_for('paypal.nuovo') }}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>Nuovo Piano
        </a>
    </div>
</div>

<!-- Statistiche -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Piani Totali</h5>
                        <h3>{{ totale_piani }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-list fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Piani Attivi</h5>
                        <h3>{{ piani_attivi }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-play fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Importo Rimanente</h5>
                        <h3>€{{ "%.2f"|format(importo_rimanente_totale) }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-euro-sign fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Rate Non Pagate</h5>
                        <h3>{{ rate_non_pagate_totali }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rate in scadenza -->
{# Rate in scadenza rimossi: visualizziamo la prossima rata direttamente nella tabella dei piani in corso #}

<!-- Lista piani: separa In corso e Completati -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Piani in corso</h5>
    </div>
    <div class="card-body">
        {% set piani_in_corso = piani|rejectattr('stato', 'equalto', 'completato')|list if piani else [] %}
        {% if piani_in_corso %}
        <div class="table-responsive">
            <table id="table-piani-in-corso" class="table table-striped">
                <thead>
                    <tr>
                        <th class="text-center">Descrizione</th>
                        <th class="text-center">Importo Totale</th>
                        <th class="text-center">Importo Rata</th>
                        <th class="text-center">Prossima Scadenza</th>
                        
                        <th class="text-center">Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for piano in piani_in_corso %}
                    <tr>
                        <td class="text-start">
                            <a href="{{ url_for('paypal.dettaglio', piano_id=piano.id) }}" class="text-decoration-none">
                                <strong>{{ piano.descrizione }}</strong>
                            </a>
                            {% if piano.note %}
                            <br><small class="text-muted">{{ piano.note[:50] }}{% if piano.note|length > 50 %}...{% endif %}</small>
                            {% endif %}
                        </td>
                        <td class="text-center">€{{ "%.2f"|format(piano.importo_totale) }}</td>
                        <td class="text-center">€{{ "%.2f"|format(piano.importo_rata) }}</td>
                        <td class="text-center">
                            {# mostra la prossima rata non pagata; fallback alla prima rata #}
                            {% set prossime = (piano.rate|selectattr('stato', 'ne', 'pagata')|list) if piano.rate else [] %}
                            {% if prossime and prossime|length > 0 %}
                                {{ prossime[0].data_scadenza.strftime('%d/%m/%Y') }}
                            {% else %}
                                {{ piano.data_prima_rata.strftime('%d/%m/%Y') }}
                            {% endif %}
                        </td>
                        
                        <td class="text-center">
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('paypal.dettaglio', piano_id=piano.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{{ url_for('paypal.modifica', piano_id=piano.id) }}" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <form method="POST" action="{{ url_for('paypal.elimina', piano_id=piano.id) }}" style="display:inline">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" data-action="confirm-delete" data-message="Sei sicuro di voler eliminare questo piano?">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-3 text-muted">Nessun piano in corso</div>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-check me-2"></i>Piani completati</h5>
        <button id="toggle-completati" class="btn btn-sm d-flex" type="button" data-bs-toggle="collapse" data-bs-target="#completatiCollapse" aria-expanded="false" aria-controls="completatiCollapse" aria-label="Mostra o nascondi piani completati" style="background: transparent; color: #ffffff; border: none; box-shadow: none; width:32px; height:32px; padding:0; align-items:center; justify-content:center;">
            <span id="toggle-icon"><i class="fas fa-eye-slash" style="width:32px; height:32px; display:inline-flex; align-items:center; justify-content:center; font-size:20px; line-height:1; color:inherit;"></i></span>
        </button>
    </div>
    <div id="completatiCollapse" class="collapse">
        <div class="card-body">
        {% set piani_completati = piani|selectattr('stato', 'equalto', 'completato')|list if piani else [] %}
        {% if piani_completati %}
        <div class="table-responsive">
            <table id="table-piani-completati" class="table table-striped" data-page-size="5" tabindex="-1">
                <thead>
                    <tr>
                        <th class="text-center">Descrizione</th>
                        <th class="text-center">Importo Totale</th>
                        <th class="text-center">Importo Rata</th>
                        <th class="text-center">Prima Rata</th>
                        <th class="text-center">Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    {% for piano in piani_completati %}
                    <tr>
                        <td class="text-start">
                            <a href="{{ url_for('paypal.dettaglio', piano_id=piano.id) }}" class="text-decoration-none">
                                <strong>{{ piano.descrizione }}</strong>
                            </a>
                        </td>
                        <td class="text-center">€{{ "%.2f"|format(piano.importo_totale) }}</td>
                        <td class="text-center">€{{ "%.2f"|format(piano.importo_rata) }}</td>
                        <td class="text-center">{{ piano.data_prima_rata.strftime('%d/%m/%Y') }}</td>
                        
                        <td class="text-center">
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('paypal.dettaglio', piano_id=piano.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <form method="POST" action="{{ url_for('paypal.elimina', piano_id=piano.id) }}" style="display:inline">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" data-action="confirm-delete" data-message="Sei sicuro di voler eliminare questo piano?">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <nav id="pagination-completati" class="mt-2 d-flex justify-content-center" aria-label="Paginazione piani completati"></nav>
        {% else %}
        <div class="text-center py-3 text-muted">Nessun piano completato</div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.progress-bar[data-progress]').forEach(function(pb){
        var v = parseFloat(pb.dataset.progress) || 0;
        pb.style.width = v + '%';
    });
});
</script>
<script>
// Client-side pagination for the "Piani completati" table
document.addEventListener('DOMContentLoaded', function(){
    var table = document.getElementById('table-piani-completati');
    if (!table) return;
    var pageSize = parseInt(table.dataset.pageSize, 10) || 5;
    var tbody = table.querySelector('tbody');
    var rows = tbody ? Array.from(tbody.querySelectorAll('tr')) : [];
    var totalRows = rows.length;
    var totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
    var paginationNav = document.getElementById('pagination-completati');

    function renderPage(page) {
        var start = (page - 1) * pageSize;
        var end = start + pageSize;
        rows.forEach(function(r, idx){
            r.style.display = (idx >= start && idx < end) ? '' : 'none';
        });
        renderControls(page);
    }

    function renderControls(activePage){
        if (!paginationNav) return;
        paginationNav.innerHTML = '';
        if (totalPages <= 1) return;
        var ul = document.createElement('ul');
        ul.className = 'pagination';
        for (var i = 1; i <= totalPages; i++) {
            var li = document.createElement('li');
            li.className = 'page-item' + (i === activePage ? ' active' : '');
            var a = document.createElement('a');
            a.className = 'page-link';
            a.href = '#';
            a.textContent = i;
            (function(page){
                a.addEventListener('click', function(e){
                    e.preventDefault();
                    renderPage(page);
                });
            })(i);
            li.appendChild(a);
            ul.appendChild(li);
        }
        paginationNav.appendChild(ul);
    }

    // initialize to first page
    renderPage(1);
});
</script>
<script>
// Toggle icon for the completed section collapse
document.addEventListener('DOMContentLoaded', function(){
    var collapseEl = document.getElementById('completatiCollapse');
    var toggleIcon = document.getElementById('toggle-icon');
    var toggleBtn = document.getElementById('toggle-completati');
    if (!collapseEl || !toggleIcon || !toggleBtn) return;

    collapseEl.addEventListener('show.bs.collapse', function(){
        toggleIcon.innerHTML = '<i class="fas fa-eye" style="width:32px; height:32px; display:inline-flex; align-items:center; justify-content:center; font-size:20px; line-height:1; color:inherit;"></i>';
        // Scroll and focus the table so it's centered on screen
        var table = document.getElementById('table-piani-completati');
        if (table) {
            setTimeout(function(){
                table.scrollIntoView({behavior: 'smooth', block: 'center'});
                try { table.focus(); } catch(e){}
            }, 200);
        }
    });
    collapseEl.addEventListener('hide.bs.collapse', function(){
        toggleIcon.innerHTML = '<i class="fas fa-eye-slash" style="width:32px; height:32px; display:inline-flex; align-items:center; justify-content:center; font-size:20px; line-height:1; color:inherit;"></i>';
    });
});
</script>
{% endblock %}

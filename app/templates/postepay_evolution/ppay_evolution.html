{% extends "base.html" %}

{% block title %}PostePay Evolution{% endblock %}

{% block content %}

<!-- Top summary cards (styled like last deploy) -->
<div id="top-cards" class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Saldo Attuale</h5>
                        <h3 class="mb-0">{{ (postepay.saldo_attuale if postepay else 0) | format_currency }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-wallet fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Abbonamenti</h5>
                        <h3 class="mb-0">{{ abbonamenti|length }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-list fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Spesa Mensile</h5>
                        <h3 class="mb-0">{{ (spesa_mensile) | format_currency }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-euro-sign fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Movimenti Recenti</h5>
                        <h3 class="mb-0">{{ movimenti|length }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-history fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="row align-items-start">
        <!-- Abbonamenti (left column) -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-sync-alt me-2"></i>Abbonamenti</h5>
                    <div>
                        <button id="btn-nuovo-abbonamento" class="btn btn-primary btn-sm" type="button" aria-controls="tmpl-nuovo-abbonamento">
                            <i class="fas fa-plus me-1"></i>Nuovo Abbonamento
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if abbonamenti %}
                    <div id="abbonamenti-table-container">
                        <div class="table-responsive">
                            <table id="table-abbonamenti" class="table table-striped table-sm det-mese-table" data-page-size="3" tabindex="-1">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Importo (€)</th>
                                        <th>Giorno</th>
                                        <th>Prossimo</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for abbonamento in abbonamenti %}
                                    <tr class="{% if not abbonamento.attivo %}table-secondary{% endif %}">
                                        <td class="text-start align-middle">
                                            <strong>{{ abbonamento.nome }}</strong>
                                            {% if abbonamento.descrizione %}
                                            <br><small class="text-muted">{{ abbonamento.descrizione }}</small>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">{{ (abbonamento.importo | default(0) | abs) | format_currency('{:.2f}') }}</td>
                                        <td class="text-center">{{ abbonamento.giorno_addebito }}</td>
                                        <td class="text-center">
                                            {% if abbonamento.attivo %}
                                            {{ abbonamento.prossimo_addebito.strftime('%d/%m/%Y') }}
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center align-middle">
                                            <div class="d-inline-flex align-items-center">
                                                <button class="btn btn-outline-primary btn-sm me-1 btn-edit-abbonamento" 
                                                        data-abbonamento-id="{{ abbonamento.id }}"
                                                        data-nome="{{ abbonamento.nome|e }}"
                                                        data-descrizione="{{ (abbonamento.descrizione or '')|e }}"
                                                        data-importo="{{ '%.2f'|format(abbonamento.importo) }}"
                                                        data-giorno-addebito="{{ abbonamento.giorno_addebito }}"
                                                >
                                                    <i class="fas fa-edit" aria-hidden="true"></i>
                                                </button>
                                                <form method="POST" action="{{ url_for('ppay.elimina_abbonamento', abbonamento_id=abbonamento.id) }}" class="d-inline" data-action="confirm-delete" data-message="Sei sicuro di voler eliminare questo abbonamento?">
                                                    <button type="submit" class="btn btn-outline-danger btn-sm" title="Elimina abbonamento" aria-label="Elimina abbonamento">
                                                        <i class="fas fa-trash" aria-hidden="true"></i>
                                                        <span class="visually-hidden">Elimina abbonamento</span>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <nav id="pagination-abbonamenti" class="mt-2 d-flex justify-content-center" aria-label="Paginazione abbonamenti"></nav>
                    </div>
                    {% else %}
                    <p class="text-muted">Nessun abbonamento configurato.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Prossimi Addebiti (right column) -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-clock me-2"></i>Prossimi Addebiti</h5>
                </div>
                <div id="prossimi-addebiti-container" class="card-body">
                    {% if prossimi_addebiti %}
                        {% for addebito in prossimi_addebiti[:5] %}
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded {% if not addebito.saldo_sufficiente %}bg-danger bg-gradient text-white fw-bold border-danger{% else %}bg-success bg-gradient text-white fw-bold border-success{% endif %}">
                            <div>
                                <strong>{{ addebito.abbonamento.nome }}</strong><br>
                                <small class="text-white">{{ addebito.data.strftime('%d/%m/%Y') }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge {% if not addebito.saldo_sufficiente %}bg-danger{% else %}bg-success{% endif %} text-white">{{ addebito.giorni }} giorni</span><br>
                                <small class="text-white">{{ (addebito.abbonamento.importo) | format_currency }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">Nessun addebito in programma.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
<!-- Movimenti recenti -->
<div class="row mt-4">
    <div class="col-12">
        <!-- Container for inline forms (new movement/abbonamento) -->
        <div id="inline-forms-container" class="mb-2"></div>
        <div id="inline-movimenti-container" class="mb-2"></div>
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Movimenti</h5>
                <div class="d-flex align-items-center">
                    <button id="btn-nuovo-movimento" class="btn btn-primary btn-sm me-2" type="button" aria-controls="tmpl-nuovo-movimento">
                        <i class="fas fa-plus me-1"></i>Nuovo Movimento
                    </button>
                </div>
            </div>
            <div class="card-body">
                    {% if movimenti %}
                    <div id="movimenti-table-container">
                    <div class="table-responsive">
                        <table id="table-movimenti-recenti" class="table table-striped table-sm det-mese-table" data-page-size="5" tabindex="-1">
                        <thead>
                                <tr>
                                    <th>Descrizione</th>
                                    <th>Data</th>
                                    <th>Categoria</th>
                                    <th>Tipo</th>
                                    <th>Importo (€)</th>
                                    <th>Azioni</th>
                                </tr>
                        </thead>
                        <tbody>
                            {% for movimento in movimenti %}
                                <tr>
                                <td class="text-start align-middle">{{ movimento.descrizione }}</td>
                                <td class="text-center align-middle">{{ movimento.data.strftime('%d/%m/%Y') }}</td>
                                <td class="text-center align-middle">
                                    {%- set tipo_norm = (movimento.tipo or '') | lower -%}
                                    <span class="badge {% if tipo_norm == 'ricarica' %}bg-success{% elif tipo_norm == 'pagamento' %}bg-primary{% elif tipo_norm == 'abbonamento' %}bg-info{% else %}bg-secondary{% endif %}">
                                        {{ movimento.tipo|capitalize }}
                                    </span>
                                </td>
                                <td class="text-center align-middle">
                                    {% if movimento.tipo_movimento == 'entrata' %}
                                        <span class="text-success"><i class="fas fa-arrow-up"></i> Entrata</span>
                                    {% else %}
                                        <span class="text-danger"><i class="fas fa-arrow-down"></i> Uscita</span>
                                    {% endif %}
                                </td>
                                <td class="text-center {% if movimento.tipo_movimento == 'entrata' %}text-success{% else %}text-danger{% endif %} align-middle">
                                    {{ (movimento.importo | default(0) | abs) | format_currency('{:.2f}') }}
                                </td>
                                <td class="text-center align-middle">
                                    <button type="button" class="btn btn-outline-primary btn-sm btn-edit-movimento" 
                                            data-movimento-id="{{ movimento.id }}"
                                            data-movimento-descrizione="{{ movimento.descrizione|e }}"
                                            data-movimento-data="{{ movimento.data.strftime('%Y-%m-%d') }}"
                                            data-movimento-tipo="{{ movimento.tipo_movimento }}"
                                            data-movimento-importo="{{ '%.2f'|format(movimento.importo) }}"
                                            data-movimento-tipo_movimento="{{ movimento.tipo }}"
                                    ><i class="fas fa-edit"></i></button>
                                    <form method="POST" action="{{ url_for('ppay.elimina_movimento', movimento_id=movimento.id) }}" class="form-delete-movimento d-inline">
                                        <button type="submit" class="btn btn-outline-danger btn-sm" title="Elimina movimento" aria-label="Elimina movimento">
                                            <i class="fas fa-trash" aria-hidden="true"></i>
                                            <span class="visually-hidden">Elimina movimento</span>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        </table>
                    </div>
                    </div>
                    <nav id="pagination-movimenti" class="mt-2 d-flex justify-content-center" aria-label="Paginazione movimenti recenti"></nav>
                    {% else %}
                    <p class="text-muted">Nessun movimento registrato.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Inline templates used by JS to insert forms inline -->
<template id="tmpl-nuovo-movimento">
    <div id="card-nuovo-movimento" class="card mb-3">
        <div class="card-header d-flex align-items-center">
            <h5 class="mb-0"><i class="fas fa-plus me-2"></i>Nuovo Movimento</h5>
            <button type="button" class="btn btn-link p-0 ms-auto" aria-label="Chiudi"><i class="fas fa-times text-white fs-5"></i></button>
        </div>
        <div class="card-body">
            <form class="form-nuovo-movimento" method="POST" action="{{ url_for('ppay.aggiungi_movimento') }}">
                <div class="row g-2 align-items-center">
                    <div class="col-auto min-w-120"><input type="date" class="form-control form-control-sm" name="data" required></div>
                    <div class="col"><input type="text" class="form-control form-control-sm" name="descrizione" placeholder="Descrizione" required></div>
                    <div class="col-auto min-w-110"><input type="number" step="0.01" class="form-control form-control-sm text-end" name="importo" required></div>
                    <div class="col-auto min-w-120">
                        <select class="form-control form-control-sm" name="tipo" required>
                            <option value="entrata">Entrata (+)</option>
                            <option value="uscita">Uscita (-)</option>
                        </select>
                    </div>
                    <div class="col-auto min-w-140">
                        <select class="form-control form-control-sm" name="tipo_movimento" id="select-tipo-movimento">
                            <!-- Options populated dynamically by JS based on tipo (entrata/uscita) -->
                        </select>
                    </div>
                    <div class="col-auto"><button type="submit" id="btn-salva-movimento" class="btn btn-primary btn-sm">Aggiungi</button></div>
                </div>
            </form>
        </div>
    </div>
</template>

<template id="tmpl-nuovo-abbonamento">
    <div id="card-nuovo-abbonamento" class="card mb-3">
        <div class="card-header d-flex align-items-center">
            <h5 class="mb-0"><i class="fas fa-plus me-2"></i>Nuovo Abbonamento</h5>
            <button type="button" class="btn btn-link p-0 ms-auto" aria-label="Chiudi"><i class="fas fa-times text-white fs-5"></i></button>
        </div>
        <div class="card-body">
            <form class="form-nuovo-abbonamento" method="POST" action="{{ url_for('ppay.aggiungi_abbonamento') }}">
                <div class="row g-2 align-items-center">
                    <div class="col-auto min-w-140"><input type="text" class="form-control form-control-sm" name="nome" placeholder="Nome" required></div>
                    <div class="col"><input type="text" class="form-control form-control-sm" name="descrizione" placeholder="Descrizione"></div>
                    <div class="col-auto min-w-110"><input type="number" step="0.01" class="form-control form-control-sm text-end" name="importo" required></div>
                    <div class="col-auto min-w-110"><input type="number" min="1" max="31" class="form-control form-control-sm" name="giorno_addebito" required></div>
                    <div class="col-auto"><button type="submit" id="btn-salva-abbonamento" class="btn btn-primary btn-sm">Salva</button></div>
                </div>
            </form>
        </div>
    </div>
</template>

<div class="modal fade" id="modalModificaSaldo" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifica Saldo PostePay Evolution</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('ppay.modifica_saldo') }}">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Saldo attuale:</strong> {{ (postepay.saldo_attuale if postepay else 0) | format_currency }}
                    </div>
                    <div class="mb-3">
                        <label for="nuovo_saldo" class="form-label">Nuovo Saldo (€)</label>
                        <input type="number" step="0.01" class="form-control" id="nuovo_saldo" name="nuovo_saldo" 
                               value="{{ postepay.saldo_attuale if postepay else 0 }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="motivo" class="form-label">Motivo della modifica</label>
                        <input type="text" class="form-control" id="motivo" name="motivo" 
                               placeholder="es. Correzione saldo, Ricarica manuale..." required>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <small>Verrà creato automaticamente un movimento per tracciare questa modifica.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary">Aggiorna Saldo</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Nuovo Abbonamento -->
<div class="modal fade" id="modalNuovoAbbonamento" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nuovo Abbonamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('ppay.aggiungi_abbonamento') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nome" class="visually-hidden">Nome</label>
                        <input type="text" class="form-control" id="nome" name="nome" placeholder="Nome" required aria-label="Nome">
                    </div>
                    <div class="mb-3">
                        <label for="descrizione" class="visually-hidden">Descrizione</label>
                        <input type="text" class="form-control" id="descrizione" name="descrizione" placeholder="Descrizione" aria-label="Descrizione">
                    </div>
                    <div class="mb-3">
                        <label for="importo" class="visually-hidden">Importo (€)</label>
                        <input type="number" step="0.01" class="form-control" id="importo" name="importo" placeholder="0.00" required aria-label="Importo">
                    </div>
                    <div class="mb-3">
                        <label for="giorno_addebito" class="visually-hidden">Giorno Addebito</label>
                        <input type="number" min="1" max="31" class="form-control" id="giorno_addebito" name="giorno_addebito" placeholder="Giorno" required aria-label="Giorno addebito">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                    <button type="submit" class="btn btn-primary">Salva</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Modifica Abbonamento -->
<div class="modal fade" id="modalModificaAbbonamento" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifica Abbonamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="formModificaAbbonamento">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="mod_nome" class="visually-hidden">Nome</label>
                        <input type="text" class="form-control" id="mod_nome" name="nome" placeholder="Nome" required aria-label="Nome">
                    </div>
                    <div class="mb-3">
                        <label for="mod_descrizione" class="visually-hidden">Descrizione</label>
                        <input type="text" class="form-control" id="mod_descrizione" name="descrizione" placeholder="Descrizione" aria-label="Descrizione">
                    </div>
                    <div class="mb-3">
                        <label for="mod_importo" class="visually-hidden">Importo (€)</label>
                        <input type="number" step="0.01" class="form-control" id="mod_importo" name="importo" placeholder="0.00" required aria-label="Importo">
                    </div>
                    <div class="mb-3">
                        <label for="mod_giorno_addebito" class="visually-hidden">Giorno Addebito</label>
                        <input type="number" min="1" max="31" class="form-control" id="mod_giorno_addebito" name="giorno_addebito" placeholder="Giorno" required aria-label="Giorno addebito">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                    <button type="submit" class="btn btn-primary">Salva Modifiche</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Form nascosto per reset -->
<form id="resetForm" method="POST" action="{{ url_for('ppay.reset') }}" class="d-none"></form>

{% block scripts %}
<script type="application/json" id="abbonamenti-data">
    {{ abbonamenti_json | tojson }}
</script>
<script>
var _abboElem = document.getElementById('abbonamenti-data');
var abbonamentiData = _abboElem ? JSON.parse(_abboElem.textContent || '[]') : [];
function modificaAbbonamento(id) {
    var abbo = abbonamentiData.find(a => a.id === id);
    document.getElementById('formModificaAbbonamento').action = '/ppay_evolution/modifica_abbonamento_postepay/' + id;
    document.getElementById('mod_nome').value = abbo.nome;
    document.getElementById('mod_descrizione').value = abbo.descrizione;
    document.getElementById('mod_importo').value = abbo.importo;
    document.getElementById('mod_giorno_addebito').value = abbo.giorno_addebito;
    // mostra il modal
    new bootstrap.Modal(document.getElementById('modalModificaAbbonamento')).show();
}

// Imposta data odierna nei form
document.addEventListener('DOMContentLoaded', function() {
    const oggi = formatISO(new Date());
    document.getElementById('mov_data').value = oggi;
});
</script>
<script>
// Client-side pagination for Movimenti Recenti
window.initMovimentiPagination = function(preferredPage) {
    var table = document.getElementById('table-movimenti-recenti');
    if (!table) return;
    var pageSize = parseInt(table.dataset.pageSize, 10) || 3;
    var tbody = table.querySelector('tbody');
    var rows = tbody ? Array.from(tbody.querySelectorAll('tr')) : [];
    var totalRows = rows.length;
    var totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
    var paginationNav = document.getElementById('pagination-movimenti');
    var current = parseInt(table.dataset.currentPage, 10) || 1;
    if (preferredPage && Number.isInteger(preferredPage)) current = Math.min(Math.max(1, preferredPage), totalPages);

    function renderPage(page) {
        var start = (page - 1) * pageSize;
        var end = start + pageSize;
        rows.forEach(function(r, idx){
            r.classList.toggle('d-none', !(idx >= start && idx < end));
        });
        table.dataset.currentPage = page;
        renderControls(page);
    }

    function renderControls(activePage){
        if (!paginationNav) return;
        paginationNav.innerHTML = '';
        if (totalPages <= 1) return;
        var ul = document.createElement('ul');
        ul.className = 'pagination';
        for (var i = 1; i <= totalPages; i++) {
            var li = document.createElement('li');
            li.className = 'page-item' + (i === activePage ? ' active' : '');
            var a = document.createElement('a');
            a.className = 'page-link';
            a.href = '#';
            a.textContent = i;
            (function(page){
                a.addEventListener('click', function(e){
                    e.preventDefault();
                    renderPage(page);
                });
            })(i);
            li.appendChild(a);
            ul.appendChild(li);
        }
        paginationNav.appendChild(ul);
    }

    // initialize to preferred or stored page
    renderPage(current);
};
document.addEventListener('DOMContentLoaded', function(){ window.initMovimentiPagination(); });
</script>
<script>
// Client-side pagination for Abbonamenti (5 per page)
window.initAbbonamentiPagination = function(preferredPage) {
    var table = document.getElementById('table-abbonamenti');
    if (!table) return;
    var pageSize = parseInt(table.dataset.pageSize, 10) || 5;
    var tbody = table.querySelector('tbody');
    var rows = tbody ? Array.from(tbody.querySelectorAll('tr')) : [];
    var totalRows = rows.length;
    var totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
    var paginationNav = document.getElementById('pagination-abbonamenti');
    var current = parseInt(table.dataset.currentPage, 10) || 1;
    if (preferredPage && Number.isInteger(preferredPage)) current = Math.min(Math.max(1, preferredPage), totalPages);

    function renderPage(page) {
        var start = (page - 1) * pageSize;
        var end = start + pageSize;
        rows.forEach(function(r, idx){
            r.classList.toggle('d-none', !(idx >= start && idx < end));
        });
        table.dataset.currentPage = page;
        renderControls(page);
    }

    function renderControls(activePage){
        if (!paginationNav) return;
        paginationNav.innerHTML = '';
        if (totalPages <= 1) return;
        var ul = document.createElement('ul');
        ul.className = 'pagination';
        for (var i = 1; i <= totalPages; i++) {
            var li = document.createElement('li');
            li.className = 'page-item' + (i === activePage ? ' active' : '');
            var a = document.createElement('a');
            a.className = 'page-link';
            a.href = '#';
            a.textContent = i;
            (function(page){
                a.addEventListener('click', function(e){
                    e.preventDefault();
                    renderPage(page);
                });
            })(i);
            li.appendChild(a);
            ul.appendChild(li);
        }
        paginationNav.appendChild(ul);
    }

    // initialize to preferred or stored page
    renderPage(current);
};
document.addEventListener('DOMContentLoaded', function(){ window.initAbbonamentiPagination(); });
</script>
<script>
</script>
<script>
// Inline Nuovo Movimento handling: insert template, submit via fetch, and partial replace
document.addEventListener('DOMContentLoaded', function(){
    const btnNuovoMov = document.getElementById('btn-nuovo-movimento');
    const btnNuovoAbb = document.getElementById('btn-nuovo-abbonamento');
    const inlineContainer = document.getElementById('inline-forms-container');
    const inlineMovContainer = document.getElementById('inline-movimenti-container');
    if (!inlineContainer) return;

    function hasInlineCard() {
        return !!document.querySelector('.inline-inserted');
    }

    function insertTemplateAtTop(tmplId, formClass) {
        // If there's already an inline card inserted, either focus it (if same type)
        // or remove it so we can insert the requested form type.
        const existingCard = document.querySelector('.inline-inserted');
        if (existingCard) {
            const existingForm = existingCard.querySelector('form');
            if (existingForm && existingForm.classList.contains(formClass)) {
                // same form type already open -> focus first input and skip insertion
                const first = existingCard.querySelector('input, select, textarea');
                if (first) first.focus();
                return;
            }
            // different form type -> remove existing so we can open the new one
            existingCard.remove();
        }
        const tmpl = document.getElementById(tmplId);
        if (!tmpl) return;
        const clone = tmpl.content.cloneNode(true);

        // choose target container: movimenti go above movimenti table if container present
        const target = (formClass === 'form-nuovo-movimento' && inlineMovContainer) ? inlineMovContainer : inlineContainer;
        // insert at top of the chosen container
        target.insertBefore(clone, target.firstChild);

        // find the inserted card and form inside the target
        const insertedCard = target.querySelector('.card');
        if (insertedCard) {
            // remove ids inside inserted card to avoid duplicates
            insertedCard.querySelectorAll && insertedCard.querySelectorAll('[id]').forEach(el=>el.removeAttribute('id'));
            insertedCard.classList.add('inline-inserted');
        }

        // mark the form with a class so delegation picks it up
        const insertedForm = target.querySelector('form');
            if (insertedForm) {
            insertedForm.classList.add(formClass);
            // default date for movimento only
            if (formClass === 'form-nuovo-movimento') {
                const dateInput = insertedForm.querySelector('input[type="date"]');
                const today = formatISO(new Date());
                if (dateInput && !dateInput.value) dateInput.value = today;
                
                // Initialize tipo_movimento dropdown dynamically
                const tipoSelect = insertedForm.querySelector('[name="tipo"]');
                const tipoMovSelect = insertedForm.querySelector('[name="tipo_movimento"]');
                
                function populateTipoMovimento(tipoValue, preserveValue) {
                    if (!tipoMovSelect) return;
                    const optionsEntrata = ['Ricarica', 'Pagamento', 'P2P', 'Bonifico'];
                    const optionsUscita = ['Pagamento', 'P2P', 'Bonifico'];
                    const opts = (tipoValue === 'uscita') ? optionsUscita : optionsEntrata;
                    
                    tipoMovSelect.innerHTML = '';
                    opts.forEach(function(o){
                        const opt = document.createElement('option');
                        opt.value = o;
                        opt.textContent = o;
                        tipoMovSelect.appendChild(opt);
                    });
                    
                    // If editing and preserveValue provided but not in list, add it (e.g., Abbonamento)
                    if (preserveValue && opts.indexOf(preserveValue) === -1) {
                        const extra = document.createElement('option');
                        extra.value = preserveValue;
                        extra.textContent = preserveValue;
                        extra.selected = true;
                        tipoMovSelect.insertBefore(extra, tipoMovSelect.firstChild);
                    } else if (preserveValue) {
                        tipoMovSelect.value = preserveValue;
                    }
                }
                
                // Initial population based on default tipo value
                if (tipoSelect && tipoMovSelect) {
                    populateTipoMovimento(tipoSelect.value || 'entrata', null);
                    
                    // Wire change event to repopulate when tipo changes
                    tipoSelect.addEventListener('change', function(){
                        populateTipoMovimento(tipoSelect.value, null);
                    });
                }
            }
            const focusEl = insertedForm.querySelector('input, select, textarea');
            if (focusEl) focusEl.focus();

            // wire close button (use delegation fallback below as well)
            const closeBtn = insertedForm.closest('.card')?.querySelector('button[aria-label="Chiudi"]');
            if (closeBtn) closeBtn.addEventListener('click', function(){
                const card = closeBtn.closest('.card'); if (card) card.remove();
            });
            // no default initialization for giorno_addebito; user will enter value
        }
    }

    if (btnNuovoMov) btnNuovoMov.addEventListener('click', function(){ insertTemplateAtTop('tmpl-nuovo-movimento', 'form-nuovo-movimento'); });
    if (btnNuovoAbb) btnNuovoAbb.addEventListener('click', function(){ insertTemplateAtTop('tmpl-nuovo-abbonamento', 'form-nuovo-abbonamento'); });

    // Open inline form for editing Abbonamento or Movimento
    document.addEventListener('click', function(e){
        // Abbonamento edit
        var btnAbb = e.target.closest && e.target.closest('.btn-edit-abbonamento');
        if (btnAbb) {
            e.preventDefault();
            insertTemplateAtTop('tmpl-nuovo-abbonamento', 'form-nuovo-abbonamento');
            // populate the inserted form
            setTimeout(function(){
                var form = document.querySelector('.form-nuovo-abbonamento');
                if (!form) return;
                // fill values
                var nome = form.querySelector('[name="nome"]'); if (nome) nome.value = btnAbb.dataset.nome || '';
                var descr = form.querySelector('[name="descrizione"]'); if (descr) descr.value = btnAbb.dataset.descrizione || '';
                var imp = form.querySelector('[name="importo"]'); if (imp) { imp.value = btnAbb.dataset.importo || ''; imp.setAttribute('readonly','readonly'); }
                var giorno = form.querySelector('[name="giorno_addebito"]'); if (giorno) { giorno.value = btnAbb.dataset.giornoAddebito || ''; giorno.setAttribute('readonly','readonly'); }
                // set form action to modifica endpoint
                form.action = '/ppay_evolution/modifica_abbonamento_postepay/' + (btnAbb.dataset.abbonamentoId || '');
                var submit = form.querySelector('#btn-salva-abbonamento'); if (submit) submit.innerHTML = 'Salva Modifiche';
                // set header to indicate edit mode and add a small badge
                try {
                    var card = form.closest('.card');
                    var hdr = card && card.querySelector('.card-header h5');
                    if (hdr) hdr.innerHTML = '<i class="fas fa-edit me-2"></i>Modifica Abbonamento <span class="badge bg-warning inline-edit-badge ms-2">Modifica</span>';
                } catch(e){}
            }, 30);
            return;
        }

        // Movimento edit
        var btnMov = e.target.closest && e.target.closest('.btn-edit-movimento');
        if (btnMov) {
            e.preventDefault();
            insertTemplateAtTop('tmpl-nuovo-movimento', 'form-nuovo-movimento');
            setTimeout(function(){
                var form = document.querySelector('.form-nuovo-movimento');
                if (!form) return;
                var data = form.querySelector('[name="data"]'); if (data) data.value = btnMov.dataset.movimentoData || '';
                var descr = form.querySelector('[name="descrizione"]'); if (descr) descr.value = btnMov.dataset.movimentoDescrizione || '';
                var tipo = form.querySelector('[name="tipo"]'); if (tipo) tipo.value = btnMov.dataset.movimentoTipo || 'entrata';
                var importo = form.querySelector('[name="importo"]'); if (importo) importo.value = btnMov.dataset.movimentoImporto || '';
                
                // Populate tipo_movimento dynamically based on tipo, preserving existing value (including Abbonamento)
                var tipoMovSelect = form.querySelector('[name="tipo_movimento"]');
                var movimentoTipoVal = btnMov.dataset.movimentoTipoMovimento || '';
                
                if (tipoMovSelect && tipo) {
                    const optionsEntrata = ['Ricarica', 'Rimborso', 'P2P', 'Altro'];
                    const optionsUscita = ['Pagamento', 'Versamento', 'P2P', 'Bonifico', 'Postagiro', 'Altro'];
                    const opts = (tipo.value === 'uscita') ? optionsUscita : optionsEntrata;
                    
                    tipoMovSelect.innerHTML = '';
                    opts.forEach(function(o){
                        const opt = document.createElement('option');
                        opt.value = o;
                        opt.textContent = o;
                        tipoMovSelect.appendChild(opt);
                    });
                    
                    // If existing value not in list (e.g., Abbonamento), add it
                    if (movimentoTipoVal && opts.indexOf(movimentoTipoVal) === -1) {
                        const extra = document.createElement('option');
                        extra.value = movimentoTipoVal;
                        extra.textContent = movimentoTipoVal;
                        extra.selected = true;
                        tipoMovSelect.insertBefore(extra, tipoMovSelect.firstChild);
                    } else if (movimentoTipoVal) {
                        tipoMovSelect.value = movimentoTipoVal;
                    }
                    
                    // Wire change event for tipo dropdown
                    tipo.addEventListener('change', function(){
                        const newOpts = (tipo.value === 'uscita') ? optionsUscita : optionsEntrata;
                        tipoMovSelect.innerHTML = '';
                        newOpts.forEach(function(o){
                            const opt = document.createElement('option');
                            opt.value = o;
                            opt.textContent = o;
                            tipoMovSelect.appendChild(opt);
                        });
                    });
                }
                
                // set action to modifica movimento endpoint
                form.action = '/ppay_evolution/modifica_movimento_postepay/' + (btnMov.dataset.movimentoId || '');
                var submit = form.querySelector('#btn-salva-movimento'); if (submit) submit.innerHTML = 'Salva Modifiche';
                // header badge for edit
                try {
                    var card = form.closest('.card');
                    var hdr = card && card.querySelector('.card-header h5');
                    if (hdr) hdr.innerHTML = '<i class="fas fa-edit me-2"></i>Modifica Movimento <span class="badge bg-warning inline-edit-badge ms-2">Modifica</span>';
                } catch(e){}
            }, 30);
            return;
        }
    });

    // Delegate submit for dynamically inserted forms (movimento or abbonamento)
    document.addEventListener('submit', function(e){
        const form = e.target;
        if (!form.classList) return;
    const isMov = form.classList.contains('form-nuovo-movimento');
    const isAbb = form.classList.contains('form-nuovo-abbonamento');
    const isDeleteMov = form.classList.contains('form-delete-movimento');
    const isAjaxFragment = form.classList.contains('ajax-fragment');
    if (!isMov && !isAbb && !isDeleteMov && !isAjaxFragment) return;

        // Debug logging: indicate which form was submitted
        try {
            console.log('Submit intercepted', {
                action: form.getAttribute('action'),
                classes: Array.from(form.classList),
                isMov: isMov,
                isAbb: isAbb,
                isDeleteMov: isDeleteMov,
                isAjaxFragment: isAjaxFragment
            });
        } catch(e) { /* ignore logging errors */ }

        // confirm deletion for delete forms (delegate instead of relying on inline onsubmit)
        if (isDeleteMov) {
            e.preventDefault(); e.stopPropagation();
            var msg = 'Sei sicuro di eliminare questo movimento?';
            var confirmFn = (window.showGlobalConfirm && typeof window.showGlobalConfirm === 'function') ? window.showGlobalConfirm : function(m){ return Promise.resolve(confirm(m)); };
            var proceed = false;
            confirmFn(msg).then(function(ok){
                if (!ok) return;
                try { console.log('User confirmed delete for', form.getAttribute('action')); } catch(e){}
                // continue with submit below by removing prevention flag
                try { form.dataset.submitting = '1'; form.submit(); } catch(e){}
            }).catch(function(){ /* ignore */ });
            return;
        }

        // prevent double submission
        if (form.dataset.submitting === '1') {
            e.preventDefault();
            e.stopImmediatePropagation();
            return;
        }
        form.dataset.submitting = '1';

        e.preventDefault();
        e.stopImmediatePropagation();

        // disable submit buttons inside the form
        const submitButtons = form.querySelectorAll('button[type="submit"], input[type="submit"]');
        submitButtons.forEach(btn => { btn.disabled = true; });

        // Normalize action to current origin (avoid wrong host:port) and
        // surface server error body for easier debugging.
        let action = form.getAttribute('action') || window.location.href;
        try {
            const urlObj = new URL(action, window.location.href);
            action = urlObj.pathname + urlObj.search;
        } catch (err) {
            // ignore: keep original action if URL parsing fails
        }

        const fd = new FormData(form);

    postForm(action, fd, { expect: 'raw' })
    .then(async res => {
            // Debug: log response info
            try {
                console.log('Fetch response', {status: res.status, redirected: res.redirected, url: res.url});
            } catch (e) {}
            if (!res.ok) {
                // try to get response text to show useful error
                const txt = await res.text().catch(() => '<no-response-body>');
                console.error('Form submit failed', {status: res.status, body: txt, action});
                try { showToast('Errore server durante l\'operazione: ' + res.status + '\n' + txt, 'danger'); } catch(e) { console && console.error && console.error(e); }
                throw new Error('server');
            }
            // Follow redirects only when fetch actually followed a redirect; otherwise
            // treat the response as an HTML fragment and process it (partial update).
            try {
                if (res.redirected) {
                    console.log('Fetch response was redirected to', res.url, '- ignorando la navigazione e processando l\'HTML per aggiornamento parziale');
                    try { showToast('Attenzione: server ha risposto con redirect; procedo con aggiornamento parziale.', 'warning'); } catch(e){}
                }
            } catch (e) { /* ignore */ }
            // Return response for processing (partial update instead of full reload)
            return res;
        })
    .then(r => r.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // remember current pages so we can reinitialize to the same page after replace
            let prevMovPage = null;
            let prevAbbPage = null;
            const existingMovTable = document.querySelector('#movimenti-table-container table#table-movimenti-recenti');
            if (existingMovTable) prevMovPage = parseInt(existingMovTable.dataset.currentPage, 10) || 1;
            const existingAbbTable = document.querySelector('#abbonamenti-table-container table#table-abbonamenti');
            if (existingAbbTable) prevAbbPage = parseInt(existingAbbTable.dataset.currentPage, 10) || 1;

            // replace movimenti table container if present
            const newMov = doc.getElementById('movimenti-table-container');
            const oldMov = document.getElementById('movimenti-table-container');
            if (newMov && oldMov) oldMov.replaceWith(newMov);

            // replace abbonamenti table container if present
            const newAbb = doc.getElementById('abbonamenti-table-container');
            const oldAbb = document.getElementById('abbonamenti-table-container');
            if (newAbb && oldAbb) oldAbb.replaceWith(newAbb);

            // replace top cards
            const newTop = doc.getElementById('top-cards');
            const oldTop = document.getElementById('top-cards');
            if (newTop && oldTop) oldTop.replaceWith(newTop);

            // replace prossimi addebiti container after movimento operations (saldo changed)
            if (isMov || isDeleteMov) {
                const newAddebiti = doc.getElementById('prossimi-addebiti-container');
                const oldAddebiti = document.getElementById('prossimi-addebiti-container');
                if (newAddebiti && oldAddebiti) oldAddebiti.replaceWith(newAddebiti);
            }

            // re-run small initializers if needed (pagination)
            try {
                // If we just submitted a movimento (add/edit), try to locate it in the new table
                var targetMovPage = prevMovPage;
                try {
                    if (isMov && !isDeleteMov && fd) {
                        const newTable = document.querySelector('#movimenti-table-container table#table-movimenti-recenti');
                        if (newTable) {
                            const pageSizeLocal = parseInt(newTable.dataset.pageSize, 10) || 5;
                            // submitted values
                            const submittedDescr = (fd.get('descrizione') || '').toString().trim();
                            const submittedDateISO = (fd.get('data') || '').toString().trim();
                            const submittedImporto = (fd.get('importo') || '').toString().trim();

                            // Use global `formatDateISOtoDDMM` from utils-format.js

                            const targetDateText = formatDateISOtoDDMM(submittedDateISO);
                            const formattedImporto = formatNumber(parseFloat(submittedImporto) || 0, 2);

                            const newRows = Array.from(newTable.querySelectorAll('tbody tr'));
                            for (var iRow = 0; iRow < newRows.length; iRow++) {
                                const row = newRows[iRow];
                                const descCell = (row.cells[0] && row.cells[0].textContent || '').trim();
                                const dateCell = (row.cells[1] && row.cells[1].textContent || '').trim();
                                let amtCell = (row.cells[3] && row.cells[3].textContent || '').trim();
                                // normalize amount: remove currency symbol and spaces, replace comma with dot
                                amtCell = parseEuro(amtCell) || 0;

                                if (submittedDescr && descCell === submittedDescr && submittedDateISO && dateCell === targetDateText) {
                                    // match amount loosely (formattedImporto may be contained)
                                    if (amtCell.indexOf(formattedImporto) !== -1) {
                                        targetMovPage = Math.floor(iRow / pageSizeLocal) + 1;
                                        break;
                                    }
                                }
                            }
                        }
                    }
                } catch(e) { console.warn('compute targetMovPage failed', e); }

                if (typeof window.initMovimentiPagination === 'function') window.initMovimentiPagination(targetMovPage);
            } catch(e) { console.warn('initMovimentiPagination failed', e); }
            try {
                if (typeof window.initAbbonamentiPagination === 'function') window.initAbbonamentiPagination(prevAbbPage);
            } catch(e) { console.warn('initAbbonamentiPagination failed', e); }

            // Show/scroll the relevant section depending on which form was submitted
            if (isMov || isDeleteMov) {
                // movimenti section is always visible now; just scroll to the table below if needed

                // Scroll the movimenti table into view if present
                const tableAfter = document.getElementById('table-movimenti-recenti');
                if (tableAfter) {
                    setTimeout(function(){
                        try { tableAfter.scrollIntoView({behavior: 'smooth', block: 'center'}); tableAfter.focus(); } catch(e){}
                    }, 200);
                }
            } else if (isAbb) {
                // For abbonamento updates, focus the abbonamenti table and don't open movimenti
                const abbTable = document.getElementById('table-abbonamenti');
                if (abbTable) {
                    setTimeout(function(){ try { abbTable.scrollIntoView({behavior: 'smooth', block: 'center'}); abbTable.focus(); } catch(e){} }, 120);
                }
            }

            // remove inserted form card after submission
            const inserted = document.querySelector('.inline-inserted');
            if (inserted) {
                inserted.remove();
            }

            // re-enable submit buttons just in case (they're removed with the card)
            submitButtons.forEach(btn => { btn.disabled = false; });
        })
        .catch(err => {
            console.error('Errore invio nuovo elemento', err);
            try { showToast('Errore durante l\'operazione. Controlla la console.', 'danger'); } catch(e){}
            // NOTE: previously we forced a full reload here; that cleared console logs
            // making debugging hard. Avoid reloading automatically so developer can inspect errors.
        })
        .finally(() => {
            // clear submitting flag after short delay to avoid accidental double clicks
            setTimeout(() => { try { delete form.dataset.submitting; } catch(e){} }, 1000);
        });
    });

    // Delegated click handler to close inline inserted cards (covers cases where direct listener wasn't attached)
    document.addEventListener('click', function(e){
        const btn = e.target.closest('button[aria-label="Chiudi"]');
        if (!btn) return;
        const card = btn.closest('.card');
        if (card && card.classList.contains('inline-inserted')) {
            card.remove();
        }
    });
});
</script>
{% endblock %}
{% endblock %}


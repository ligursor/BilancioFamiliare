{% extends "base.html" %}

{% block title %}Transazioni - Gestione Bilancio{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="fas fa-list me-2"></i>Gestione Transazioni</h4>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
                    <i class="fas fa-plus me-2"></i>Nuova Transazione
                </button>
            </div>
            <div class="card-body">
                {% if transazioni.items %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th style="cursor: pointer; user-select: none;">
                                    Data 
                                    <span onclick="applicaOrdinamento('data_asc')" class="text-primary me-1" title="Ordina per data crescente" style="cursor: pointer;">
                                        <i class="fas fa-chevron-up {% if request.args.get('ordine') == 'data_asc' %}text-warning{% endif %}"></i>
                                    </span>
                                    <span onclick="applicaOrdinamento('data_desc')" class="text-primary" title="Ordina per data decrescente" style="cursor: pointer;">
                                        <i class="fas fa-chevron-down {% if not request.args.get('ordine') or request.args.get('ordine') == 'data_desc' %}text-warning{% endif %}"></i>
                                    </span>
                                </th>
                                <th>Descrizione</th>
                                <th>Categoria</th>
                                <th>
                                    Tipo 
                                    <div class="dropdown d-inline-block ms-2">
                                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="filterTipoDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-filter"></i>
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="filterTipoDropdown" id="filter_tipo_menu">
                                            <!-- items injected by JS -->
                                        </ul>
                                    </div>
                                </th>
                                <th style="cursor: pointer; user-select: none;">
                                    Importo 
                                    <span onclick="applicaOrdinamento('importo_asc')" class="text-success me-1" title="Ordina per importo crescente" style="cursor: pointer;">
                                        <i class="fas fa-chevron-up {% if request.args.get('ordine') == 'importo_asc' %}text-warning{% endif %}"></i>
                                    </span>
                                    <span onclick="applicaOrdinamento('importo_desc')" class="text-success" title="Ordina per importo decrescente" style="cursor: pointer;">
                                        <i class="fas fa-chevron-down {% if request.args.get('ordine') == 'importo_desc' %}text-warning{% endif %}"></i>
                                    </span>
                                </th>
                                <th>Ricorrente</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transazione in transazioni.items %}
                            <tr>
                                <td>{{ transazione.data.strftime('%d/%m/%Y') }}</td>
                                <td>{{ transazione.descrizione }}</td>
                                <td>
                                    <span class="badge {% if transazione.categoria.tipo == 'entrata' %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ transazione.categoria.nome }}
                                    </span>
                                </td>
                                <td>
                                    {% if transazione.tipo == 'entrata' %}
                                        <span class="text-success"><i class="fas fa-arrow-up"></i> Entrata</span>
                                    {% else %}
                                        <span class="text-danger"><i class="fas fa-arrow-down"></i> Uscita</span>
                                    {% endif %}
                                </td>
                                <td class="{% if transazione.tipo == 'entrata' %}text-success{% else %}text-danger{% endif %}">
                                    {% if transazione.tipo == 'entrata' %}+{% else %}-{% endif %}€ {{ "%.2f"|format(transazione.importo) }}
                                </td>
                                <td>
                                    {% if transazione.ricorrente %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-repeat"></i> 
                                            {% if transazione.frequenza_giorni == 30 %}Mensile{% elif transazione.frequenza_giorni == 365 %}Annuale{% else %}Ogni {{ transazione.frequenza_giorni }} giorni{% endif %}
                                        </span>
                                    {% elif transazione.transazione_madre_id %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-link"></i> Ricorrente
                                        </span>
                                    {% else %}
                                        <span class="text-muted">No</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if transazione.transazione_madre_id %}
                                        <button class="btn btn-warning btn-sm me-1 edit-transaction-btn"
                                                data-id="{{ transazione.id }}"
                                                data-importo="{{ transazione.importo }}"
                                                data-data="{{ transazione.data.strftime('%Y-%m-%d') }}"
                                                data-categoria-id="{{ transazione.categoria_id }}"
                                                title="Modifica questa istanza">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    {% endif %}
                                    <a href="{{ url_for('transazioni.elimina', transazione_id=transazione.id) }}" 
                                       class="btn btn-danger btn-sm"
                                       onclick="return confirm('Sei sicuro di voler eliminare questa transazione?')">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Paginazione -->
                {% if transazioni.pages > 1 %}
                <nav aria-label="Paginazione transazioni">
                    <ul class="pagination justify-content-center">
                        {% if transazioni.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('transazioni.lista', page=transazioni.prev_num, tipo=request.args.get('tipo'), ordine=request.args.get('ordine')) }}">Precedente</a>
                            </li>
                        {% endif %}
                        
                        {% for page_num in transazioni.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != transazioni.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('transazioni.lista', page=page_num, tipo=request.args.get('tipo'), ordine=request.args.get('ordine')) }}">{{ page_num }}</a>
                                    </li>
                                {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        
                        {% if transazioni.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('transazioni.lista', page=transazioni.next_num, tipo=request.args.get('tipo'), ordine=request.args.get('ordine')) }}">Successiva</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nessuna transazione trovata</h5>
                    <p class="text-muted">Inizia aggiungendo la tua prima transazione!</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
                        <i class="fas fa-plus me-2"></i>Aggiungi Transazione
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal per aggiungere transazione -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Nuova Transazione</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('transazioni.aggiungi') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="data" class="form-label">Data</label>
                        <input type="date" class="form-control" id="data" name="data" required 
                               value="{{ datetime.now().strftime('%Y-%m-%d') }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="descrizione" class="form-label">Descrizione</label>
                        <input type="text" class="form-control" id="descrizione" name="descrizione" 
                               placeholder="Es. Spesa alimentari" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="tipo" class="form-label">Tipo</label>
                        <select class="form-control" id="tipo" name="tipo" required onchange="filtraCategorie()">
                            <option value="">Seleziona tipo</option>
                            <option value="entrata">Entrata</option>
                            <option value="uscita" selected>Uscita</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="categoria_id" class="form-label">Categoria</label>
                        <select class="form-control" id="categoria_id" name="categoria_id" required>
                            <option value="">Seleziona prima il tipo</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="importo" class="form-label">Importo (€)</label>
                        <input type="number" class="form-control" id="importo" name="importo" 
                               step="0.01" min="0" placeholder="0.00" required>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="ricorrente" name="ricorrente" 
                                   onchange="toggleFrequenza()">
                            <label class="form-check-label" for="ricorrente">
                                Transazione ricorrente
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="frequenza-container" style="display: none;">
                        <label for="frequenza_giorni" class="form-label">Frequenza (giorni)</label>
                        <select class="form-control" id="frequenza_giorni" name="frequenza_giorni">
                            <option value="30">Mensile (stesso giorno ogni mese)</option>
                            <option value="365">Annuale (stesso giorno ogni anno)</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary">Aggiungi Transazione</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal per modificare transazione ricorrente -->
<div class="modal fade" id="editTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Modifica Transazione Ricorrente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editTransactionForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_data" class="form-label">Data</label>
                        <input type="date" class="form-control" id="edit_data" name="data" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_descrizione" class="form-label">Descrizione</label>
                        <input type="text" class="form-control" id="edit_descrizione" name="descrizione" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_categoria_id" class="form-label">Categoria</label>
                        <select class="form-control" id="edit_categoria_id" name="categoria_id" required></select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_importo" class="form-label">Importo (€)</label>
                        <input type="number" class="form-control" id="edit_importo" name="importo" 
                               step="0.01" min="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva Modifiche</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="application/json" id="categorie-data">{{ categorie | tojson }}</script>
<script>
// Read categories from DOM JSON to avoid inline Jinja->JS which static analyzers flag
function getCategorieFromDom() {
    const el = document.getElementById('categorie-data');
    if (!el) return [];
    try { return JSON.parse(el.textContent || el.innerText || '[]'); } catch (e) { return []; }
}
const categorie = getCategorieFromDom();

function filtraCategorie() {
    const tipoSelect = document.getElementById('tipo');
    const categoriaSelect = document.getElementById('categoria_id');
    const tipoSelezionato = tipoSelect.value;
    
    // Pulisci le opzioni esistenti
    categoriaSelect.innerHTML = '<option value="">Seleziona categoria</option>';
    
    if (tipoSelezionato) {
        // Filtra e aggiungi le categorie del tipo selezionato
        categorie
            .filter(cat => cat.tipo === tipoSelezionato)
            .forEach(categoria => {
                const option = document.createElement('option');
                option.value = categoria.id;
                option.textContent = categoria.nome;
                categoriaSelect.appendChild(option);
            });
    }
}

    

function applicaFiltri() {
    const tipo = urlParams.get('tipo') || '';
    const urlParams = new URLSearchParams(window.location.search);
    
    if (tipo) {
        urlParams.set('tipo', tipo);
    } else {
        urlParams.delete('tipo');
    }
    
    // Mantieni la pagina corrente se esiste
    if (!urlParams.has('page')) {
        urlParams.set('page', '1');
    }
    
    window.location.search = urlParams.toString();
}

// Inizializza il pulsante in base al filtro attuale dalla URL
// Tipo dropdown initialization for this page
function renderTipoMenuTransazioni() {
    const tipoMenu = document.getElementById('filter_tipo_menu');
    if (!tipoMenu) return;
    tipoMenu.innerHTML = '';
    const entries = [ {id: '', nome: 'Tutte'}, {id: 'entrata', nome: 'Entrata'}, {id: 'uscita', nome: 'Uscita'} ];
    entries.forEach(e => {
        const li = document.createElement('li');
        const b = document.createElement('button'); b.type='button'; b.className='dropdown-item'; b.textContent = e.nome; b.dataset.id = e.id;
        b.addEventListener('click', function(){
            const urlParams = new URLSearchParams(window.location.search);
            if (e.id) urlParams.set('tipo', e.id); else urlParams.delete('tipo');
            urlParams.set('page', '1');
            window.location.search = urlParams.toString();
        });
        li.appendChild(b); tipoMenu.appendChild(li);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Attach delegated handler for edit buttons created server-side
    document.body.addEventListener('click', function(e){
        const btn = e.target.closest && e.target.closest('.edit-transaction-btn');
        if (!btn) return;
        const id = btn.dataset.id;
        const importo = btn.dataset.importo;
        const data = btn.dataset.data;
        const categoriaId = btn.dataset.categoriaId;
        // Popola descrizione via lookup (if needed) or leave empty; we'll pass empty string
        modificaTransazione(id, '', importo, data, categoriaId);
    });
    const urlParams = new URLSearchParams(window.location.search);
    const tipoAttuale = urlParams.get('tipo') || '';
    // prefer dropdown button if present
    const dropdownBtn = document.getElementById('filterTipoDropdown');
    if (dropdownBtn) {
        // set icon state
        const icon = dropdownBtn.querySelector('i');
        if (icon) {
            if (tipoAttuale) { icon.classList.add('text-primary'); icon.classList.remove('filter-muted'); }
            else { icon.classList.remove('text-primary'); icon.classList.add('filter-muted'); }
        }
        // populate menu lazily on first open for performance
        let tipoPopulated = false;
        dropdownBtn.addEventListener('click', function(){ if (!tipoPopulated) { renderTipoMenuTransazioni(); tipoPopulated = true; } });
    }
});

function applicaOrdinamento(ordine) {
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('ordine', ordine);
    urlParams.set('page', '1'); // Torna alla prima pagina
    window.location.search = urlParams.toString();
}

function toggleFrequenza() {
    const ricorrenteCheck = document.getElementById('ricorrente');
    const frequenzaContainer = document.getElementById('frequenza-container');
    
    if (ricorrenteCheck.checked) {
        frequenzaContainer.style.display = 'block';
    } else {
        frequenzaContainer.style.display = 'none';
    }
}

function modificaTransazione(id, descrizione, importo, data, categoriaId) {
    // Popola il form di modifica
    document.getElementById('edit_descrizione').value = descrizione;
    document.getElementById('edit_importo').value = importo;
    document.getElementById('edit_data').value = data;
    
    // Popola le categorie nel select di modifica
    const editCategoriaSelect = document.getElementById('edit_categoria_id');
    editCategoriaSelect.innerHTML = '';
    categorie.forEach(categoria => {
        const option = document.createElement('option');
        option.value = categoria.id;
        option.textContent = categoria.nome;
        option.selected = categoria.id == categoriaId;
        editCategoriaSelect.appendChild(option);
    });
    
    // Imposta l'action del form
    document.getElementById('editTransactionForm').action = '/modifica_transazione/' + id;
    
    // Mostra il modal
    new bootstrap.Modal(document.getElementById('editTransactionModal')).show();
}

// Carica automaticamente le categorie di uscita al caricamento della pagina
document.addEventListener('DOMContentLoaded', function() {
    // Aspetta un momento per assicurarsi che tutto sia renderizzato
    setTimeout(function() {
        filtraCategorie();
    }, 100);
});

// Backup: richiama filtraCategorie anche quando la finestra è completamente caricata
window.addEventListener('load', function() {
    filtraCategorie();
});
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Garage{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-lg-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-warehouse me-2"></i>Garage Auto</h2>
            </div>
        </div>
    </div>

    <!-- Statistiche generali (stile PayPal: titolo+valore a sinistra, icona a destra) -->
    <div id="top-cards" class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Veicoli Attivi</h5>
                            <h3>{{ veicoli|length }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-car fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Totale Finanziamenti</h5>
                            <h3>{{ (totale_costo_finanziamento) | format_currency }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-euro-sign fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Totale Versato</h5>
                            <h3>{{ (totale_versato) | format_currency }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-wallet fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Saldo Rimanente</h5>
                            <h3>{{ (totale_saldo_rimanente) | format_currency }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-coins fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bolli in attesa di pagamento -->
    {% if bolli_in_attesa %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Bolli in Attesa di Pagamento</h5>
                </div>
                <div class="card-body">
                    {% for bollo in bolli_in_attesa %}
                    <div class="alert alert-permanent {% if bollo.giorni <= 0 %}alert-danger{% elif bollo.giorni <= 30 %}alert-warning{% else %}alert-info{% endif %} mb-2">
                        <strong>{{ bollo.veicolo.nome_completo }}</strong> - {{ bollo.tipo }}
                        <br>
                        <small>{{ bollo.dettaglio }}</small>
                        <div class="mt-2">
                        {% if bollo.giorni <= 0 %}
                            <span class="badge bg-danger">SCADUTO</span>
                        {% elif bollo.giorni <= 30 %}
                            <span class="badge bg-warning">IN SCADENZA</span>
                        {% else %}
                            <span class="badge bg-info">DA PAGARE</span>
                        {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Lista veicoli -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-car me-2"></i>I Tuoi Veicoli</h5>
                    <div>
                        <button id="btn-nuovo-veicolo" type="button" class="btn btn-sm btn-success">
                            <i class="fas fa-plus me-1"></i>Nuovo Veicolo
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="veicoli-list">
                    {% if veicoli %}
                    <div class="row">
                        {% for veicolo in veicoli %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title d-flex align-items-center justify-content-between">
                                        <span>
                                            {{ veicolo.nome_completo }}
                                            {%- if veicolo.tipo == 'auto' -%}
                                                <span class="badge bg-secondary ms-2"><i class="fas fa-car me-1"></i>Auto</span>
                                            {%- elif veicolo.tipo == 'moto' -%}
                                                <span class="badge bg-secondary ms-2"><i class="fas fa-motorcycle me-1"></i>Moto</span>
                                            {%- elif veicolo.tipo == 'bici' -%}
                                                <span class="badge bg-secondary ms-2"><i class="fas fa-bicycle me-1"></i>Bici</span>
                                            {%- else -%}
                                                <span class="badge bg-secondary ms-2"><i class="fas fa-car me-1"></i>{{ veicolo.tipo }}</span>
                                            {%- endif -%}
                                        </span>
                                        <a href="{{ url_for('veicoli.dettaglio', veicolo_id=veicolo.id) }}" class="btn btn-sm btn-outline-primary" title="Dettagli">
                                            <i class="far fa-eye"></i>
                                        </a>
                                    </h6>
                                    <p class="card-text">
                                        <small class="text-muted">
                                            {# Mostra nelle card la prossima scadenza di bollo e assicurazione per auto/moto #}
                                            {% if veicolo.tipo in ['auto','moto'] %}
                                                {% if veicolo.next_bollo_scadenza %}
                                                    Bollo: {{ veicolo.next_bollo_scadenza }}<br>
                                                {% endif %}
                                                {% if veicolo.next_assicurazione_scadenza %}
                                                    Assicurazione: {{ veicolo.next_assicurazione_scadenza }}<br>
                                                {% endif %}
                                            {% endif %}
                                            {# Non mostriamo i dettagli del finanziamento nella card: sono disponibili nella pagina dettaglio veicolo #}
                                        </small>
                                    </p>
                                    {# I dettagli finanziari sono stati rimossi dalla card per evitare duplicazioni; usare la pagina dettaglio per informazioni complete #}
                                </div>
                                <div class="card-footer">
                                    <div class="btn-group w-100" role="group">
                                        {%- if veicolo.tipo in ['auto','moto'] -%}
                                        <button type="button" class="btn btn-sm btn-success" data-action="open-inline-bollo" data-id="{{ veicolo.id }}" data-name="{{ veicolo.nome_completo }}">
                                            <i class="fas fa-receipt"></i> Bollo
                                        </button>
                                        <button type="button" class="btn btn-sm btn-info" data-action="open-inline-assicurazione" data-id="{{ veicolo.id }}" data-name="{{ veicolo.nome_completo }}">
                                            <i class="fas fa-shield-alt"></i> Assicurazione
                                        </button>
                                        {%- endif -%}
                                        <button type="button" class="btn btn-sm btn-warning" data-action="open-inline-manutenzione" data-id="{{ veicolo.id }}" data-name="{{ veicolo.nome_completo }}">
                                            <i class="fas fa-wrench"></i> Manutenzione
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-car fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Nessun veicolo nel garage</h5>
                        <p class="text-muted">Aggiungi il primo veicolo per iniziare!</p>
                    </div>
                    {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Attività recenti (collassate e paginate come PostePay Movimenti) -->
    <div class="row">
        <!-- Bolli pagati (mostrati sempre) -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Bolli Pagati</h5>
                </div>
                <div class="card-body">
                        {% if ultimi_bolli %}
                        <div class="table-responsive">
                            <table id="table-bolli" class="table table-striped table-sm det-mese-table" data-page-size="3" tabindex="-1">
                                <thead>
                                    <tr>
                                        <th class="text-center">Veicolo</th>
                                        <th class="text-center">Data</th>
                                        <th class="text-center">Anno</th>
                                        <th class="text-center">Importo</th>
                                        <th class="text-center">Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for bollo in ultimi_bolli %}
                                    <tr>
                                        <td class="text-start">{{ bollo.veicolo.nome_completo }}</td>
                                        <td class="text-center">{{ bollo.data_pagamento.strftime('%d/%m/%Y') }}</td>
                                        <td class="text-center">{{ bollo.anno_riferimento }}</td>
                                        <td class="text-center">{{ (bollo.importo) | format_currency }}</td>
                                        <td class="text-center">
                                            <form method="POST" action="{{ url_for('veicoli.elimina_bollo', bollo_id=bollo.id) }}" style="display:inline;" data-action="confirm-delete" data-message="Sei sicuro di voler eliminare questo bollo?">
                                                <button type="submit" class="btn btn-outline-danger btn-sm" title="Elimina bollo" aria-label="Elimina bollo">
                                                    <i class="fas fa-trash" aria-hidden="true"></i>
                                                    <span class="visually-hidden">Elimina bollo</span>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <nav id="pagination-bolli" class="mt-2 d-flex justify-content-center" aria-label="Paginazione bolli"></nav>
                        {% else %}
                        <p class="text-muted text-center">Nessun bollo registrato</p>
                        {% endif %}
                </div>
            </div>
        </div>

        <!-- Assicurazioni (mostrate sempre) -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Assicurazioni</h5>
                </div>
                <div class="card-body">
                        {% if ultime_assicurazioni %}
                        <div class="table-responsive">
                            <table id="table-assicurazioni" class="table table-striped table-sm det-mese-table" data-page-size="3" tabindex="-1">
                                <thead>
                                    <tr>
                                        <th class="text-center">Veicolo</th>
                                        <th class="text-center">Data</th>
                                        <th class="text-center">Compagnia</th>
                                        <th class="text-center">Importo</th>
                                        <th class="text-center">Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for assicurazione in ultime_assicurazioni %}
                                    <tr>
                                        <td class="text-start">{{ assicurazione.veicolo.nome_completo }}</td>
                                        <td class="text-center">{{ assicurazione.data_pagamento.strftime('%d/%m/%Y') }}</td>
                                        <td class="text-start">{{ assicurazione.compagnia }}</td>
                                        <td class="text-center">{{ assicurazione.importo | format_currency }}</td>
                                        <td class="text-center">
                                            <form method="POST" action="{{ url_for('veicoli.elimina_assicurazione', assicurazione_id=assicurazione.id) }}" style="display:inline;" data-action="confirm-delete" data-message="Sei sicuro di voler eliminare questa assicurazione?">
                                                <button type="submit" class="btn btn-outline-danger btn-sm" title="Elimina assicurazione" aria-label="Elimina assicurazione">
                                                    <i class="fas fa-trash" aria-hidden="true"></i>
                                                    <span class="visually-hidden">Elimina assicurazione</span>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <nav id="pagination-assicurazioni" class="mt-2 d-flex justify-content-center" aria-label="Paginazione assicurazioni"></nav>
                        {% else %}
                        <p class="text-muted text-center">Nessuna assicurazione registrata</p>
                        {% endif %}
                </div>
            </div>
        </div>

        <!-- Manutenzioni (mostrate sempre) -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-wrench me-2"></i>Manutenzioni</h5>
                </div>
                <div class="card-body">
                        {% if ultime_manutenzioni %}
                        <div class="table-responsive">
                            <table id="table-manutenzioni" class="table table-striped table-sm det-mese-table" data-page-size="3" tabindex="-1">
                                <thead>
                                    <tr>
                                        <th class="text-center">Veicolo</th>
                                        <th class="text-center">Data</th>
                                        <th class="text-center">Dettaglio</th>
                                        <th class="text-center">Importo</th>
                                        <th class="text-center">Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for manutenzione in ultime_manutenzioni %}
                                    <tr>
                                        <td class="text-start">{{ manutenzione.veicolo.nome_completo }}</td>
                                        <td class="text-center">{{ manutenzione.data_intervento.strftime('%d/%m/%Y') }}</td>
                                        <td class="text-start">{{ manutenzione.tipo_intervento }}<br><small class="text-muted">{{ manutenzione.officina }} - KM {{ "{:,}".format(manutenzione.km_intervento).replace(',', '.') }}</small></td>
                                        <td class="text-center">{{ (manutenzione.costo) | format_currency }}</td>
                                        <td class="text-center">
                                            <form method="POST" action="{{ url_for('veicoli.elimina_manutenzione', manutenzione_id=manutenzione.id) }}" style="display:inline;" data-action="confirm-delete" data-message="Sei sicuro di voler eliminare questa manutenzione?">
                                                <button type="submit" class="btn btn-outline-danger btn-sm" title="Elimina manutenzione" aria-label="Elimina manutenzione">
                                                    <i class="fas fa-trash" aria-hidden="true"></i>
                                                    <span class="visually-hidden">Elimina manutenzione</span>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <nav id="pagination-manutenzioni" class="mt-2 d-flex justify-content-center" aria-label="Paginazione manutenzioni"></nav>
                        {% else %}
                        <p class="text-muted text-center">Nessuna manutenzione registrata</p>
                        {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template nascosto per Nuovo Veicolo (inserito inline nella card) -->
<template id="tpl-nuovo-veicolo">
    <div id="card-nuovo-veicolo" class="card mb-2 inline-add-box">
        <div class="card-header d-flex align-items-center py-2">
            <h5 class="mb-0 fs-6"><i class="fas fa-plus me-2"></i>Nuovo Veicolo</h5>
            <button type="button" class="btn btn-link p-0 ms-auto" aria-label="Chiudi" id="btn-close-nuovo-veicolo">
                <i class="fas fa-times" style="font-size:1.1rem;color:#000;"></i>
            </button>
        </div>
        <div class="card-body py-2">
            <form id="form-nuovo-veicolo" method="POST" action="{{ url_for('veicoli.aggiungi_veicolo') }}">
                <div class="row g-2">
                    <!-- Row 1: tipo / modello / checkbox finanziamento -->
                    <div class="col-6 col-md-2">
                        <div class="d-flex align-items-center">
                            <label class="form-label small mb-0 me-2">Tipo:</label>
                            <select class="form-control form-control-sm flex-fill" name="tipo" id="tipo" aria-label="Tipo veicolo">
                                <option value="auto">Auto</option>
                                <option value="moto">Moto</option>
                                <option value="bici">Bici</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-6 col-md-5">
                        <div class="d-flex align-items-center">
                            <label class="form-label small mb-0 me-2">Modello:</label>
                            <input type="text" class="form-control form-control-sm flex-fill" name="modello" id="modello" placeholder="Modello *" required aria-label="Modello">
                        </div>
                    </div>
                    <div class="col-6 col-md-2 field-bollo">
                        <div class="d-flex align-items-center">
                            <label class="form-label small mb-0 me-2 text-nowrap">Mese bollo:</label>
                            <select class="form-control form-control-sm" name="mese_scadenza_bollo" aria-label="Mese bollo" style="width: auto;"
                                <option value="">Sel.</option>
                                <option value="1">Gennaio</option>
                                <option value="2">Febbraio</option>
                                <option value="3">Marzo</option>
                                <option value="4">Aprile</option>
                                <option value="5">Maggio</option>
                                <option value="6">Giugno</option>
                                <option value="7">Luglio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Settembre</option>
                                <option value="10">Ottobre</option>
                                <option value="11">Novembre</option>
                                <option value="12">Dicembre</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-12 col-md-3 d-flex align-items-left">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="has_finanziamento" name="has_finanziamento">
                            <label class="form-check-label small" for="has_finanziamento">Finanziamento</label>
                        </div>
                    </div>

                    <!-- Financing fields (shown when checkbox selected) -->
                    <div class="col-6 col-md-3 financing-fields" style="display:none;">
                        <div class="d-flex align-items-center">
                            <label class="form-label small mb-0 me-2">Costo:</label>
                            <input id="costo_finanziamento" type="number" class="form-control form-control-sm text-end flex-fill financing-field" name="costo_finanziamento" placeholder="Costo (€)" step="0.01" min="0" aria-label="Costo">
                        </div>
                    </div>
                    <div class="col-6 col-md-2 financing-fields" style="display:none;">
                        <div class="d-flex align-items-center">
                            <label class="form-label small mb-0 me-2 text-nowrap">Numero rate:</label>
                            <input id="numero_rate" type="number" class="form-control form-control-sm financing-field" name="numero_rate" placeholder="Rate" min="0" aria-label="Numero rate" style="width: 70px;">
                        </div>
                    </div>
                    <div class="col-6 col-md-2 financing-fields" style="display:none;">
                        <div class="d-flex align-items-center">
                            <label class="form-label small mb-0 me-2">Rata:</label>
                            <input id="rata_mensile" type="number" class="form-control form-control-sm text-end flex-fill financing-field" name="rata_mensile" placeholder="Rata (€)" step="0.01" min="0" aria-label="Rata mensile">
                        </div>
                    </div>
                    <div class="col-6 col-md-2 financing-fields" style="display:none;">
                        <div class="d-flex align-items-center">
                            <label class="form-label small mb-0 me-2 text-nowrap">Prima rata:</label>
                            <input id="prima_rata" type="date" class="form-control form-control-sm financing-field" name="prima_rata" aria-label="Prima rata" style="width: auto;">
                        </div>
                    </div>

                    <!-- Row 3: submit -->
                    <div class="col-12 d-flex justify-content-end mt-2">
                        <button type="submit" id="btn-salva-nuovo-veicolo" class="btn btn-success btn-sm">Aggiungi Veicolo</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</template>

<!-- Inline templates per aggiunte rapide (sostituiscono i modali): bollo / manutenzione / assicurazione -->
<template id="tpl-nuovo-bollo">
    <div class="card my-3 inline-add-box">
        <div class="card-header d-flex align-items-center py-1">
            <h5 class="mb-0 fs-6"><i class="fas fa-receipt me-2"></i>Nuovo Bollo per <span class="ms-2"><strong class="inline-target-name"></strong></span></h5>
            <button type="button" class="btn btn-link p-0 ms-auto inline-cancel" aria-label="Chiudi">
                <i class="fas fa-times" style="font-size:1.1rem;color:#000;"></i>
            </button>
        </div>
        <div class="card-body py-1">
            <form class="form-inline-bollo" method="POST" action="{{ url_for('veicoli.aggiungi_bollo') }}">
                <input type="hidden" name="veicolo_id" value="">
                <div class="row g-2 align-items-center mb-3 mt-1">
                    <div class="col-6 col-md-3">
                        <div class="d-flex align-items-center">
                            <label class="form-label small mb-0 me-2">Anno:</label>
                            <input type="number" class="form-control form-control-sm flex-fill" name="anno_riferimento" min="2000" max="2100" value="{{ datetime.now().year }}" required>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="d-flex align-items-center">
                            <label class="form-label small mb-0 me-2">Data:</label>
                            <input type="date" class="form-control form-control-sm flex-fill" name="data_pagamento" value="{{ datetime.now().strftime('%Y-%m-%d') }}" required>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="d-flex align-items-center">
                            <label class="form-label small mb-0 me-2">Importo:</label>
                            <input type="number" class="form-control form-control-sm text-end flex-fill" name="importo" step="0.01" min="0" placeholder="Importo (€)" required>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 d-flex align-items-center justify-content-end">
                        <button type="submit" class="btn btn-success btn-sm">Aggiungi Bollo</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</template>

<template id="tpl-nuova-manutenzione">
    <div class="card mb-2 inline-add-box">
        <div class="card-header d-flex align-items-center py-2">
            <h5 class="mb-0 fs-6"><i class="fas fa-wrench me-2"></i>Nuova Manutenzione per <span class="ms-2"><strong class="inline-target-name"></strong></span></h5>
            <button type="button" class="btn btn-link p-0 ms-auto inline-cancel" aria-label="Chiudi">
                <i class="fas fa-times" style="font-size:1.1rem;color:#000;"></i>
            </button>
        </div>
        <div class="card-body py-2">
            <form class="form-inline-manutenzione" method="POST" action="{{ url_for('veicoli.aggiungi_manutenzione') }}">
                <input type="hidden" name="veicolo_id" value="">
                <div class="row g-2">
                    <!-- Prima riga: Data | KM | Officina | Tipo | Costo (responsive: 2 per riga su xs, 5 cols md+) -->
                    <div class="col-6 col-md-2">
                        <div class="d-flex align-items-center">
                            <label class="form-label small mb-0 me-2">Data:</label>
                            <input type="date" class="form-control form-control-sm flex-fill" name="data_intervento" value="{{ datetime.now().strftime('%Y-%m-%d') }}" required>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="d-flex align-items-center">
                            <label class="form-label small mb-0 me-2">KM:</label>
                            <input type="number" class="form-control form-control-sm flex-fill" name="km_intervento" min="0" required>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="d-flex align-items-center">
                            <label class="form-label small mb-0 me-2">Officina:</label>
                            <input type="text" class="form-control form-control-sm flex-fill" name="officina" placeholder="Officina" required>
                        </div>
                    </div>
                    <div class="col-6 col-md-4">
                        <div class="d-flex align-items-center">
                            <label class="form-label small mb-0 me-2">Tipo:</label>
                            <input type="text" class="form-control form-control-sm flex-fill" name="tipo_intervento" placeholder="Tipo intervento" required>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="d-flex align-items-center">
                            <label class="form-label small mb-0 me-2">Costo:</label>
                            <input type="number" class="form-control form-control-sm text-end flex-fill" name="costo" step="0.01" min="0" placeholder="Costo (€)" required>
                        </div>
                    </div>

                    <!-- Dettaglio + pulsante affiancati (responsive) -->
                    <div class="col-12">
                        <div class="row g-2 align-items-start">
                            <div class="col-12 col-md-9">
                                <div class="d-flex align-items-start">
                                    <label class="form-label small mb-0 me-2">Dettaglio:</label>
                                    <textarea class="form-control form-control-sm flex-fill" name="dettaglio" rows="2" placeholder="Dettaglio (opzionale)"></textarea>
                                </div>
                            </div>
                            <div class="col-12 col-md-3 d-flex">
                                <div class="w-100 d-flex justify-content-end align-items-start">
                                    <button type="submit" class="btn btn-success btn-sm">Aggiungi Manutenzione</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</template>

<template id="tpl-nuova-assicurazione">
    <div class="card my-3 inline-add-box">
        <div class="card-header d-flex align-items-center py-1">
            <h5 class="mb-0 fs-6"><i class="fas fa-shield-alt me-2"></i>Nuova Assicurazione per <span class="ms-2"><strong class="inline-target-name"></strong></span></h5>
            <button type="button" class="btn btn-link p-0 ms-auto inline-cancel" aria-label="Chiudi">
                <i class="fas fa-times" style="font-size:1.1rem;color:#000;"></i>
            </button>
        </div>
        <div class="card-body py-1 mb-3 mt-3">
            <form class="form-inline-assicurazione" method="POST" action="{{ url_for('veicoli.aggiungi_assicurazione') }}">
                <input type="hidden" name="veicolo_id" value="">
                <div class="row g-2 align-items-center">
                    <div class="col-6 col-md-2">
                        <div class="d-flex align-items-center">
                            <label class="form-label small mb-0 me-2">Anno:</label>
                            <input type="number" class="form-control form-control-sm flex-fill" name="anno_riferimento" min="2000" max="2100" value="{{ datetime.now().year }}" required>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="d-flex align-items-center">
                            <label class="form-label small mb-0 me-2">Data:</label>
                            <input type="date" class="form-control form-control-sm flex-fill" name="data_pagamento" value="{{ datetime.now().strftime('%Y-%m-%d') }}" required>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="d-flex align-items-center">
                            <label class="form-label small mb-0 me-2">Compagnia:</label>
                            <input type="text" class="form-control form-control-sm flex-fill" name="compagnia" placeholder="Compagnia" required>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="d-flex align-items-center">
                            <label class="form-label small mb-0 me-2">Importo:</label>
                            <input type="number" class="form-control form-control-sm text-end flex-fill" name="importo" step="0.01" min="0" placeholder="Importo (€)" required>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 d-flex align-items-center justify-content-end">
                        <button type="submit" class="btn btn-success btn-sm">Aggiungi Assicurazione</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</template>

<script>
// Gestore inline per i pulsanti "open-inline-*" che clona i template e li inserisce vicino alla card del veicolo
document.addEventListener('click', function(evt){
    try {
        var el = evt.target;
        while(el && el !== document.documentElement) {
            if (el.dataset && el.dataset.action) break;
            el = el.parentElement;
        }
        if (!el || el === document.documentElement) return;
        var action = el.dataset.action;
        if (!action || !action.startsWith('open-inline-')) return;
        evt.preventDefault();

        var tplId = null;
        if (action === 'open-inline-bollo') tplId = 'tpl-nuovo-bollo';
        if (action === 'open-inline-manutenzione') tplId = 'tpl-nuova-manutenzione';
        if (action === 'open-inline-assicurazione') tplId = 'tpl-nuova-assicurazione';
        if (!tplId) return;

        var veicoloId = el.dataset.id;
        var card = el.closest('.card');
        if (!card) return;

        // If a global inline box for veicoli already exists (we open it under #veicoli-list),
        // either update it (same form type) or replace its content with the requested template.
        var existingGlobal = document.getElementById('veicoli-inline-box');
        var actionType = (action === 'open-inline-bollo') ? 'bollo' : (action === 'open-inline-manutenzione' ? 'manutenzione' : (action === 'open-inline-assicurazione' ? 'assicurazione' : ''));
        if (existingGlobal) {
            try {
                // If existing box matches requested type, just update veicolo_id and name
                    if (existingGlobal.dataset && existingGlobal.dataset.type === actionType) {
                    var hid = existingGlobal.querySelector('input[name="veicolo_id"]');
                    if (hid) hid.value = veicoloId;
                    var nameEl = existingGlobal.querySelector('.inline-target-name');
                    var veicoloName = el.dataset.name || (card ? (card.querySelector('.card-title') && card.querySelector('.card-title').firstChild ? card.querySelector('.card-title').firstChild.textContent.trim() : '') : '');
                    if (nameEl) nameEl.textContent = veicoloName;
                    var first = existingGlobal.querySelector('input, textarea, select');
                    if (first) first.focus();
                    return;
                }
                // Otherwise replace the existing box with the requested template
                var tplReplace = document.getElementById(tplId);
                if (tplReplace) {
                    var newClone = tplReplace.content.cloneNode(true);
                    var newNode = newClone.firstElementChild;
                    newNode.id = 'veicoli-inline-box';
                    newNode.dataset.type = actionType;
                    var hid = newNode.querySelector('input[name="veicolo_id"]'); if (hid) hid.value = veicoloId;
                    var veicoloName = el.dataset.name || (card ? (card.querySelector('.card-title') ? card.querySelector('.card-title').textContent.trim() : '') : '');
                    var nameEl = newNode.querySelector('.inline-target-name'); if (nameEl) nameEl.textContent = veicoloName;
                    // replace in DOM
                    existingGlobal.parentNode.replaceChild(newNode, existingGlobal);
                    // wire cancel and submit on the new node (reuse same wiring below by assigning node=newNode)
                    var node = newNode;
                    // wire cancel
                    var cancel = node.querySelector('.inline-cancel');
                    if (cancel) cancel.addEventListener('click', function(){ node.remove(); });
                    // wire submit handler
                    var formReplace = node.querySelector('form');
                    if (formReplace) {
                        formReplace.addEventListener('submit', function(e){
                            e.preventDefault();
                            if (formReplace.dataset.submitting === '1') return;
                            formReplace.dataset.submitting = '1';
                            var action = formReplace.getAttribute('action') || window.location.href;
                            var fd = new FormData(formReplace);
                            fetch(action, { method: 'POST', body: fd, headers: { 'X-Requested-With':'XMLHttpRequest' } })
                            .then(function(resp){ if (!resp.ok) throw new Error('Errore: ' + resp.status); return fetch(window.location.href); })
                            .then(function(resp){ if (!resp.ok) throw new Error('Errore refresh: ' + resp.status); return resp.text(); })
                            .then(function(html){
                                var parser = new DOMParser(); var doc = parser.parseFromString(html,'text/html');
                                var newTop = doc.getElementById('top-cards'); var oldTop = document.getElementById('top-cards'); if (newTop && oldTop) oldTop.innerHTML = newTop.innerHTML;
                                // replace specific table and pagination fragments so the UI updates immediately
                                try { var newTableB = doc.getElementById('table-bolli'); var oldTableB = document.getElementById('table-bolli'); if (newTableB && oldTableB) oldTableB.parentNode.replaceChild(newTableB.cloneNode(true), oldTableB); } catch(e){}
                                try { var newPagB = doc.getElementById('pagination-bolli'); var oldPagB = document.getElementById('pagination-bolli'); if (newPagB && oldPagB) oldPagB.parentNode.replaceChild(newPagB.cloneNode(true), oldPagB); } catch(e){}
                                try { var newTableA = doc.getElementById('table-assicurazioni'); var oldTableA = document.getElementById('table-assicurazioni'); if (newTableA && oldTableA) oldTableA.parentNode.replaceChild(newTableA.cloneNode(true), oldTableA); } catch(e){}
                                try { var newPagA = doc.getElementById('pagination-assicurazioni'); var oldPagA = document.getElementById('pagination-assicurazioni'); if (newPagA && oldPagA) oldPagA.parentNode.replaceChild(newPagA.cloneNode(true), oldPagA); } catch(e){}
                                try { var newTableM = doc.getElementById('table-manutenzioni'); var oldTableM = document.getElementById('table-manutenzioni'); if (newTableM && oldTableM) oldTableM.parentNode.replaceChild(newTableM.cloneNode(true), oldTableM); } catch(e){}
                                try { var newPagM = doc.getElementById('pagination-manutenzioni'); var oldPagM = document.getElementById('pagination-manutenzioni'); if (newPagM && oldPagM) oldPagM.parentNode.replaceChild(newPagM.cloneNode(true), oldPagM); } catch(e){}
                                try { node.remove(); } catch(e){}
                                try { initClientPagination('table-bolli', 'pagination-bolli'); } catch(e){}
                                try { initClientPagination('table-assicurazioni', 'pagination-assicurazioni'); } catch(e){}
                                try { initClientPagination('table-manutenzioni', 'pagination-manutenzioni'); } catch(e){}
                                formReplace.dataset.submitting = '0';
                            }).catch(function(err){ formReplace.dataset.submitting = '0'; try { showToast && showToast('Errore: ' + err.message, 'danger'); } catch(e) {} });
                        });
                    }
                    // focus first input
                    var first = node.querySelector('input, textarea, select'); if (first) first.focus();
                    return;
                }
            } catch(e) {}
        }

        var tpl = document.getElementById(tplId);
        if (!tpl) return;
        var clone = tpl.content.cloneNode(true);
        var node = clone.firstElementChild;
        // set veicolo_id hidden input and display target name in header
        var hidden = node.querySelector('input[name="veicolo_id"]');
        if (hidden) hidden.value = veicoloId;
        try {
            var cardTitle = card ? card.querySelector('.card-title') : null;
            var veicoloName = el.dataset.name || (cardTitle && cardTitle.firstChild ? cardTitle.firstChild.textContent.trim() : '');
            var nameEl = node.querySelector('.inline-target-name');
            if (nameEl) nameEl.textContent = veicoloName;
        } catch(e) {}

    // insert the inline box outside the cards, immediately after the veicoli-list container
    node.dataset.type = actionType;
    node.id = 'veicoli-inline-box';
        var veicoliList = document.getElementById('veicoli-list');
        if (veicoliList && veicoliList.parentNode) {
            veicoliList.parentNode.insertBefore(node, veicoliList.nextSibling);
        } else {
            // fallback: insert after the specific card
            var cardBody = card.querySelector('.card-body');
            if (cardBody) {
                cardBody.insertBefore(node, cardBody.firstElementChild || null);
            } else {
                card.parentNode.insertBefore(node, card.nextSibling);
            }
        }

        // wire cancel
        var cancel = node.querySelector('.inline-cancel');
        if (cancel) cancel.addEventListener('click', function(){ node.remove(); });

        // wire submit via AJAX (same approach used for nuovo veicolo)
        var form = node.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e){
                e.preventDefault();
                if (form.dataset.submitting === '1') return;
                form.dataset.submitting = '1';
                var action = form.getAttribute('action') || window.location.href;
                var fd = new FormData(form);
                fetch(action, { method: 'POST', body: fd, headers: { 'X-Requested-With':'XMLHttpRequest' } })
                .then(function(resp){ if (!resp.ok) throw new Error('Errore: ' + resp.status); return fetch(window.location.href); })
                .then(function(resp){ if (!resp.ok) throw new Error('Errore refresh: ' + resp.status); return resp.text(); })
                .then(function(html){
                    var parser = new DOMParser(); var doc = parser.parseFromString(html,'text/html');
                    // refresh top-cards and tables
                    var newTop = doc.getElementById('top-cards'); var oldTop = document.getElementById('top-cards'); if (newTop && oldTop) oldTop.innerHTML = newTop.innerHTML;
                    // replace specific table and pagination fragments so the UI updates immediately
                    try { var newTableB = doc.getElementById('table-bolli'); var oldTableB = document.getElementById('table-bolli'); if (newTableB && oldTableB) oldTableB.parentNode.replaceChild(newTableB.cloneNode(true), oldTableB); } catch(e){}
                    try { var newPagB = doc.getElementById('pagination-bolli'); var oldPagB = document.getElementById('pagination-bolli'); if (newPagB && oldPagB) oldPagB.parentNode.replaceChild(newPagB.cloneNode(true), oldPagB); } catch(e){}
                    try { var newTableA = doc.getElementById('table-assicurazioni'); var oldTableA = document.getElementById('table-assicurazioni'); if (newTableA && oldTableA) oldTableA.parentNode.replaceChild(newTableA.cloneNode(true), oldTableA); } catch(e){}
                    try { var newPagA = doc.getElementById('pagination-assicurazioni'); var oldPagA = document.getElementById('pagination-assicurazioni'); if (newPagA && oldPagA) oldPagA.parentNode.replaceChild(newPagA.cloneNode(true), oldPagA); } catch(e){}
                    try { var newTableM = doc.getElementById('table-manutenzioni'); var oldTableM = document.getElementById('table-manutenzioni'); if (newTableM && oldTableM) oldTableM.parentNode.replaceChild(newTableM.cloneNode(true), oldTableM); } catch(e){}
                    try { var newPagM = doc.getElementById('pagination-manutenzioni'); var oldPagM = document.getElementById('pagination-manutenzioni'); if (newPagM && oldPagM) oldPagM.parentNode.replaceChild(newPagM.cloneNode(true), oldPagM); } catch(e){}
                    // remove inline node
                    try { node.remove(); } catch(e){}
                    // reinit pagination
                    try { initClientPagination('table-bolli', 'pagination-bolli'); } catch(e){}
                    try { initClientPagination('table-assicurazioni', 'pagination-assicurazioni'); } catch(e){}
                    try { initClientPagination('table-manutenzioni', 'pagination-manutenzioni'); } catch(e){}
                    form.dataset.submitting = '0';
                }).catch(function(err){ form.dataset.submitting = '0'; try { showToast && showToast('Errore: ' + err.message, 'danger'); } catch(e){} });
            });
        }
    } catch(e) { /* swallow */ }
}, false);
</script>

<script>
function setVeicoloId(veicoloId) {
    // set any known modal inputs (backwards compat) and all inline forms' hidden veicolo_id inputs
    var be = document.getElementById('bollo_veicolo_id'); if (be) be.value = veicoloId;
    var me = document.getElementById('manutenzione_veicolo_id'); if (me) me.value = veicoloId;
    var ae = document.getElementById('assicurazione_veicolo_id'); if (ae) ae.value = veicoloId;
    try {
        var all = document.querySelectorAll('input[name="veicolo_id"]');
        all.forEach(function(i){ i.value = veicoloId; });
    } catch(e){}
}

// Auto-calcolo rata mensile se inseriti costo e numero rate
var costoGlob = document.getElementById('costo_finanziamento');
var rateGlob = document.getElementById('numero_rate');
if (costoGlob) costoGlob.addEventListener('input', calcolaRataMensile);
if (rateGlob) rateGlob.addEventListener('input', calcolaRataMensile);

function calcolaRataMensile(context){
    // context: optional DOM node to search inputs inside (used for dynamically inserted forms)
    var get = function(name){
        if (context) {
            var el = context.querySelector('[name="'+name+'"]');
            return el;
        }
        return document.getElementById(name);
    };

    var costoEl = get('costo_finanziamento');
    var rateEl = get('numero_rate');
    var rataEl = get('rata_mensile');
    var costo = costoEl ? parseFloat(costoEl.value) || 0 : 0;
    var rate = rateEl ? parseInt(rateEl.value) || 1 : 1;

    if (costo > 0 && rate > 0 && rataEl) {
        var rataMensile = costo / rate;
        rataEl.value = rataMensile.toFixed(2);
    }
}
</script>

{% block scripts %}
<script>
// Reusable client-side pagination for tables similar to PostePay Evolution
function initClientPagination(tableId, paginationId) {
    var table = document.getElementById(tableId);
    if (!table) return;
    var pageSize = parseInt(table.dataset.pageSize, 10) || 3;
    var tbody = table.querySelector('tbody');
    var rows = tbody ? Array.from(tbody.querySelectorAll('tr')) : [];
    var totalRows = rows.length;
    var totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
    var paginationNav = document.getElementById(paginationId);

    function renderPage(page) {
        var start = (page - 1) * pageSize;
        var end = start + pageSize;
        rows.forEach(function(r, idx){
            r.style.display = (idx >= start && idx < end) ? '' : 'none';
        });
        renderControls(page);
    }

    function renderControls(activePage){
        if (!paginationNav) return;
        paginationNav.innerHTML = '';
        if (totalPages <= 1) return;
        var ul = document.createElement('ul');
        ul.className = 'pagination';
        for (var i = 1; i <= totalPages; i++) {
            var li = document.createElement('li');
            li.className = 'page-item' + (i === activePage ? ' active' : '');
            var a = document.createElement('a');
            a.className = 'page-link';
            a.href = '#';
            a.textContent = i;
            (function(page){
                a.addEventListener('click', function(e){
                    e.preventDefault();
                    renderPage(page);
                });
            })(i);
            li.appendChild(a);
            ul.appendChild(li);
        }
        paginationNav.appendChild(ul);
    }

    // initialize to first page
    renderPage(1);
}

document.addEventListener('DOMContentLoaded', function(){
    initClientPagination('table-bolli', 'pagination-bolli');
    initClientPagination('table-assicurazioni', 'pagination-assicurazioni');
    initClientPagination('table-manutenzioni', 'pagination-manutenzioni');
});
</script>
<script>
// Inserimento inline del box Nuovo Veicolo usando il template e submit via AJAX
document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('btn-nuovo-veicolo');
    if (!btn) return;

    btn.addEventListener('click', function(){
        // evita inserimenti multipli
        if (document.getElementById('card-nuovo-veicolo')) return;

        var tpl = document.getElementById('tpl-nuovo-veicolo');
        if (!tpl) return;
        var clone = tpl.content.cloneNode(true);

        // inserisci il box all'inizio del body della card (dopo header)
        var card = btn.closest('.card');
        var body = card.querySelector('.card-body');
            if (body) {
            // clone.firstElementChild is the card element
            var node = clone.firstElementChild;
            // insert the new box above the entire card (outside 'I Tuoi Veicoli')
            var parent = card.parentNode;
            if (parent) {
                parent.insertBefore(node, card);
            } else {
                body.insertAdjacentElement('afterbegin', node);
            }

            // Configure visibility and handlers for the cloned inline form
            try {
                var tipoEl = node.querySelector('[name="tipo"]');
                var hasFinEl = node.querySelector('[name="has_finanziamento"]');
                var bolloBlock = node.querySelector('.field-bollo');
                var financingBlocks = node.querySelectorAll('.financing-fields');

                function updateInlineVisibility(){
                    var tipoVal = tipoEl ? (tipoEl.value || '').toLowerCase() : '';
                    // hide bollo for bici
                    if (bolloBlock) {
                        bolloBlock.style.display = (tipoVal === 'bici') ? 'none' : '';
                    }
                    // show financing fields only if checkbox is checked
                    var showFin = hasFinEl ? hasFinEl.checked : false;
                    financingBlocks.forEach(function(b){ b.style.display = showFin ? '' : 'none'; });
                }

                if (tipoEl) tipoEl.addEventListener('change', updateInlineVisibility);
                if (hasFinEl) hasFinEl.addEventListener('change', updateInlineVisibility);
                // initial visibility
                updateInlineVisibility();

                // attach rata calc listeners scoped to the node
                var costoEl = node.querySelector('[name="costo_finanziamento"]');
                var rateEl = node.querySelector('[name="numero_rate"]');
                if (costoEl) costoEl.addEventListener('input', function(){ calcolaRataMensile(node); });
                if (rateEl) rateEl.addEventListener('input', function(){ calcolaRataMensile(node); });
            } catch (err) {
                console.warn('Could not wire inline nuovo veicolo handlers', err);
            }

            // hook per il pulsante chiudi dentro il nodo appena inserito
            var cancel = node.querySelector('#btn-close-nuovo-veicolo');
            if (cancel) {
                cancel.addEventListener('click', function(){
                    var box = document.getElementById('card-nuovo-veicolo');
                    if (box) box.remove();
                });
            }

            // attach submit handler for the inline form
            var form = node.querySelector('#form-nuovo-veicolo');
            if (form) {
                form.addEventListener('submit', function(e){
                    e.preventDefault();
                    // prevent double submit
                    if (form.dataset.submitting === '1') return;
                    form.dataset.submitting = '1';

                    var action = form.getAttribute('action') || window.location.href;
                    var fd = new FormData(form);

                    fetch(action, {
                        method: 'POST',
                        body: fd,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    }).then(function(resp){
                        if (!resp.ok) throw new Error('Errore nella richiesta: ' + resp.status);
                        // refresh fragments by re-fetching the page and replacing fragments
                        return fetch(window.location.href);
                    }).then(function(resp){
                        if (!resp.ok) throw new Error('Errore nel recupero della pagina: ' + resp.status);
                        return resp.text();
                    }).then(function(html){
                        var parser = new DOMParser();
                        var doc = parser.parseFromString(html, 'text/html');

                        // replace top-cards
                        var newTop = doc.getElementById('top-cards');
                        var oldTop = document.getElementById('top-cards');
                        if (newTop && oldTop) {
                            oldTop.innerHTML = newTop.innerHTML;
                        }

                        // replace veicoli list
                        var newList = doc.getElementById('veicoli-list');
                        var oldList = document.getElementById('veicoli-list');
                        if (newList && oldList) {
                            oldList.replaceWith(newList.cloneNode(true));
                        }

                        // remove inline box if still present
                        var box = document.getElementById('card-nuovo-veicolo');
                        if (box) box.remove();

                        // re-init client-side pieces (pagination, collapse icons)
                        try { initClientPagination('table-bolli', 'pagination-bolli'); } catch(e){}
                        try { initClientPagination('table-assicurazioni', 'pagination-assicurazioni'); } catch(e){}
                        try { initClientPagination('table-manutenzioni', 'pagination-manutenzioni'); } catch(e){}

                        form.dataset.submitting = '0';
                    }).catch(function(err){
                        form.dataset.submitting = '0';
                        try { showToast('Errore: ' + err.message, 'danger'); } catch(e) {}
                    });
                });
            }
        }
    });
});
</script>
{% endblock %}

{% endblock %}

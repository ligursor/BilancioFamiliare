{% extends "base.html" %}

{% block title %}{{ veicolo.nome_completo }} - Dettaglio{% endblock %}

{% block content %}
<!-- equal-height styles consolidated in static/css/templates.css -->
<div class="container-fluid mt-4">
	<div class="row">
		<div class="col-lg-12">
			<div class="d-flex justify-content-between align-items-center mb-4">
				<div>
					<a href="{{ url_for('veicoli.garage') }}" class="btn btn-secondary me-2">
						<i class="fas fa-arrow-left me-1"></i>Garage
					</a>
					<!-- Modifica button non mostrato per impostazione -->
					<form method="POST" action="{{ url_for('veicoli.rimuovi_veicolo', veicolo_id=veicolo.id) }}" class="d-inline-block" data-action="confirm-delete" data-message="Confermi la rimozione del veicolo dal garage?">
						<button type="submit" class="btn btn-danger ms-2">
							<i class="fas fa-trash me-1"></i>Rimuovi
						</button>
					</form>
				</div>
			</div>
		</div>
	</div>

	<!-- Informazioni veicolo + Situazione Finanziaria affiancate -->
	<div class="row mb-4 min-h-1">
		<div class="col-md-6 equal-height">
			<div class="card equal-height">
				<div class="card-header">
					<h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informazioni Veicolo</h5>
				</div>
				<div class="card-body">
					<div class="row">
						<div class="col-md-6">
							<p><strong>Modello:</strong> {{ veicolo.modello }}</p>
							{%- if veicolo.tipo != 'bici' and veicolo.mese_scadenza_bollo %}
							<p><strong>Scadenza Bollo:</strong> 
								{% set mesi = ['', 'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'] %}
								{{ mesi[veicolo.mese_scadenza_bollo] }}
							</p>
							{% endif %}
						</div>
						<div class="col-md-6">
							{% if veicolo.prima_rata %}
							<p><strong>Prima Rata:</strong> {{ veicolo.prima_rata.strftime('%d/%m/%Y') }}</p>
							{% endif %}
							{% if veicolo.numero_rate %}
							<p><strong>Numero Rate:</strong> {{ veicolo.numero_rate }}</p>
							{% endif %}
							{% if veicolo.rata_mensile %}
							<p><strong>Rata Mensile:</strong> {{ (veicolo.rata_mensile or 0) | format_currency }}</p>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-6 equal-height">
			<div class="card equal-height">
				<div class="card-header">
					<h5 class="mb-0"><i class="fas fa-euro-sign me-2"></i>Situazione Finanziaria</h5>
				</div>
				<div class="card-body">
					<div class="row mb-3">
						<div class="col-6 d-flex align-items-center">
							<span class="fw-bold me-2">Costo Finanziamento:</span>
							<span>{{ (veicolo.costo_finanziamento or 0) | format_currency }}</span>
						</div>
						<div class="col-6 d-flex align-items-center">
							<span class="fw-bold me-2">Totale Versato:</span>
							<span>{{ (veicolo.totale_versato or 0) | format_currency }}</span>
						</div>
					</div>
					<div class="row mb-3">
						<div class="col-6 d-flex align-items-center">
							<span class="fw-bold me-2">Saldo Rimanente:</span>
							{% if (veicolo.saldo_rimanente or 0) > 0 %}
								<span class="text-warning">{{ (veicolo.saldo_rimanente or 0) | format_currency }}</span>
							{% else %}
								<span class="text-success">{{ (0) | format_currency }}</span>
							{% endif %}
						</div>
						<div class="col-6 d-flex align-items-center">
							<span class="fw-bold me-2">Rate Rimanenti:</span>
							<span>{{ veicolo.rate_rimanenti if veicolo.rate_rimanenti else '-' }}</span>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Statistiche costi -->
	<div class="row mb-4">
		{%- set has_bolli = (veicolo.tipo != 'bici') %}
		{%- if has_bolli %}
		<div class="col-md-4">
			<div class="card bg-info text-white">
				<div class="card-body">
					<div class="d-flex justify-content-between">
						<div>
							<h4 class="card-title">{{ (totale_bolli or 0) | format_currency }}</h4>
							<p class="card-text">Totale Bolli</p>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card bg-warning text-white">
				<div class="card-body">
					<div class="d-flex justify-content-between">
						<div>
							<h4 class="card-title">{{ (totale_manutenzioni or 0) | format_currency }}</h4>
							<p class="card-text">Totale Manutenzioni</p>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card bg-danger text-white">
				<div class="card-body">
					<div class="d-flex justify-content-between">
						<div>
							<h4 class="card-title">{{ (costo_totale or 0) | format_currency }}</h4>
							<p class="card-text">Costo Totale</p>
						</div>
					</div>
				</div>
			</div>
		</div>
	<!-- Totale Costi box non mostrato; mantenuto il campo 'Costo Totale' -->
		{%- else %}
		<div class="col-md-4">
			<div class="card bg-warning text-white">
				<div class="card-body">
					<div class="d-flex justify-content-between">
						<div>
							<h4 class="card-title">{{ (totale_manutenzioni or 0) | format_currency }}</h4>
							<p class="card-text">Totale Manutenzioni</p>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card bg-danger text-white">
				<div class="card-body">
					<div class="d-flex justify-content-between">
						<div>
							<h4 class="card-title">{{ (costo_totale or 0) | format_currency }}</h4>
							<p class="card-text">Costo Totale</p>
						</div>
					</div>
				</div>
			</div>
		</div>
	<!-- Totale Costi box non mostrato; mantenuto il campo 'Costo Totale' -->
		{%- endif %}
	</div>

	<!-- Azioni rapide non mostrate: il pulsante Rimuovi è presente nell'header sopra -->

	<!-- Storico operazioni -->
	{%- if veicolo.tipo != 'bici' %}
	<!-- Bolli -->
	<div class="row mb-4">
		<div class="col-12">
			<div class="card">
				<div class="card-header">
					<h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Bolli Pagati</h5>
				</div>
				<div class="card-body">
					{% if bolli %}
					<div class="table-responsive">
						<table id="table-bolli-dettaglio" class="table table-striped table-sm det-mese-table" data-page-size="3" tabindex="-1">
							<thead>
								<tr>
									<th class="text-center">Data</th>
									<th class="text-center">Anno</th>
									<th class="text-center">Importo (€)</th>
									<th class="text-center">Azioni</th>
								</tr>
							</thead>
							<tbody>
								{% for bollo in bolli %}
								<tr>
									<td class="text-center">{{ bollo.data_pagamento.strftime('%d/%m/%Y') }}</td>
									<td class="text-center">{{ bollo.anno_riferimento }}</td>
									<td class="text-center">{{ (bollo.importo or 0) | abs | format_currency('{:.2f}') }}</td>
									<td class="text-center">
										<form method="POST" action="{{ url_for('veicoli.elimina_bollo', bollo_id=bollo.id) }}" class="d-inline" data-action="confirm-delete" data-message="Sei sicuro di voler eliminare questo bollo?">
											<input type="hidden" name="redirect_to_veicolo" value="1">
											<button type="submit" class="btn btn-outline-danger btn-sm" title="Elimina bollo" aria-label="Elimina bollo">
												<i class="fas fa-trash" aria-hidden="true"></i>
												<span class="visually-hidden">Elimina bollo</span>
											</button>
										</form>
									</td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
					<nav id="pagination-bolli-dettaglio" class="mt-2 d-flex justify-content-center" aria-label="Paginazione bolli"></nav>
					{% else %}
					<p class="text-muted text-center">Nessun bollo registrato</p>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
	{%- endif %}

	<!-- Assicurazioni -->
	{%- if veicolo.tipo != 'bici' %}
	<div class="row mb-4">
		<div class="col-12">
			<div class="card">
				<div class="card-header">
					<h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Assicurazioni</h5>
				</div>
				<div class="card-body">
					{% if assicurazioni %}
					<div class="table-responsive">
						<table id="table-assicurazioni-dettaglio" class="table table-striped table-sm det-mese-table" data-page-size="3" tabindex="-1">
							<thead>
								<tr>
									<th class="text-center">Data</th>
									<th class="text-center">Compagnia</th>
									<th class="text-center">Importo (€)</th>
									<th class="text-center">Azioni</th>
								</tr>
							</thead>
							<tbody>
								{% for assicurazione in assicurazioni %}
								<tr>
									<td class="text-center">{{ assicurazione.data_pagamento.strftime('%d/%m/%Y') }}</td>
									<td class="text-center">{{ assicurazione.compagnia }}</td>
									<td class="text-center">{{ (assicurazione.importo or 0) | abs | format_currency('{:.2f}') }}</td>
									<td class="text-center">
										<form method="POST" action="{{ url_for('veicoli.elimina_assicurazione', assicurazione_id=assicurazione.id) }}" class="d-inline" data-action="confirm-delete" data-message="Sei sicuro di voler eliminare questa assicurazione?">
											<input type="hidden" name="redirect_to_veicolo" value="1">
											<button type="submit" class="btn btn-outline-danger btn-sm" title="Elimina assicurazione" aria-label="Elimina assicurazione">
												<i class="fas fa-trash" aria-hidden="true"></i>
												<span class="visually-hidden">Elimina assicurazione</span>
											</button>
										</form>
									</td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
					<nav id="pagination-assicurazioni-dettaglio" class="mt-2 d-flex justify-content-center" aria-label="Paginazione assicurazioni"></nav>
					{% else %}
					<p class="text-muted text-center">Nessuna assicurazione registrata</p>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
	{%- endif %}

	<!-- Manutenzioni -->
	<div class="row mb-4">
		<div class="col-12">
			<div class="card">
				<div class="card-header">
					<h5 class="mb-0"><i class="fas fa-wrench me-2"></i>Manutenzioni</h5>
				</div>
				<div class="card-body">
					{% if manutenzioni %}
					<div class="table-responsive">
						<table id="table-manutenzioni-dettaglio" class="table table-striped table-sm det-mese-table" data-page-size="3" tabindex="-1">
							<thead>
								<tr>
									<th class="text-center">Tipo</th>
									<th class="text-center">Data</th>
									<th class="text-center">KM</th>
									<th class="text-center">Officina</th>
									<th class="text-center">Dettaglio</th>
									<th class="text-center">Costo (€)</th>
									<th class="text-center">Azioni</th>
								</tr>
							</thead>
							<tbody>
								{% for manutenzione in manutenzioni %}
								<tr>
							<td class="text-center">{{ manutenzione.tipo_intervento }}</td>
							<td class="text-center">{{ manutenzione.data_intervento.strftime('%d/%m/%Y') }}</td>
							<td class="text-center">{{ manutenzione.km_intervento | format_number }}</td>
							<td class="text-center">{{ manutenzione.officina if manutenzione.officina else '-' }}</td>
							<td class="text-center">
								{% if manutenzione.descrizione %}
								<button class="btn btn-outline-info btn-sm" onclick="showDettaglioManutenzione('{{ manutenzione.descrizione | replace('\'', '\\\'') | replace('\n', '\\n') }}')" title="Mostra dettaglio">
									<i class="fas fa-info-circle"></i>
								</button>
								{% else %}
								-
								{% endif %}
							</td>
							<td class="text-center">{{ (manutenzione.costo or 0) | abs | format_currency('{:.2f}') }}</td>
									<td class="text-center">
										<form method="POST" action="{{ url_for('veicoli.elimina_manutenzione', manutenzione_id=manutenzione.id) }}" class="d-inline" data-action="confirm-delete" data-message="Sei sicuro di voler eliminare questa manutenzione?">
											<input type="hidden" name="redirect_to_veicolo" value="1">
											<button type="submit" class="btn btn-outline-danger btn-sm" title="Elimina manutenzione" aria-label="Elimina manutenzione">
												<i class="fas fa-trash" aria-hidden="true"></i>
												<span class="visually-hidden">Elimina manutenzione</span>
											</button>
										</form>
									</td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
					<nav id="pagination-manutenzioni-dettaglio" class="mt-2 d-flex justify-content-center" aria-label="Paginazione manutenzioni"></nav>
					{% else %}
					<p class="text-muted text-center">Nessuna manutenzione registrata</p>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
</div>

<script>
// Funzione per mostrare il dettaglio manutenzione - DEFINITA PRIMA DELL'USO
function showDettaglioManutenzione(descrizione) {
	if (!descrizione) return;
	
	try {
		var modalEl = document.getElementById('globalMessageModal');
		var titleEl = document.getElementById('globalMessageTitle');
		var headerEl = document.getElementById('globalMessageHeader');
		var bodyEl = document.getElementById('globalMessageBody');
		
		if (!modalEl || !titleEl || !bodyEl || !headerEl) {
			console.error('Modal globale non trovato');
			alert(descrizione);
			return;
		}
		
		// Configura il modal
		headerEl.className = 'modal-header bg-info text-white';
		titleEl.textContent = 'Dettaglio Manutenzione';
		
		// Escape HTML e formatta il testo
		var escaped = String(descrizione)
			.replace(/&/g, '&amp;')
			.replace(/</g, '&lt;')
			.replace(/>/g, '&gt;')
			.replace(/"/g, '&quot;')
			.replace(/'/g, '&#039;')
			.replace(/\n/g, '<br>');
		
		bodyEl.innerHTML = '<div class="d-flex align-items-start"><i class="fas fa-info-circle fa-2x me-3 text-info" aria-hidden="true"></i><div style="white-space: pre-wrap; word-wrap: break-word; max-height: 400px; overflow-y: auto;">' + escaped + '</div></div>';
		
		// Mostra il modal
		if (window.bootstrap && window.bootstrap.Modal) {
			var bsModal = window.bootstrap.Modal.getOrCreateInstance(modalEl);
			bsModal.show();
		} else if (typeof Modal !== 'undefined') {
			var bsModal = new Modal(modalEl, { backdrop: 'static' });
			bsModal.show();
		} else {
			console.error('Bootstrap Modal non disponibile');
			alert(descrizione);
		}
	} catch (e) {
		console.error('Errore showDettaglioManutenzione:', e);
		alert(descrizione);
	}
}

// Inizializza la paginazione client-side per le tabelle
document.addEventListener('DOMContentLoaded', function() {
	try {
		if (typeof initClientPagination === 'function') {
			initClientPagination('table-bolli-dettaglio', 'pagination-bolli-dettaglio');
			initClientPagination('table-assicurazioni-dettaglio', 'pagination-assicurazioni-dettaglio');
			initClientPagination('table-manutenzioni-dettaglio', 'pagination-manutenzioni-dettaglio');
		}
	} catch(e) {
		console.error('Errore inizializzazione paginazione:', e);
	}
});
</script>

<!-- Modal modifica non utilizzato in questa vista -->

<!-- Inline templates per aggiungere Bollo/Manutenzione direttamente nella pagina dettaglio -->
<template id="tpl-nuovo-bollo-dettaglio">
	<div class="card mb-2 inline-add-box">
	    <div class="card-header d-flex align-items-center py-2">
		    <h5 class="mb-0 fs-6"><i class="fas fa-receipt me-2"></i>Nuovo Bollo per <span class="ms-2"><strong class="inline-target-name">{{ veicolo.nome_completo }}</strong></span></h5>
			<button type="button" class="btn btn-link p-0 ms-auto inline-cancel text-decoration-none" aria-label="Chiudi">
				<i class="fas fa-times icon-times"></i>
			</button>
		</div>
		<div class="card-body py-2">
			<form class="form-inline-bollo" method="POST" action="{{ url_for('veicoli.aggiungi_bollo') }}">
				<input type="hidden" name="veicolo_id" value="{{ veicolo.id }}">
				<input type="hidden" name="redirect_to_veicolo" value="1">
				<div class="row g-2">
					<div class="col-12 col-md-4">
						<input type="number" class="form-control form-control-sm" name="anno_riferimento" min="2000" max="2100" value="{{ datetime.now().year }}" required>
					</div>
					<div class="col-12 col-md-4">
						<input type="date" class="form-control form-control-sm" name="data_pagamento" value="{{ datetime.now().strftime('%Y-%m-%d') }}" required>
					</div>
					<div class="col-12 col-md-4">
						<input type="number" class="form-control form-control-sm" name="importo" step="0.01" min="0" required>
					</div>
					<div class="col-12 d-flex justify-content-end mt-2">
						<button type="submit" class="btn btn-primary btn-sm">Aggiungi Bollo</button>
					</div>
				</div>
			</form>
		</div>
	</div>
</template>

<template id="tpl-nuova-manutenzione-dettaglio">
	<div class="card mb-2 inline-add-box">
	    <div class="card-header d-flex align-items-center py-2">
		    <h5 class="mb-0 fs-6"><i class="fas fa-wrench me-2"></i>Nuova Manutenzione per <span class="ms-2"><strong class="inline-target-name">{{ veicolo.nome_completo }}</strong></span></h5>
			<button type="button" class="btn btn-link p-0 ms-auto inline-cancel text-decoration-none" aria-label="Chiudi">
				<i class="fas fa-times text-dark fs-6"></i>
			</button>
		</div>
		<div class="card-body py-2">
			<form class="form-inline-manutenzione" method="POST" action="{{ url_for('veicoli.aggiungi_manutenzione') }}">
				<input type="hidden" name="veicolo_id" value="{{ veicolo.id }}">
				<input type="hidden" name="redirect_to_veicolo" value="1">
				<div class="row g-2">
					<div class="col-md-6">
						<input type="date" class="form-control form-control-sm" name="data_intervento" value="{{ datetime.now().strftime('%Y-%m-%d') }}" required>
					</div>
					<div class="col-md-6">
						<input type="number" class="form-control form-control-sm" name="km_intervento" min="0" required>
					</div>
					<div class="col-md-6">
						<input type="text" class="form-control form-control-sm" name="officina" placeholder="Officina" required>
					</div>
					<div class="col-md-6">
						<input type="text" class="form-control form-control-sm" name="tipo_intervento" placeholder="Tipo intervento" required>
					</div>
					<div class="col-12">
						<input type="number" class="form-control form-control-sm" name="costo" step="0.01" min="0" placeholder="Costo (€)" required>
					</div>
					<div class="col-12">
						<textarea class="form-control form-control-sm" name="dettaglio" rows="2" placeholder="Dettaglio (opzionale)"></textarea>
					</div>
					<div class="col-12 d-flex justify-content-end mt-2">
						<button type="submit" class="btn btn-primary btn-sm">Aggiungi Manutenzione</button>
					</div>
				</div>
			</form>
		</div>
	</div>
</template>

<!-- Modal Elimina Veicolo -->
<div class="modal fade" id="modalEliminaVeicolo" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title text-danger"><i class="fas fa-trash me-2"></i>Rimuovi Veicolo</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<div class="alert alert-warning">
					<i class="fas fa-exclamation-triangle me-2"></i>
					Sei sicuro di voler rimuovere <strong>{{ veicolo.nome_completo }}</strong> dal garage?
				</div>
				<p>Il veicolo verrà rimosso dalla vista ma tutti i dati storici (bolli e manutenzioni) saranno conservati.</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
				<form method="POST" action="{{ url_for('veicoli.rimuovi_veicolo', veicolo_id=veicolo.id) }}" class="d-inline">
					<button type="submit" class="btn btn-danger">Rimuovi dal Garage</button>
				</form>
			</div>
		</div>
	</div>
</div>


<script>
// Support inline insertion on dettaglio veicolo page if buttons use data-action="open-inline-*"
document.addEventListener('click', function(evt){
	try {
		var el = evt.target;
		while(el && el !== document.documentElement) {
			if (el.dataset && el.dataset.action) break;
			el = el.parentElement;
		}
		if (!el || el === document.documentElement) return;
		var action = el.dataset.action;
		if (!action || !action.startsWith('open-inline-')) return;
		evt.preventDefault();
		var tplId = null;
		if (action === 'open-inline-bollo') tplId = 'tpl-nuovo-bollo-dettaglio';
		if (action === 'open-inline-manutenzione') tplId = 'tpl-nuova-manutenzione-dettaglio';
		if (!tplId) return;
		var tpl = document.getElementById(tplId);
		if (!tpl) return;
		// avoid duplicates: if already present, focus if same type or replace if different
		var existing = document.querySelector('.inline-add-box');
		var actionType = (action === 'open-inline-bollo') ? 'bollo' : (action === 'open-inline-manutenzione' ? 'manutenzione' : '');
		if (existing) {
			try {
				if (existing.dataset && existing.dataset.type === actionType) {
					var first = existing.querySelector('input,textarea,select'); if (first) first.focus(); return;
				}
				// different type -> remove existing and continue to insert new
				existing.remove();
			} catch(e) {}
		}
		var clone = tpl.content.cloneNode(true);
		// insert after the main header card
		var header = document.querySelector('.container-fluid');
		if (header) header.insertAdjacentElement('afterbegin', clone.firstElementChild);
		// mark the inserted node with its action type so subsequent opens can compare
		var insertedNode = document.querySelector('.inline-add-box');
		if (insertedNode) try { insertedNode.dataset.type = actionType; } catch(e) {}
		// wire cancel and submit similar to garage
		var node = document.querySelector('.inline-add-box');
		if (!node) return;
		var cancel = node.querySelector('.inline-cancel'); if (cancel) cancel.addEventListener('click', function(){ node.remove(); });
		var form = node.querySelector('form');
		if (form) {
			form.addEventListener('submit', function(e){
				e.preventDefault();
				if (form.dataset.submitting === '1') return;
				form.dataset.submitting = '1';
				var fd = new FormData(form);
				postForm(form.getAttribute('action')||window.location.href, fd, { expect: 'raw' })
				.then(function(resp){ if (!resp.ok) throw new Error('Errore: ' + resp.status); return postForm(window.location.href, null, { method: 'GET', expect: 'raw' }); })
				.then(function(r){ if (!r.ok) throw new Error('Errore refresh: ' + r.status); return r.text(); })
				.then(function(html){ var parser=new DOMParser(); var doc=parser.parseFromString(html,'text/html');
					var newContent = doc.querySelector('.container-fluid'); var old = document.querySelector('.container-fluid'); if (newContent && old) old.replaceWith(newContent);
					try { node.remove(); } catch(e){}
					form.dataset.submitting = '0';
				}).catch(function(err){ form.dataset.submitting = '0'; try{ showToast && showToast('Errore: ' + err.message, 'danger'); }catch(e){} });
			});
		}
	} catch(e) {}
}, false);


</script>


{% endblock %}

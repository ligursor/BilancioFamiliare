{% extends "base.html" %}

{% block title %}{{ veicolo.nome_completo }} - Dettaglio{% endblock %}

{% block content %}
<style>
  .equal-height {
	min-height: 100%;
	display: flex;
	flex-direction: column;
  }
  .card.equal-height {
	flex: 1 1 auto;
  }
</style>
<div class="container-fluid mt-4">
	<div class="row">
		<div class="col-lg-12">
			<div class="d-flex justify-content-between align-items-center mb-4">
				<h2><i class="fas fa-car me-2"></i>{{ veicolo.nome_completo }}</h2>
				<div>
					<a href="{{ url_for('veicoli.garage') }}" class="btn btn-secondary me-2">
						<i class="fas fa-arrow-left me-1"></i>Garage
					</a>
					<!-- Modifica button removed per richiesta -->
					<form method="POST" action="{{ url_for('veicoli.rimuovi_veicolo', veicolo_id=veicolo.id) }}" style="display:inline-block;">
						<button type="submit" class="btn btn-danger ms-2" onclick="return confirm('Confermi la rimozione del veicolo dal garage?');">
							<i class="fas fa-trash me-1"></i>Rimuovi
						</button>
					</form>
				</div>
			</div>
		</div>
	</div>

	<!-- Informazioni veicolo + Situazione Finanziaria affiancate -->
	<div class="row mb-4" style="min-height: 1px;">
		<div class="col-md-6 equal-height">
			<div class="card equal-height">
				<div class="card-header">
					<h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informazioni Veicolo</h5>
				</div>
				<div class="card-body">
					<div class="row">
						<div class="col-md-6">
							<p><strong>Modello:</strong> {{ veicolo.modello }}</p>
							{%- if veicolo.tipo != 'bici' and veicolo.mese_scadenza_bollo %}
							<p><strong>Scadenza Bollo:</strong> 
								{% set mesi = ['', 'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'] %}
								{{ mesi[veicolo.mese_scadenza_bollo] }}
							</p>
							{% endif %}
						</div>
						<div class="col-md-6">
							{% if veicolo.prima_rata %}
							<p><strong>Prima Rata:</strong> {{ veicolo.prima_rata.strftime('%d/%m/%Y') }}</p>
							{% endif %}
							{% if veicolo.numero_rate %}
							<p><strong>Numero Rate:</strong> {{ veicolo.numero_rate }}</p>
							{% endif %}
							{% if veicolo.rata_mensile %}
							<p><strong>Rata Mensile:</strong> {{ (veicolo.rata_mensile or 0) | format_currency }}</p>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-6 equal-height">
			<div class="card equal-height">
				<div class="card-header">
					<h5 class="mb-0"><i class="fas fa-euro-sign me-2"></i>Situazione Finanziaria</h5>
				</div>
				<div class="card-body">
					<div class="row mb-3">
						<div class="col-6 d-flex align-items-center">
							<span class="fw-bold me-2">Costo Finanziamento:</span>
							<span>{{ (veicolo.costo_finanziamento or 0) | format_currency }}</span>
						</div>
						<div class="col-6 d-flex align-items-center">
							<span class="fw-bold me-2">Totale Versato:</span>
							<span>{{ (veicolo.totale_versato or 0) | format_currency }}</span>
						</div>
					</div>
					<div class="row mb-3">
						<div class="col-6 d-flex align-items-center">
							<span class="fw-bold me-2">Saldo Rimanente:</span>
							{% if (veicolo.saldo_rimanente or 0) > 0 %}
								<span class="text-warning">{{ (veicolo.saldo_rimanente or 0) | format_currency }}</span>
							{% else %}
								<span class="text-success">{{ (0) | format_currency }}</span>
							{% endif %}
						</div>
						<div class="col-6 d-flex align-items-center">
							<span class="fw-bold me-2">Rate Rimanenti:</span>
							<span>{{ veicolo.rate_rimanenti if veicolo.rate_rimanenti else '-' }}</span>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Statistiche costi -->
	<div class="row mb-4">
		{%- set has_bolli = (veicolo.tipo != 'bici') %}
		{%- if has_bolli %}
		<div class="col-md-4">
			<div class="card bg-info text-white">
				<div class="card-body">
					<div class="d-flex justify-content-between">
						<div>
							<h4 class="card-title">{{ (totale_bolli or 0) | format_currency }}</h4>
							<p class="card-text">Totale Bolli</p>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card bg-warning text-white">
				<div class="card-body">
					<div class="d-flex justify-content-between">
						<div>
							<h4 class="card-title">{{ (totale_manutenzioni or 0) | format_currency }}</h4>
							<p class="card-text">Totale Manutenzioni</p>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card bg-danger text-white">
				<div class="card-body">
					<div class="d-flex justify-content-between">
						<div>
							<h4 class="card-title">{{ (costo_totale or 0) | format_currency }}</h4>
							<p class="card-text">Costo Totale</p>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- Totale Costi box removed; keep 'Costo Totale' only -->
		{%- else %}
		<div class="col-md-4">
			<div class="card bg-warning text-white">
				<div class="card-body">
					<div class="d-flex justify-content-between">
						<div>
							<h4 class="card-title">{{ (totale_manutenzioni or 0) | format_currency }}</h4>
							<p class="card-text">Totale Manutenzioni</p>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card bg-danger text-white">
				<div class="card-body">
					<div class="d-flex justify-content-between">
						<div>
							<h4 class="card-title">{{ (costo_totale or 0) | format_currency }}</h4>
							<p class="card-text">Costo Totale</p>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- Totale Costi box removed; keep 'Costo Totale' only -->
		{%- endif %}
	</div>

	<!-- Azioni rapide rimosse: il pulsante Rimuovi è stato spostato in alto accanto a Modifica -->

	<!-- Storico operazioni -->
	<div class="row">
		{%- if veicolo.tipo != 'bici' %}
		<!-- Bolli -->
		<div class="col-md-6">
			<div class="card">
				<div class="card-header">
					<h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Bolli Pagati</h5>
				</div>
				<div class="card-body">
					{% if bolli %}
					<div class="table-responsive">
						<table class="table table-striped table-sm det-mese-table">
							<thead>
								<tr>
									<th class="text-center">Anno</th>
									<th class="text-center">Data Pagamento</th>
									<th class="text-center">Importo</th>
								</tr>
							</thead>
							<tbody>
								{% for bollo in bolli %}
								<tr>
									<td class="text-center">{{ bollo.anno_riferimento }}</td>
									<td class="text-center">{{ bollo.data_pagamento.strftime('%d/%m/%Y') }}</td>
									<td class="text-center">{{ (bollo.importo or 0) | format_currency }}</td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
					{% else %}
					<p class="text-muted text-center">Nessun bollo registrato</p>
					{% endif %}
				</div>
			</div>
		</div>
		{%- endif %}

		<!-- Manutenzioni -->
		<div class="{% if veicolo.tipo != 'bici' %}col-md-6{% else %}col-md-12{% endif %}">
			<div class="card">
				<div class="card-header">
					<h5 class="mb-0"><i class="fas fa-wrench me-2"></i>Manutenzioni</h5>
				</div>
				<div class="card-body">
					{% if manutenzioni %}
					<div class="table-responsive">
						<table class="table table-striped table-sm det-mese-table">
							<thead>
								<tr>
									<th class="text-center">Tipo</th>
									<th class="text-center">Data</th>
									<th class="text-center">KM</th>
									<th class="text-center">Costo</th>
								</tr>
							</thead>
							<tbody>
								{% for manutenzione in manutenzioni %}
								<tr>
									<td class="text-start">
										<span data-bs-toggle="tooltip" title="{{ manutenzione.dettaglio if manutenzione.dettaglio else '' }}">
											{{ manutenzione.tipo_intervento }}
										</span>
									</td>
									<td class="text-center">{{ manutenzione.data_intervento.strftime('%d/%m/%Y') }}</td>
									<td class="text-center">{{ "{:,}".format(manutenzione.km_intervento).replace(',', '.') }}</td>
									<td class="text-center">{{ (manutenzione.costo or 0) | format_currency }}</td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
					{% else %}
					<p class="text-muted text-center">Nessuna manutenzione registrata</p>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Modifica modal removed -->

<!-- Modal Nuovo Bollo -->
<div class="modal fade" id="modalNuovoBollo" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title"><i class="fas fa-receipt me-2"></i>Nuovo Bollo Auto</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<form method="POST" action="{{ url_for('veicoli.aggiungi_bollo') }}">
				<input type="hidden" name="veicolo_id" value="{{ veicolo.id }}">
				<input type="hidden" name="redirect_to_veicolo" value="1">
				<div class="modal-body">
					<div class="mb-3">
						<label for="anno_riferimento" class="form-label">Anno di Riferimento *</label>
						<input type="number" class="form-control" id="anno_riferimento" name="anno_riferimento" min="2000" max="2030" value="{{ datetime.now().year }}" required>
					</div>
					<div class="mb-3">
						<label for="data_pagamento" class="form-label">Data Pagamento *</label>
						<input type="date" class="form-control" id="data_pagamento" name="data_pagamento" value="{{ datetime.now().strftime('%Y-%m-%d') }}" required>
					</div>
					<div class="mb-3">
						<label for="importo" class="form-label">Importo (€) *</label>
						<input type="number" class="form-control" id="importo" name="importo" step="0.01" min="0" required>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
					<button type="submit" class="btn btn-success">Aggiungi Bollo</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Modal Nuova Manutenzione -->
<div class="modal fade" id="modalNuovaManutenzione" tabindex="-1">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title"><i class="fas fa-wrench me-2"></i>Nuova Manutenzione</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<form method="POST" action="{{ url_for('veicoli.aggiungi_manutenzione') }}">
				<input type="hidden" name="veicolo_id" value="{{ veicolo.id }}">
				<input type="hidden" name="redirect_to_veicolo" value="1">
				<div class="modal-body">
					<div class="row">
						<div class="col-md-6">
							<div class="mb-3">
								<label for="data_intervento" class="form-label">Data Intervento *</label>
								<input type="date" class="form-control" id="data_intervento" name="data_intervento" value="{{ datetime.now().strftime('%Y-%m-%d') }}" required>
							</div>
						</div>
						<div class="col-md-6">
							<div class="mb-3">
								<label for="km_intervento" class="form-label">KM Intervento *</label>
								<input type="number" class="form-control" id="km_intervento" name="km_intervento" min="0" required>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-md-6">
							<div class="mb-3">
								<label for="officina" class="form-label">Officina *</label>
								<input type="text" class="form-control" id="officina" name="officina" required>
							</div>
						</div>
						<div class="col-md-6">
							<div class="mb-3">
								<label for="tipo_intervento" class="form-label">Tipo Intervento *</label>
								<input type="text" class="form-control" id="tipo_intervento" name="tipo_intervento" required>
							</div>
						</div>
					</div>
					<div class="mb-3">
						<label for="costo" class="form-label">Costo (€) *</label>
						<input type="number" class="form-control" id="costo" name="costo" step="0.01" min="0" required>
					</div>
					<div class="mb-3">
						<label for="dettaglio" class="form-label">Dettaglio Intervento</label>
						<textarea class="form-control" id="dettaglio" name="dettaglio" rows="3"></textarea>
					</div>
					<div class="row">
						<div class="col-md-6">
							<div class="mb-3">
								<label for="prossimo_controllo_km" class="form-label">Prossimo Controllo KM</label>
								<input type="number" class="form-control" id="prossimo_controllo_km" name="prossimo_controllo_km" min="0">
							</div>
						</div>
						<div class="col-md-6">
							<div class="mb-3">
								<label for="prossimo_controllo_data" class="form-label">Prossimo Controllo Data</label>
								<input type="date" class="form-control" id="prossimo_controllo_data" name="prossimo_controllo_data">
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
					<button type="submit" class="btn btn-success">Aggiungi Manutenzione</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Modal Elimina Veicolo -->
<div class="modal fade" id="modalEliminaVeicolo" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title text-danger"><i class="fas fa-trash me-2"></i>Rimuovi Veicolo</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<div class="alert alert-warning">
					<i class="fas fa-exclamation-triangle me-2"></i>
					Sei sicuro di voler rimuovere <strong>{{ veicolo.nome_completo }}</strong> dal garage?
				</div>
				<p>Il veicolo verrà rimosso dalla vista ma tutti i dati storici (bolli e manutenzioni) saranno conservati.</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
				<form method="POST" action="{{ url_for('veicoli.rimuovi_veicolo', veicolo_id=veicolo.id) }}" style="display: inline;">
					<button type="submit" class="btn btn-danger">Rimuovi dal Garage</button>
				</form>
			</div>
		</div>
	</div>
</div>

{% endblock %}

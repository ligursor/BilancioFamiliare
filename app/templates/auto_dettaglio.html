{% extends "base.html" %}

{% block title %}{{ veicolo.nome_completo }} - Dettaglio{% endblock %}

{% block content %}
<style>
  .equal-height {
    min-height: 100%;
    display: flex;
    flex-direction: column;
  }
  .card.equal-height {
    flex: 1 1 auto;
  }
</style>
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-lg-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-car me-2"></i>{{ veicolo.nome_completo }}</h2>
                <div>
                    <a href="{{ url_for('auto.garage') }}" class="btn btn-secondary me-2">
                        <i class="fas fa-arrow-left me-1"></i>Garage
                    </a>
                    <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalModificaVeicolo">
                        <i class="fas fa-edit me-1"></i>Modifica
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Informazioni veicolo + Situazione Finanziaria affiancate -->
    <div class="row mb-4" style="min-height: 1px;">
        <div class="col-md-6 equal-height">
            <div class="card equal-height">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informazioni Veicolo</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Marca:</strong> {{ veicolo.marca }}</p>
                            <p><strong>Modello:</strong> {{ veicolo.modello }}</p>
                            {% if veicolo.mese_scadenza_bollo %}
                            <p><strong>Scadenza Bollo:</strong> 
                                {% set mesi = ['', 'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'] %}
                                {{ mesi[veicolo.mese_scadenza_bollo] }}
                            </p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {% if veicolo.prima_rata %}
                            <p><strong>Prima Rata:</strong> {{ veicolo.prima_rata.strftime('%d/%m/%Y') }}</p>
                            {% endif %}
                            {% if veicolo.numero_rate %}
                            <p><strong>Numero Rate:</strong> {{ veicolo.numero_rate }}</p>
                            {% endif %}
                            {% if veicolo.rata_mensile %}
                            <p><strong>Rata Mensile:</strong> {{ formato_valuta.format(veicolo.rata_mensile or 0) }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 equal-height">
            <div class="card equal-height">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-euro-sign me-2"></i>Situazione Finanziaria</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-6 d-flex align-items-center">
                            <span class="fw-bold me-2">Costo Finanziamento:</span>
                            <span>{{ formato_valuta.format(veicolo.costo_finanziamento or 0) }}</span>
                        </div>
                        <div class="col-6 d-flex align-items-center">
                            <span class="fw-bold me-2">Totale Versato:</span>
                            <span>{{ formato_valuta.format(veicolo.totale_versato or 0) }}</span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6 d-flex align-items-center">
                            <span class="fw-bold me-2">Saldo Rimanente:</span>
                            {% if (veicolo.saldo_rimanente or 0) > 0 %}
                                <span class="text-warning">{{ formato_valuta.format(veicolo.saldo_rimanente or 0) }}</span>
                            {% else %}
                                <span class="text-success">{{ formato_valuta.format(0) }}</span>
                            {% endif %}
                        </div>
                        <div class="col-6 d-flex align-items-center">
                            <span class="fw-bold me-2">Rate Rimanenti:</span>
                            <span>{{ veicolo.rate_rimanenti if veicolo.rate_rimanenti else '-' }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiche costi -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-info text-center">
                <div class="card-body">
                    <h5 class="card-title text-info">Totale Bolli</h5>
                    <h4 class="text-info">{{ formato_valuta.format(totale_bolli or 0) }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning text-center">
                <div class="card-body">
                    <h5 class="card-title text-warning">Totale Manutenzioni</h5>
                    <h4 class="text-warning">{{ formato_valuta.format(totale_manutenzioni or 0) }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-danger text-center">
                <div class="card-body">
                    <h5 class="card-title text-danger">Costo Totale</h5>
                    <h4 class="text-danger">{{ formato_valuta.format(costo_totale or 0) }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success text-center">
                <div class="card-body">
                    <h5 class="card-title text-success">Totale Costi</h5>
                    <h4 class="text-success">{{ formato_valuta.format(costo_totale or 0) }}</h4>
                    <small class="text-muted">Finanziamento + Bolli + Manutenzioni</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Azioni rapide -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-plus me-2"></i>Azioni Rapide</h5>
                </div>
                <div class="card-body">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#modalNuovoBollo">
                            <i class="fas fa-receipt me-1"></i>Aggiungi Bollo
                        </button>
                        <button type="button" class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#modalNuovaManutenzione">
                            <i class="fas fa-wrench me-1"></i>Aggiungi Manutenzione
                        </button>
                        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalEliminaVeicolo">
                            <i class="fas fa-trash me-1"></i>Rimuovi dal Garage
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Storico operazioni -->
    <div class="row">
        <!-- Bolli -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Storico Bolli</h5>
                </div>
                <div class="card-body">
                    {% if bolli %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Anno</th>
                                    <th>Data Pagamento</th>
                                    <th>Importo</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bollo in bolli %}
                                <tr>
                                    <td>{{ bollo.anno_riferimento }}</td>
                                    <td>{{ bollo.data_pagamento.strftime('%d/%m/%Y') }}</td>
                                    <td>{{ formato_valuta.format(bollo.importo or 0) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center">Nessun bollo registrato</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Manutenzioni -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-wrench me-2"></i>Storico Manutenzioni</h5>
                </div>
                <div class="card-body">
                    {% if manutenzioni %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>KM</th>
                                    <th>Tipo</th>
                                    <th>Costo</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for manutenzione in manutenzioni %}
                                <tr>
                                    <td>{{ manutenzione.data_intervento.strftime('%d/%m/%Y') }}</td>
                                    <td>{{ "{:,}".format(manutenzione.km_intervento).replace(',', '.') }}</td>
                                    <td>
                                        <span data-bs-toggle="tooltip" title="{{ manutenzione.dettaglio if manutenzione.dettaglio else '' }}">
                                            {{ manutenzione.tipo_intervento }}
                                        </span>
                                    </td>
                                    <td>{{ formato_valuta.format(manutenzione.costo or 0) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center">Nessuna manutenzione registrata</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Modifica Veicolo -->
<div class="modal fade" id="modalModificaVeicolo" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Modifica Veicolo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('auto.modifica_veicolo', veicolo_id=veicolo.id) }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="marca" class="form-label">Marca *</label>
                                <input type="text" class="form-control" id="marca" name="marca" value="{{ veicolo.marca }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modello" class="form-label">Modello *</label>
                                <input type="text" class="form-control" id="modello" name="modello" value="{{ veicolo.modello }}" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="mese_scadenza_bollo" class="form-label">Mese Scadenza Bollo</label>
                                <select class="form-control" id="mese_scadenza_bollo" name="mese_scadenza_bollo">
                                    <option value="">-- Seleziona mese --</option>
                                    {% for i in range(1, 13) %}
                                    {% set mesi = ['', 'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'] %}
                                    <option value="{{ i }}" {% if veicolo.mese_scadenza_bollo == i %}selected{% endif %}>{{ mesi[i] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="costo_finanziamento" class="form-label">Costo Finanziamento (€)</label>
                                <input type="number" class="form-control" id="costo_finanziamento" name="costo_finanziamento" value="{{ veicolo.costo_finanziamento if veicolo.costo_finanziamento else '' }}" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="prima_rata" class="form-label">Prima Rata</label>
                                <input type="date" class="form-control" id="prima_rata" name="prima_rata" value="{{ veicolo.prima_rata.strftime('%Y-%m-%d') if veicolo.prima_rata else '' }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="numero_rate" class="form-label">Numero Rate</label>
                                <input type="number" class="form-control" id="numero_rate" name="numero_rate" value="{{ veicolo.numero_rate if veicolo.numero_rate else '' }}" min="1">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="rata_mensile" class="form-label">Rata Mensile (€)</label>
                                <input type="number" class="form-control" id="rata_mensile" name="rata_mensile" value="{{ veicolo.rata_mensile if veicolo.rata_mensile else '' }}" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-warning">Salva Modifiche</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Nuovo Bollo -->
<div class="modal fade" id="modalNuovoBollo" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-receipt me-2"></i>Nuovo Bollo Auto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('auto.aggiungi_bollo') }}">
                <input type="hidden" name="veicolo_id" value="{{ veicolo.id }}">
                <input type="hidden" name="redirect_to_veicolo" value="1">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="anno_riferimento" class="form-label">Anno di Riferimento *</label>
                        <input type="number" class="form-control" id="anno_riferimento" name="anno_riferimento" min="2000" max="2030" value="{{ datetime.now().year }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="data_pagamento" class="form-label">Data Pagamento *</label>
                        <input type="date" class="form-control" id="data_pagamento" name="data_pagamento" value="{{ datetime.now().strftime('%Y-%m-%d') }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="importo" class="form-label">Importo (€) *</label>
                        <input type="number" class="form-control" id="importo" name="importo" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-success">Aggiungi Bollo</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Nuova Manutenzione -->
<div class="modal fade" id="modalNuovaManutenzione" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-wrench me-2"></i>Nuova Manutenzione</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('auto.aggiungi_manutenzione') }}">
                <input type="hidden" name="veicolo_id" value="{{ veicolo.id }}">
                <input type="hidden" name="redirect_to_veicolo" value="1">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_intervento" class="form-label">Data Intervento *</label>
                                <input type="date" class="form-control" id="data_intervento" name="data_intervento" value="{{ datetime.now().strftime('%Y-%m-%d') }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="km_intervento" class="form-label">KM Intervento *</label>
                                <input type="number" class="form-control" id="km_intervento" name="km_intervento" min="0" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="officina" class="form-label">Officina *</label>
                                <input type="text" class="form-control" id="officina" name="officina" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tipo_intervento" class="form-label">Tipo Intervento *</label>
                                <input type="text" class="form-control" id="tipo_intervento" name="tipo_intervento" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="costo" class="form-label">Costo (€) *</label>
                        <input type="number" class="form-control" id="costo" name="costo" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="dettaglio" class="form-label">Dettaglio Intervento</label>
                        <textarea class="form-control" id="dettaglio" name="dettaglio" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="prossimo_controllo_km" class="form-label">Prossimo Controllo KM</label>
                                <input type="number" class="form-control" id="prossimo_controllo_km" name="prossimo_controllo_km" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="prossimo_controllo_data" class="form-label">Prossimo Controllo Data</label>
                                <input type="date" class="form-control" id="prossimo_controllo_data" name="prossimo_controllo_data">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-success">Aggiungi Manutenzione</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Elimina Veicolo -->
<div class="modal fade" id="modalEliminaVeicolo" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger"><i class="fas fa-trash me-2"></i>Rimuovi Veicolo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Sei sicuro di voler rimuovere <strong>{{ veicolo.nome_completo }}</strong> dal garage?
                </div>
                <p>Il veicolo verrà rimosso dalla vista ma tutti i dati storici (bolli e manutenzioni) saranno conservati.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <form method="POST" action="{{ url_for('auto.rimuovi_veicolo', veicolo_id=veicolo.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Rimuovi dal Garage</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Abilita i tooltips
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
})
</script>

{% endblock %}

{% extends "base.html" %}

{% block title %}Nuovo Piano PayPal{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-plus me-2"></i>Nuovo Piano PayPal</h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="mb-3">
                        <label for="descrizione" class="form-label">Descrizione</label>
                        <input type="text" class="form-control" id="descrizione" name="descrizione" required 
                               placeholder="Es. iPhone 15, TV Samsung, etc." style="text-transform: uppercase;">
                    </div>
                    
                    <div class="mb-3">
                        <label for="importo_totale" class="form-label">Importo Totale (€)</label>
                        <input type="number" class="form-control" id="importo_totale" name="importo_totale" 
                               step="0.01" min="0" required placeholder="0.00">
                        <div class="form-text">L'importo verrà automaticamente diviso in 3 rate uguali</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="data_prima_rata" class="form-label">Data Prima Rata</label>
                        <input type="date" class="form-control" id="data_prima_rata" name="data_prima_rata" required>
                        <div class="form-text">Le successive rate saranno calcolate automaticamente (+30 e +60 giorni)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="note" class="form-label">Note (opzionale)</label>
                        <textarea class="form-control" id="note" name="note" rows="3" 
                                  placeholder="Note aggiuntive sul piano di pagamento..."></textarea>
                    </div>
                    
                    <!-- Anteprima calcoli -->
                    <div class="card bg-light mb-3" id="anteprima" style="display: none;">
                        <div class="card-header">
                            <h6 class="mb-0">Anteprima Piano</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Importo per rata:</strong> €<span id="importo_rata">0.00</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Eventuale resto:</strong> €<span id="resto">0.00</span>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-4">
                                    <strong>Prima rata:</strong> <span id="data_rata1">-</span>
                                </div>
                                <div class="col-md-4">
                                    <strong>Seconda rata:</strong> <span id="data_rata2">-</span>
                                </div>
                                <div class="col-md-4">
                                    <strong>Terza rata:</strong> <span id="data_rata3">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('paypal.dashboard') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Annulla
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Crea Piano
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function aggiornaAnteprima() {
    const importoTotale = parseFloat(document.getElementById('importo_totale').value) || 0;
    const dataPrimaRata = document.getElementById('data_prima_rata').value;
    
    if (importoTotale > 0) {
        const importoRata = Math.round(importoTotale / 3 * 100) / 100;
        const resto = importoTotale - (importoRata * 3);
        
        document.getElementById('importo_rata').textContent = importoRata.toFixed(2);
        document.getElementById('resto').textContent = Math.abs(resto).toFixed(2);
        
        if (dataPrimaRata) {
            const data1 = new Date(dataPrimaRata);
            const data2 = new Date(data1);
            data2.setDate(data1.getDate() + 30);
            const data3 = new Date(data1);
            data3.setDate(data1.getDate() + 60);
            
            document.getElementById('data_rata1').textContent = data1.toLocaleDateString('it-IT');
            document.getElementById('data_rata2').textContent = data2.toLocaleDateString('it-IT');
            document.getElementById('data_rata3').textContent = data3.toLocaleDateString('it-IT');
        }
        
        document.getElementById('anteprima').style.display = 'block';
    } else {
        document.getElementById('anteprima').style.display = 'none';
    }
}

document.getElementById('importo_totale').addEventListener('input', aggiornaAnteprima);
document.getElementById('data_prima_rata').addEventListener('change', aggiornaAnteprima);

// Imposta data di oggi come default
document.getElementById('data_prima_rata').value = new Date().toISOString().split('T')[0];
aggiornaAnteprima();
</script>
{% endblock %}

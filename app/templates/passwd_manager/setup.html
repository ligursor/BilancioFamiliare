<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurazione Database - Password Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            color: #343a40;
        }
        .setup-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .setup-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        .setup-body {
            padding: 2rem;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 0.75rem 2rem;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
        }
        .file-upload {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .file-upload:hover {
            border-color: #667eea;
            background-color: rgba(102, 126, 234, 0.05);
        }
        .file-upload.dragover {
            border-color: #667eea;
            background-color: rgba(102, 126, 234, 0.1);
        }
        .password-strength {
            margin-top: 0.5rem;
        }
        .strength-bar {
            height: 4px;
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        .password-section-hidden {
            opacity: 0.3;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .same-password-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 1px solid #81d4fa;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="setup-card">
                    <div class="setup-header">
                        <i class="fas fa-database fa-3x mb-3"></i>
                        <h2>Configurazione Database</h2>
                        <p class="mb-0">Configura o riconfigura il tuo password manager sicuro</p>
                    </div>
                    
                    <div class="setup-body">
                        {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                                {% for category, message in messages %}
                                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        {% endwith %}
                        
                        <form method="POST" enctype="multipart/form-data" id="setupForm">
                            <!-- Sezione password amministratore -->
                            <div class="mb-4">
                                <h5><i class="fas fa-lock text-danger me-2"></i>Autenticazione Amministratore</h5>
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Attenzione:</strong> La riconfigurazione del database richiede privilegi di amministratore.
                                </div>
                                <label for="admin_password" class="form-label">
                                    <i class="fas fa-user-shield text-danger me-1"></i>Password Amministratore
                                </label>
                                <input type="password" class="form-control" id="admin_password" name="admin_password" 
                                       placeholder="Inserisci password amministratore" required>
                            </div>
                            
                            <div class="mb-4">
                                <h5><i class="fas fa-file-excel text-success me-2"></i>File Excel</h5>
                                <div class="file-upload" id="fileUpload">
                                    <i class="fas fa-file-excel fa-2x text-success mb-2"></i>
                                    <p class="mb-2">Trascina qui il file Excel o clicca per selezionare</p>
                                    <input type="file" name="excel_file" id="excelFile" accept=".xlsx" required style="display: none;">
                                    <small class="text-muted">File Excel (.xlsx) contenente le credenziali da importare</small>
                                    <div id="fileName" class="mt-2 fw-bold text-success" style="display: none;"></div>
                                </div>
                            </div>
                            
                            <!-- Sezione password per file Excel protetti -->
                            <div class="mb-4" id="excelPasswordSection" style="display: none;">
                                <h6><i class="fas fa-lock text-warning me-2"></i>File Excel Protetto</h6>
                                <label for="excel_password" class="form-label">
                                    <i class="fas fa-key text-warning me-1"></i>Password del File Excel
                                </label>
                                <input type="password" class="form-control" id="excel_password" name="excel_password" 
                                       placeholder="Inserisci password del file Excel (se protetto)">
                                <small class="text-muted">Lascia vuoto se il file non è protetto da password</small>
                                
                                <!-- Flag per usare la stessa password come master -->
                                <div class="form-check mt-3" id="useSamePasswordSection" style="display: none;">
                                    <input class="form-check-input" type="checkbox" id="useSamePassword" name="use_same_password">
                                    <label class="form-check-label" for="useSamePassword">
                                        <i class="fas fa-magic text-primary me-1"></i>
                                        <strong>Usa la stessa password come Password Master</strong>
                                    </label>
                                    <div class="form-text text-info">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Se selezionato, la password del file Excel verrà utilizzata anche come Password Master, 
                                        rendendo superflua l'inserimento nei campi sottostanti.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="password" class="form-label">
                                        <i class="fas fa-lock text-primary me-1"></i>Password Master
                                    </label>
                                    <input type="password" class="form-control" id="password" name="password" 
                                           placeholder="Inserisci password" required minlength="6">
                                    <div class="password-strength">
                                        <div class="strength-bar bg-light" id="strengthBar"></div>
                                        <small id="strengthText" class="text-muted">Minimo 6 caratteri</small>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="confirm_password" class="form-label">
                                        <i class="fas fa-lock text-primary me-1"></i>Conferma Password
                                    </label>
                                    <input type="password" class="form-control" id="confirm_password" name="confirm_password" 
                                           placeholder="Conferma password" required minlength="6">
                                    <div id="passwordMatch" class="mt-1"></div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Importante:</strong> La password master sarà usata per cifrare tutti i dati. 
                                Assicurati di ricordarla, non sarà possibile recuperarla!
                                <br><br>
                                <strong>Nota:</strong> Se esiste già un database, verrà creato automaticamente un backup 
                                prima di sovrascriverlo con i nuovi dati dal file Excel.
                                <br><br>
                                <strong>Sicurezza:</strong> Solo i campi PASSWORD e ALTRO verranno cifrati, mentre 
                                CATEGORIA, SERVIZIO e UTENZA rimarranno in chiaro per le ricerche.
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                                    <i class="fas fa-cog me-2"></i>Configura Database
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Gestione upload file
        const fileUpload = document.getElementById('fileUpload');
        const excelFile = document.getElementById('excelFile');
        const fileName = document.getElementById('fileName');
        const excelPasswordSection = document.getElementById('excelPasswordSection');
        
        fileUpload.addEventListener('click', () => excelFile.click());
        
        fileUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUpload.classList.add('dragover');
        });
        
        fileUpload.addEventListener('dragleave', () => {
            fileUpload.classList.remove('dragover');
        });
        
        fileUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUpload.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.xlsx')) {
                excelFile.files = files;
                showFileName(files[0].name);
            }
        });
        
        excelFile.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                showFileName(e.target.files[0].name);
            }
        });
        
        function showFileName(name) {
            fileName.textContent = '✓ ' + name;
            fileName.style.display = 'block';
            excelPasswordSection.style.display = 'block';
            checkFormValid();
        }
        
        // Gestione password Excel e flag "usa stessa password"
        const excelPasswordInput = document.getElementById('excel_password');
        const useSamePasswordCheckbox = document.getElementById('useSamePassword');
        const useSamePasswordSection = document.getElementById('useSamePasswordSection');
        const passwordSection = document.querySelector('.row'); // Sezione con i campi password
        
        excelPasswordInput.addEventListener('input', function() {
            const hasPassword = excelPasswordInput.value.trim().length > 0;
            useSamePasswordSection.style.display = hasPassword ? 'block' : 'none';
            
            if (!hasPassword) {
                // Se non c'è password Excel, deseleziona il flag e ripristina i campi normali
                useSamePasswordCheckbox.checked = false;
                togglePasswordFields(false);
            }
            checkFormValid();
        });
        
        useSamePasswordCheckbox.addEventListener('change', function() {
            togglePasswordFields(useSamePasswordCheckbox.checked);
            checkFormValid();
        });
        
        function togglePasswordFields(useSamePassword) {
            const passwordField = document.getElementById('password');
            const confirmPasswordField = document.getElementById('confirm_password');
            const passwordRow = passwordField.closest('.row'); // Solo la row dei campi password
            
            if (useSamePassword) {
                // Nasconde solo i campi password master
                passwordRow.style.display = 'none';
                passwordField.value = excelPasswordInput.value;
                confirmPasswordField.value = excelPasswordInput.value;
                passwordField.removeAttribute('required');
                confirmPasswordField.removeAttribute('required');
                
            } else {
                // Ripristina i campi password master
                passwordRow.style.display = '';
                passwordField.value = '';
                confirmPasswordField.value = '';
                passwordField.setAttribute('required', '');
                confirmPasswordField.setAttribute('required', '');
                
                // Rimuove il messaggio informativo
                const infoDiv = document.getElementById('samePasswordInfo');
                if (infoDiv) {
                    infoDiv.remove();
                }
            }
        }
        
        // Validazione password
        const password = document.getElementById('password');
        const confirmPassword = document.getElementById('confirm_password');
        const adminPassword = document.getElementById('admin_password');
        const strengthBar = document.getElementById('strengthBar');
        const strengthText = document.getElementById('strengthText');
        const passwordMatch = document.getElementById('passwordMatch');
        const submitBtn = document.getElementById('submitBtn');
        
        password.addEventListener('input', checkPasswordStrength);
        confirmPassword.addEventListener('input', checkPasswordMatch);
        adminPassword.addEventListener('input', checkFormValid);
        
        // Listener per sincronizzare la password Excel con i campi master quando il flag è attivo
        excelPasswordInput.addEventListener('input', function() {
            if (useSamePasswordCheckbox.checked) {
                password.value = excelPasswordInput.value;
                confirmPassword.value = excelPasswordInput.value;
                checkPasswordStrength();
                checkPasswordMatch();
            }
        });
        
        function checkPasswordStrength() {
            const value = password.value;
            let strength = 0;
            let text = '';
            let color = '';
            
            if (value.length >= 6) strength += 25;
            if (value.length >= 8) strength += 25;
            if (/[A-Z]/.test(value)) strength += 25;
            if (/[0-9]/.test(value) || /[^A-Za-z0-9]/.test(value)) strength += 25;
            
            if (strength < 25) {
                text = 'Troppo debole';
                color = 'bg-danger';
            } else if (strength < 50) {
                text = 'Debole';
                color = 'bg-warning';
            } else if (strength < 75) {
                text = 'Buona';
                color = 'bg-info';
            } else {
                text = 'Forte';
                color = 'bg-success';
            }
            
            strengthBar.style.width = strength + '%';
            strengthBar.className = 'strength-bar ' + color;
            strengthText.textContent = text;
            
            checkPasswordMatch();
            checkFormValid();
        }
        
        function checkPasswordMatch() {
            if (confirmPassword.value === '') {
                passwordMatch.innerHTML = '';
                return;
            }
            
            if (password.value === confirmPassword.value) {
                passwordMatch.innerHTML = '<small class="text-success"><i class="fas fa-check"></i> Password corrispondono</small>';
            } else {
                passwordMatch.innerHTML = '<small class="text-danger"><i class="fas fa-times"></i> Password non corrispondono</small>';
            }
            
            checkFormValid();
        }
        
        function checkFormValid() {
            const adminPasswordValid = document.getElementById('admin_password').value.length > 0;
            const fileSelected = excelFile.files.length > 0;
            const useSamePassword = useSamePasswordCheckbox.checked;
            
            let passwordValid = false;
            let passwordsMatch = false;
            
            if (useSamePassword) {
                // Se usa la stessa password, verifica che la password Excel sia valida
                const excelPasswordValid = excelPasswordInput.value.length >= 6;
                passwordValid = excelPasswordValid;
                passwordsMatch = excelPasswordValid;
            } else {
                // Validazione normale dei campi password master
                passwordValid = password.value.length >= 6;
                passwordsMatch = password.value === confirmPassword.value && confirmPassword.value !== '';
            }
            
            submitBtn.disabled = !(adminPasswordValid && fileSelected && passwordValid && passwordsMatch);
        }
        
        // Feedback form submission
        document.getElementById('setupForm').addEventListener('submit', function() {
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Configurazione in corso...';
            submitBtn.disabled = true;
        });
    </script>
</body>
</html>

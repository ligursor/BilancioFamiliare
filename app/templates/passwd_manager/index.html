{%- extends 'base.html' -%}

{%- block title -%}Password Manager{%- endblock -%}

{%- block content -%}
    <!-- PWA manifest (kept here for compatibility with the original UI) -->
    <link rel="manifest" href="/passwd/manifest.json">

    <!-- Note: runtime URL prefix shim removed. Client-side calls must target the blueprint-mounted paths directly (e.g. /passwd/api/...) -->

    <!-- styles moved to static/css/templates.css -->

    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <!-- Contenuto organizzato per categoria -->
                <div id="categoryContent">
                    <!-- Search bar: cerca per servizio o categoria -->
                    <div class="row mb-3" id="searchBarContainer">
                        <!-- posiziona la ricerca a destra -->
                        <div class="col-12 col-md-4 ms-auto mw-350">
                            <div class="d-flex gap-2 align-items-center">
                                <input id="passwdSearchInput" type="search" class="form-control flex-fill rounded" placeholder="Cerca servizio o categoria..." aria-label="Cerca" />
                                <button id="passwdSearchClear" class="btn btn-danger d-none" type="button" title="Cancella ricerca">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-5 g-1" id="categoriesGrid">
                        {% for categoria, items in categories.items() %}
                        <div class="category-col mb-1">
                            <div class="card category-card-compact h-100 position-relative" onclick="selectCategory('{{ categoria }}')">
                                <div class="card-body p-1 text-center">
                                        <div class="mb-1">
                                        <i class="fas fa-folder text-primary fs-90"></i>
                                    </div>
                                    <h6 class="mb-1 text-truncate category-name text-primary fs-75 lh-1-3">{{ categoria }}</h6>
                                    <small class="badge bg-primary fs-65">{{ items|length }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Contenuto della categoria selezionata -->
                    <div id="selectedCategoryContent" class="d-none mt-3">
                        <div class="row" id="selectedCategoryServices">
                            <!-- I servizi verranno inseriti qui dinamicamente -->
                        </div>
                    </div>
                    <!-- Container per i risultati di ricerca (riutilizza selectedCategoryServices) -->
                    <div id="searchResultsHeader" class="d-none mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 id="searchResultsTitle" class="mb-0 text-primary text-wrap lh-1-3">Risultati ricerca</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback per operazioni di copia -->
    <div id="copyFeedback" class="copy-feedback d-none">
        <i class="fas fa-check"></i> <span id="copyMessage">Copiato negli appunti!</span>
    </div>

    <!-- Pulsanti flottanti in basso a destra -->
    <div class="position-fixed bottom-0 end-0 p-3 z-1050">
        <div class="d-flex flex-column gap-2">
        <button type="button" class="btn btn-success rounded-circle shadow avatar-56" 
                    onclick="exportToXlsx()" 
                    title="Esporta in Excel protetto con password di login"
            >
                <i class="fas fa-file-excel"></i>
            </button>
        <button type="button" class="btn btn-primary rounded-circle shadow avatar-56" 
                    onclick="showAddCredentialModal()" 
                    title="Aggiungi Credenziale"
            >
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>

    <!-- Modal per aggiungere/modificare credenziale -->
    <div class="modal fade" id="credentialModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="credentialModalTitle">Aggiungi Credenziale</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="credentialForm">
                        <input type="hidden" id="credentialId" value="">
                        
                        <div class="mb-3">
                            <label for="modalCategoria" class="form-label">Categoria *</label>
                            <input type="text" class="form-control" id="modalCategoria" required 
                                   list="categoriesList" placeholder="Es: SOCIAL, BANCOPOSTA, EMAIL...">
                            <datalist id="categoriesList"></datalist>
                        </div>
                        
                        <div class="mb-3">
                            <label for="modalServizio" class="form-label">Servizio *</label>
                            <input type="text" class="form-control" id="modalServizio" required 
                                   placeholder="Es: Facebook, Gmail, Amazon...">
                        </div>
                        
                        <div class="mb-3">
                            <label for="modalUtenza" class="form-label">Utenza</label>
                            <input type="text" class="form-control" id="modalUtenza" 
                                   placeholder="Username, email, numero di telefono...">
                        </div>
                        
                        <div class="mb-3">
                            <label for="modalPassword" class="form-label">Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="modalPassword" 
                                       placeholder="Password o codice di accesso">
                                <button class="btn btn-outline-secondary" type="button" onclick="toggleModalPassword()">
                                    <i class="fas fa-eye" id="modalPasswordIcon"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="modalAltro" class="form-label">Altro</label>
                            <textarea class="form-control" id="modalAltro" rows="3" 
                                      placeholder="Note aggiuntive, PIN, PUK, codici di sicurezza..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-primary" onclick="saveCredential()">
                        <i class="fas fa-save"></i> Salva
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal di conferma eliminazione -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Conferma Eliminazione</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Sei sicuro di voler eliminare la credenziale per <strong id="deleteServiceName"></strong>?</p>
                    <p class="text-muted">Questa azione non pu√≤ essere annullata.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                        <i class="fas fa-trash"></i> Elimina
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal per spostare credenziale -->
    <div class="modal fade" id="moveModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Sposta Credenziale</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Sposta la credenziale <strong id="moveServiceName"></strong> dalla categoria <strong id="moveCurrentCategory"></strong> ad una nuova categoria:</p>
                    
                    <div class="mb-3">
                        <label for="moveToCategory" class="form-label">Nuova Categoria *</label>
                        <input type="text" class="form-control" id="moveToCategory" required 
                               list="moveCategoriesList" placeholder="Es: SOCIAL, BANCOPOSTA, EMAIL...">
                        <datalist id="moveCategoriesList"></datalist>
                        <div class="form-text">Seleziona una categoria esistente o creane una nuova digitando il nome.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-warning" onclick="confirmMove()">
                        <i class="fas fa-exchange-alt"></i> Sposta
                    </button>
                </div>
            </div>
        </div>
    </div>

    

{%- endblock %}

{%- block scripts %}
    <script>
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/passwd/sw.js')
                    .then(function(registration) {
                        console.log('‚úÖ ServiceWorker registrato con successo:', registration.scope);
                        
                        // Controlla se c'√® un nuovo service worker in attesa
                        if (registration.waiting) {
                            console.log('üîÑ Nuovo service worker in attesa, aggiornamento...');
                            registration.waiting.postMessage({command: 'SKIP_WAITING'});
                        }
                        
                        // Ascolta per aggiornamenti del service worker
                        registration.addEventListener('updatefound', () => {
                            console.log('üÜï Nuovo service worker trovato');
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('üîÑ Nuovo service worker installato, forza aggiornamento');
                                    newWorker.postMessage({command: 'SKIP_WAITING'});
                                }
                            });
                        });
                        
                    }, function(err) {
                        console.log('‚ùå ServiceWorker registrazione fallita:', err);
                    });
                    
                // Ascolta per il controllo da parte del nuovo service worker
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('üîÑ Service worker aggiornato, ricarico la pagina...');
                    // Aspetta un momento per assicurarsi che il nuovo SW sia pronto
                    setTimeout(() => {
                        window.location.reload();
                    }, 100);
                });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        let installButton = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            // Previene il prompt automatico
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostra il pulsante di installazione
            showInstallButton();
        });

        function showInstallButton() {
            // Crea e mostra il pulsante di installazione
                if (!installButton && deferredPrompt) {
                const headerButtons = document.querySelector('.d-flex.gap-2');
                installButton = document.createElement('button');
                installButton.className = 'btn btn-primary';
                installButton.title = 'Installa App';
                installButton.innerHTML = '<i class="fas fa-download"></i>';
                installButton.addEventListener('click', installApp);
                
                // Inserisce il pulsante nell'header (append alla fine dei button group)
                if (headerButtons) headerButtons.appendChild(installButton);
            }
        }

        async function installApp() {
            if (!deferredPrompt) return;
            
            // Mostra il prompt di installazione
            deferredPrompt.prompt();
            
            // Aspetta la scelta dell'utente
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('Utente ha accettato l\'installazione');
                showSuccessToast('App installata con successo!');
            } else {
                console.log('Utente ha rifiutato l\'installazione');
            }
            
            // Reset del prompt
            deferredPrompt = null;
            
            // Rimuovi il pulsante di installazione
            if (installButton) {
                installButton.remove();
                installButton = null;
            }
        }

        // Gestione per dispositivi iOS (che non supportano beforeinstallprompt)
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }

        function isInStandaloneMode() {
            return (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || 
                   (window.navigator && window.navigator.standalone);
        }

        // Mostra istruzioni per iOS se non √® gi√† installata
        if (isIOS() && !isInStandaloneMode()) {
            window.addEventListener('load', function() {
                setTimeout(() => {
                    if (!localStorage.getItem('ios-install-dismissed')) {
                        showIOSInstallInstructions();
                    }
                }, 3000);
            });
        }

        function showIOSInstallInstructions() {
            const toast = document.createElement('div');
            toast.className = 'position-fixed bottom-0 start-50 translate-middle-x p-3';
            toast.style.zIndex = '1050';
            toast.style.maxWidth = '90%';
            toast.innerHTML = `
                <div class="toast show" role="alert">
                    <div class="toast-header">
                        <i class="fas fa-mobile-alt text-primary me-2"></i>
                        <strong class="me-auto">Installa l'App</strong>
                        <button type="button" class="btn-close" onclick="dismissIOSInstructions(this)"></button>
                    </div>
                    <div class="toast-body">
                        <small>Tocca <i class="fas fa-share"></i> in Safari e seleziona "Aggiungi alla schermata Home" per installare l'app</small>
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
        }

        function dismissIOSInstructions(button) {
            localStorage.setItem('ios-install-dismissed', 'true');
            const toast = button.closest('.position-fixed');
            if (toast) {
                toast.remove();
            }
        }

        // Variabili globali
        let allCategories = [];
        let allData = [];
        let searchTimeout;
        let deleteCredentialId = null;
        let moveCredentialId = null;
        let selectedCategory = null;
    let currentSearchTerm = '';

        // Seleziona una categoria e mostra i suoi servizi
        async function selectCategory(categoryName) {
            // Se la categoria √® gi√† selezionata, chiudila
            if (selectedCategory === categoryName) {
                deselectCategory();
                return;
            }

            // Rimuovi l'evidenziazione da tutte le card
            document.querySelectorAll('.category-card-compact').forEach(card => {
                card.classList.remove('category-card-active');
            });

            selectedCategory = categoryName;

            // Nascondi la barra di ricerca quando si seleziona una categoria
            const searchBar = document.getElementById('searchBarContainer');
            if (searchBar) searchBar.style.display = 'none';

            try {
                // Carica tutti i dati se non gi√† caricati
                if (allData.length === 0) {
                    allData = await postForm('/passwd/api/search', null, { method: 'GET', expect: 'json' });
                }

                // Filtra i servizi per la categoria selezionata
                const categoryServices = allData.filter(item => item.CATEGORIA === categoryName);

                // Evidenzia la card della categoria selezionata
                const categoryCards = document.querySelectorAll('.category-card-compact');
                categoryCards.forEach(card => {
                    const nameEl = card.querySelector('.category-name');
                    const categoryText = nameEl ? nameEl.textContent.trim() : '';
                    if (categoryText === categoryName) {
                        card.classList.add('category-card-active');
                    }
                });

                // Mostra il contenuto della categoria (usa la classe d-none per coerenza con Bootstrap)
                const selContent = document.getElementById('selectedCategoryContent');
                if (selContent) {
                    selContent.classList.remove('d-none');
                    selContent.classList.add('fade-in');
                    selContent.addEventListener('animationend', function onAnim(){ selContent.classList.remove('fade-in'); selContent.removeEventListener('animationend', onAnim); }, { once:true });
                }

                // Popola i servizi
                const servicesContainer = document.getElementById('selectedCategoryServices');
                servicesContainer.innerHTML = '';

                categoryServices.forEach(item => {
                    const serviceCard = createCompactServiceCard(item);
                    servicesContainer.appendChild(serviceCard);
                });

                // Nascondi le altre categorie e mostra solo quella selezionata
                // Invece di aggiungere il back button nella card selezionata, creiamo
                // una card fittizia "Tutte" prima di quella selezionata con il bottone di back
                let insertedAllCol = document.getElementById('category-all-col');
                if (!insertedAllCol) {
                    // trova la colonna selezionata
                    let selectedCol = null;
                    const cols = Array.from(document.querySelectorAll('.category-col'));
                    cols.forEach(c => {
                        const nameEl = c.querySelector('.category-name');
                        const nameText = nameEl ? nameEl.textContent.trim() : '';
                        if (nameText === categoryName) selectedCol = c;
                    });

                    // crea la col fittizia
                    if (selectedCol) {
                        insertedAllCol = document.createElement('div');
                        insertedAllCol.id = 'category-all-col';
                        insertedAllCol.className = 'category-col mb-1';
                        // Nota: rendiamo cliccabile l'intera card chiamando deselectCategory() sull'onclick della card
                        insertedAllCol.innerHTML = `
                            <div class="card category-card-compact h-100 position-relative" onclick="deselectCategory()">
                                <div class="card-body p-1 text-center">
                                    <div class="mb-1">
                                        <i class="fas fa-folder text-primary fs-90"></i>
                                    </div>
                                    <h6 class="mb-1 text-truncate category-name text-primary fs-75 lh-1-3">Tutte le categorie</h6>
                                    <!-- posizioniamo il pulsante inline al posto del badge per allinearlo esattamente -->
                                    <div class="mt-1">
                                        <button class="btn btn-sm btn-back-category" aria-label="Mostra tutte le categorie" title="Mostra tutte le categorie"><i class="fas fa-arrow-left"></i></button>
                                    </div>
                                </div>
                            </div>
                        `;
                        // insert before the selected column for visual continuity
                        selectedCol.parentNode.insertBefore(insertedAllCol, selectedCol);

                        // wire back button (no stopPropagation; clicking button also triggers deselectCategory via card onclick)
                        const backBtn = insertedAllCol.querySelector('.btn-back-category');
                        if (backBtn) backBtn.addEventListener('click', function(e){ deselectCategory(); });
                    }
                }

                // nascondi le altre colonne (fade)
                document.querySelectorAll('.category-col').forEach(col => {
                    if (col.id === 'category-all-col') return; // keep the fake 'Tutte' col visible
                    const nameEl = col.querySelector('.category-name');
                    const nameText = nameEl ? nameEl.textContent.trim() : '';
                    if (nameText !== categoryName) {
                        col.classList.add('fade-out');
                        col.addEventListener('animationend', function onEnd() {
                            col.style.display = 'none';
                            col.classList.remove('fade-out');
                            col.removeEventListener('animationend', onEnd);
                        }, { once: true });
                    }
                });

                // Scroll verso il contenuto della categoria
                document.getElementById('selectedCategoryContent').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });

            } catch (error) {
                console.error('Errore nel caricamento della categoria:', error);
                    try { if (typeof showToast === 'function') showToast('Errore nel caricamento della categoria', 'danger'); else alert('Errore nel caricamento della categoria'); } catch(e) { alert('Errore nel caricamento della categoria'); }
            }
        }

        // Search helpers
        function debounce(fn, delay) {
            let t;
            return function(...args) {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        async function performSearch(term) {
            currentSearchTerm = term && term.trim();
            const clearBtn = document.getElementById('passwdSearchClear');
            if (clearBtn) clearBtn.classList.toggle('d-none', !currentSearchTerm);

            if (!currentSearchTerm) {
                // empty search -> clear results and show categories
                clearSearch();
                return;
            }

            try {
                const results = await postForm(`/passwd/api/search?q=${encodeURIComponent(currentSearchTerm)}`, null, { method: 'GET', expect: 'json' });

                // show results header
                const header = document.getElementById('searchResultsHeader');
                const title = document.getElementById('searchResultsTitle');
                if (header && title) {
                    title.textContent = `Risultati per "${currentSearchTerm}" (${results.length})`;
                    header.classList.remove('d-none');
                }

                // populate services area with results
                const servicesContainer = document.getElementById('selectedCategoryServices');
                const selContent = document.getElementById('selectedCategoryContent');
                if (servicesContainer && selContent) {
                    servicesContainer.innerHTML = '';
                    results.forEach(item => {
                        const card = createCompactServiceCard(item);
                        servicesContainer.appendChild(card);
                    });

                    // show selectedCategoryContent (reuse for search results)
                    selContent.classList.remove('d-none');
                    // hide categories grid to focus on results
                    document.getElementById('categoriesGrid').style.display = 'none';
                }
            } catch (e) {
                console.error('performSearch error', e);
            }
        }

        const debouncedPerformSearch = debounce((e) => performSearch(e.target.value), 250);

        function clearSearch() {
            currentSearchTerm = '';
            const input = document.getElementById('passwdSearchInput');
            if (input) input.value = '';
            const clearBtn = document.getElementById('passwdSearchClear');
            if (clearBtn) clearBtn.classList.add('d-none');

            const header = document.getElementById('searchResultsHeader');
            if (header) header.classList.add('d-none');

            const servicesContainer = document.getElementById('selectedCategoryServices');
            if (servicesContainer) servicesContainer.innerHTML = '';

            // show categories grid again
            const grid = document.getElementById('categoriesGrid');
            if (grid) grid.style.display = '';

            // hide selectedCategoryContent
            const sel = document.getElementById('selectedCategoryContent');
            if (sel) sel.classList.add('d-none');
        }

        // wire search input events on DOM ready
        (function wireSearchOnLoad(){
            document.addEventListener('DOMContentLoaded', function(){
                const input = document.getElementById('passwdSearchInput');
                const clearBtn = document.getElementById('passwdSearchClear');
                if (input) {
                    input.addEventListener('input', debouncedPerformSearch);
                    input.addEventListener('keydown', function(e){ if (e.key === 'Escape') clearSearch(); });
                }
                if (clearBtn) clearBtn.addEventListener('click', clearSearch);
            });
        })();

        // Toggle visibilit√† dettagli sensibili in una card specifica
        function toggleServiceDetails(button) {
            const card = button.closest('.card');
            if (!card) return;
            const sensitiveContent = card.querySelectorAll('.sensitive-content');
            const icon = button.querySelector('i');

            if (sensitiveContent.length === 0) {
                return; // Nessun contenuto sensibile da mostrare
            }

            // Usa la classe 'd-none' (Bootstrap) per determinare lo stato
            const isHidden = sensitiveContent[0].classList.contains('d-none');

            sensitiveContent.forEach(element => {
                if (isHidden) element.classList.remove('d-none');
                else element.classList.add('d-none');
            });

            // Aggiorna l'icona del pulsante e lo stile
            if (!icon) return;
            if (isHidden) {
                // Ora visibile
                icon.className = 'fas fa-eye-slash';
                button.title = 'Nascondi dettagli';
                button.classList.remove('btn-outline-info');
                button.classList.add('btn-info');
            } else {
                // Ora nascosto
                icon.className = 'fas fa-eye';
                button.title = 'Mostra dettagli';
                button.classList.remove('btn-info');
                button.classList.add('btn-outline-info');
            }
        }

        // Deseleziona la categoria
        function deselectCategory() {
            selectedCategory = null;
            const sel = document.getElementById('selectedCategoryContent');
            if (sel) sel.classList.add('d-none');

            // Mostra nuovamente la barra di ricerca
            const searchBar = document.getElementById('searchBarContainer');
            if (searchBar) searchBar.style.display = '';

            // Rimuovi l'evidenziazione da tutte le card
            document.querySelectorAll('.category-card-compact').forEach(card => {
                card.classList.remove('category-card-active');
            });

            // Ripristina la visualizzazione di tutte le categorie e rimuovi la card fittizia 'Tutte'
            // Rimuovi la col fittizia se presente
            const fake = document.getElementById('category-all-col');
            if (fake) fake.remove();

            document.querySelectorAll('.category-col').forEach(col => {
                // restore and fade-in
                col.style.display = '';
                col.classList.add('fade-in');
                col.addEventListener('animationend', function onEnd(){ col.classList.remove('fade-in'); col.removeEventListener('animationend', onEnd); }, { once:true });
                // rimuovi eventuali back button residui
                const back = col.querySelector('.btn-back-category');
                if (back) back.remove();
            });

            // Torna in cima alla griglia categorie
            const grid = document.getElementById('categoriesGrid');
            if (grid) grid.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Crea una card compatta per un servizio
        function createCompactServiceCard(item) {
                const col = document.createElement('div');
                // Use col-xl-4 to have 3 cards per row on large/xl screens
                col.className = 'col-md-6 col-lg-4 col-xl-4 mb-3';

            col.innerHTML = `
                <div class="card service-card">
                    <div class="card-body p-3">
                        <div class="mb-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <h6 class="card-title mb-0 flex-grow-1 me-2 text-primary text-wrap lh-1-3">
                                    <i class="fas fa-cog me-1"></i>${item.SERVIZIO || 'N/A'}
                                </h6>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-1 mb-2 flex-wrap">
                            <button class="btn btn-outline-info btn-sm flex-fill min-w-0" onclick="toggleServiceDetails(this)" title="Mostra/Nascondi dettagli">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-primary btn-sm flex-fill min-w-0" onclick="editCredential(${item.id})" title="Modifica">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm flex-fill min-w-0" onclick="deleteCredential(${item.id}, '${(item.SERVIZIO || '').replace(/'/g, "\\'")}')" title="Elimina">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        
                        ${item.UTENZA ? `
                        <div class="mb-2 mt-2 sensitive-content d-none">
                            <small class="text-muted d-block">
                                <i class="fas fa-user me-1"></i>Utenza:
                            </small>
                            <div class="d-flex align-items-center text-primary">
                                <small class="text-truncate me-2">${item.UTENZA}</small>
                                <button class="btn btn-outline-secondary btn-sm py-0 px-1" 
                                        onclick="copyToClipboard('${item.UTENZA.replace(/'/g, "\\'")}', 'Utenza')" 
                                        title="Copia utenza">
                                    <i class="fas fa-copy fs-70"></i>
                                </button>
                            </div>
                        </div>` : ''}
                        
                        ${item.PASSWORD ? `
                        <div class="mb-2 sensitive-content d-none">
                            <small class="text-muted d-block">
                                <i class="fas fa-key me-1"></i>Password:
                            </small>
                            <div class="d-flex align-items-center text-primary">
                                <small class="me-2 text-truncate">${item.PASSWORD}</small>
                                <button class="btn btn-outline-secondary btn-sm py-0 px-1" 
                                        onclick="copyToClipboard('${item.PASSWORD.replace(/'/g, "\\'")}', 'Password')" 
                                        title="Copia password">
                                    <i class="fas fa-copy fs-70"></i>
                                </button>
                            </div>
                        </div>` : ''}
                        
                        ${item.ALTRO ? `
                        <div class="mb-0 sensitive-content d-none">
                            <small class="text-muted d-block">
                                <i class="fas fa-info-circle me-1"></i>Altro:
                            </small>
                            <div class="d-flex align-items-start text-primary">
                                <small class="me-2 flex-grow-1 text-break">${item.ALTRO}</small>
                                <button class="btn btn-outline-secondary btn-sm py-0 px-1" 
                                        onclick="copyToClipboard('${item.ALTRO.replace(/'/g, "\\'")}', 'Altro')" 
                                        title="Copia altro">
                                    <i class="fas fa-copy fs-70"></i>
                                </button>
                            </div>
                        </div>` : ''}
                    </div>
                </div>
            `;

            return col;
        }

        // Carica le categorie al caricamento della pagina
        document.addEventListener('DOMContentLoaded', function() {
            // Verifica se siamo appena loggati (presenza di parametri specifici o session flag)
            const urlParams = new URLSearchParams(window.location.search);
            const isPostLogin = urlParams.has('login') || sessionStorage.getItem('justLoggedIn') === 'true';
            
            if (isPostLogin) {
                // Pulisci il flag e forza reload completo
                sessionStorage.removeItem('justLoggedIn');
                urlParams.delete('login');
                urlParams.delete('t'); // Rimuovi anche il timestamp
                
                // Aggiorna URL senza ricaricare la pagina
                if (window.history && window.history.replaceState) {
                    const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
                    window.history.replaceState({}, document.title, newUrl);
                }
                
                // Forza il reload completo dei dati
                console.log('üîë Post-login rilevato, forcing complete data reload...');
                
                // Imposta un flag per indicare che stiamo facendo il reload post-login
                sessionStorage.setItem('postLoginReload', 'true');
                
                // Forza il reload con delay per assicurarsi che la sessione sia pronta
                setTimeout(() => {
                    forceDataReload();
                }, 200);
            } else {
                // Controlla se abbiamo appena completato un reload post-login
                const isPostLoginReload = sessionStorage.getItem('postLoginReload') === 'true';
                
                if (isPostLoginReload) {
                    sessionStorage.removeItem('postLoginReload');
                    console.log('üîÑ Completamento reload post-login');
                    // Caricamento normale con dati freschi
                    loadWithCacheCheck();
                } else {
                    // Caricamento normale ma con verifica di freshness
                    loadWithCacheCheck();
                }
            }
            
            // Applica layout iniziale
            setTimeout(() => {
                applyCategoryLayout();
            }, 100);
        });
        
        // Caricamento con controllo della cache
        async function loadWithCacheCheck() {
            try {
                // Controlla se i dati sono "freschi" (meno di 30 secondi)
                const lastLoad = localStorage.getItem('lastDataLoad');
                const now = Date.now();
                const isFresh = lastLoad && (now - parseInt(lastLoad)) < 30000;
                
                if (isFresh) {
                    console.log('Dati considerati freschi, caricamento normale');
                    await loadCategories(false);
                    await loadAllData(false);
                    await reloadCategoryView(false);
                } else {
                    console.log('Dati non freschi, forzando reload');
                    await forceDataReload();
                }
                
                // Aggiorna timestamp dell'ultimo caricamento
                localStorage.setItem('lastDataLoad', now.toString());
            } catch (error) {
                console.error('Errore nel caricamento con cache check:', error);
                // Fallback su forceDataReload
                await forceDataReload();
            }
        }
        
        // Riapplica il layout quando la finestra viene ridimensionata
        window.addEventListener('resize', function() {
            applyCategoryLayout();
        });

        // ----- Data loading helpers (provide minimal implementations that were removed) -----
        // For compatibility with older code paths which call forceDataReload(), loadCategories(), loadAllData(), etc.
        async function forceDataReload() {
            try {
                console.log('üîÅ Forzando reload completo dei dati...');
                allData = await postForm('/passwd/api/search', null, { method: 'GET', expect: 'json' });

                // ricava le categorie dai dati
                const categoriesMap = {};
                allData.forEach(i => {
                    const c = i.CATEGORIA || 'UNCLASSIFIED';
                    categoriesMap[c] = (categoriesMap[c] || 0) + 1;
                });

                allCategories = Object.keys(categoriesMap);

                // aggiorna datalist per i suggerimenti
                const datalist = document.getElementById('categoriesList');
                if (datalist) {
                    datalist.innerHTML = '';
                    allCategories.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c;
                        datalist.appendChild(opt);
                    });
                }

                // renderizza la griglia categorie
                renderCategoriesGrid(categoriesMap);

                // aggiorna la vista della categoria selezionata se presente
                await reloadCategoryView(true);
            } catch (e) {
                console.error('forceDataReload error', e);
            }
        }

        async function loadAllData(force) {
            if (!force && allData && allData.length) return allData;
            try {
                allData = await postForm('/passwd/api/search', null, { method: 'GET', expect: 'json' });
                return allData;
            } catch (e) {
                console.error('loadAllData error', e);
                return [];
            }
        }

        async function loadCategories(force) {
            if (!force && allCategories && allCategories.length) return allCategories;
            // ensure we have allData
            if (!allData || allData.length === 0) await loadAllData(true);
            const categoriesMap = {};
            (allData || []).forEach(i => {
                const c = i.CATEGORIA || 'UNCLASSIFIED';
                categoriesMap[c] = (categoriesMap[c] || 0) + 1;
            });
            allCategories = Object.keys(categoriesMap);
            renderCategoriesGrid(categoriesMap);
            return allCategories;
        }

        async function reloadCategoryView(force) {
            if (!selectedCategory) return;
            // ensure data available
            if (!allData || allData.length === 0) await loadAllData(true);

            try {
                const servicesContainer = document.getElementById('selectedCategoryServices');
                if (!servicesContainer) return;
                servicesContainer.innerHTML = '';

                const categoryServices = (allData || []).filter(item => item.CATEGORIA === selectedCategory);
                categoryServices.forEach(item => {
                    const card = createCompactServiceCard(item);
                    servicesContainer.appendChild(card);
                });

                const selectedContent = document.getElementById('selectedCategoryContent');
                if (selectedContent) selectedContent.classList.remove('d-none');
            } catch (e) {
                console.error('reloadCategoryView error', e);
            }
        }

        function renderCategoriesGrid(categoriesMap) {
            const grid = document.getElementById('categoriesGrid');
            if (!grid) return;
            grid.innerHTML = '';
                Object.keys(categoriesMap).forEach(c => {
                const col = document.createElement('div');
                col.className = 'category-col mb-1';
                col.innerHTML = `
                    <div class="card category-card-compact h-100 position-relative" onclick="selectCategory('${c.replace(/'/g, "\\'")}')">
                        <div class="card-body p-1 text-center">
                                <div class="mb-1">
                                <i class="fas fa-folder text-primary fs-90"></i>
                            </div>
                            <h6 class="mb-1 text-truncate category-name text-primary fs-75 lh-1-3">${c}</h6>
                            <small class="badge bg-primary fs-65">${categoriesMap[c]}</small>
                        </div>
                    </div>
                `;
                grid.appendChild(col);
            });
        }
        
        // ----- rest of the page JS (CRUD, copy, export functions) -----
        // To preserve maintainability, helper functions defined below mirror the original app behavior.

        function applyCategoryLayout(){ /* minimal layout adjust to keep UI consistent */ }

        // Minimal implementations for modal CRUD and helpers so edit/save/delete work.

        function showAddCredentialModal() {
            try {
                document.getElementById('credentialId').value = '';
                document.getElementById('modalCategoria').value = '';
                document.getElementById('modalServizio').value = '';
                document.getElementById('modalUtenza').value = '';
                document.getElementById('modalPassword').value = '';
                document.getElementById('modalAltro').value = '';
                document.getElementById('credentialModalTitle').textContent = 'Aggiungi Credenziale';
                const modal = new bootstrap.Modal(document.getElementById('credentialModal'));
                modal.show();
            } catch (e) {
                console.error('Errore showAddCredentialModal', e);
            }
        }

        function editCredential(id) {
            if (!id) return;
            // Try to fetch decrypted credential from server
            postForm(`/passwd/api/credentials/${id}/decrypted`, null, { expect: 'json', method: 'GET' }).then(item => {
                document.getElementById('credentialId').value = item.id || id;
                document.getElementById('modalCategoria').value = item.CATEGORIA || '';
                document.getElementById('modalServizio').value = item.SERVIZIO || '';
                document.getElementById('modalUtenza').value = item.UTENZA || '';
                document.getElementById('modalPassword').value = item.PASSWORD || '';
                document.getElementById('modalAltro').value = item.ALTRO || '';
                document.getElementById('credentialModalTitle').textContent = 'Modifica Credenziale';
                const modal = new bootstrap.Modal(document.getElementById('credentialModal'));
                modal.show();
            }).catch(err => {
                console.error('Impossibile caricare credenziale', err);
                try { if (typeof showToast === 'function') showToast('Impossibile caricare la credenziale per la modifica', 'danger'); else alert('Impossibile caricare la credenziale per la modifica'); } catch(e) { alert('Impossibile caricare la credenziale per la modifica'); }
            });
        }

        async function saveCredential() {
            try {
                const id = document.getElementById('credentialId').value;
                const payload = {
                    CATEGORIA: document.getElementById('modalCategoria').value,
                    SERVIZIO: document.getElementById('modalServizio').value,
                    UTENZA: document.getElementById('modalUtenza').value,
                    PASSWORD: document.getElementById('modalPassword').value,
                    ALTRO: document.getElementById('modalAltro').value
                };

                // postForm returns the parsed JSON directly (not the Response object)
                let result;
                if (id) {
                    result = await postForm(`/passwd/api/credentials/${id}`, payload, { method: 'PUT' });
                } else {
                    result = await postForm(`/passwd/api/credentials`, payload);
                }
                
                // Close modal first
                const modalEl = document.getElementById('credentialModal');
                const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                modal.hide();

                // Wait for modal to fully close before reloading
                modalEl.addEventListener('hidden.bs.modal', function() {
                    window.location.reload();
                }, { once: true });
            } catch (err) {
                console.error('Errore salvataggio credenziale', err);
                try { if (typeof showToast === 'function') showToast('Errore nel salvataggio della credenziale', 'danger'); else alert('Errore nel salvataggio della credenziale'); } catch(e) { alert('Errore nel salvataggio della credenziale'); }
            }
        }

        function deleteCredential(id, serviceName) {
            var msg = `Eliminare la credenziale ${serviceName || id}?`;
            var confirmFn = (window.showGlobalConfirm && typeof window.showGlobalConfirm === 'function') ? window.showGlobalConfirm : function(m){ return Promise.resolve(confirm(m)); };
            confirmFn(msg).then(function(confirmed) {
                if (!confirmed) return;
                postForm(`/passwd/api/credentials/${id}`, null, { method: 'DELETE' }).then(function(j){
                    if (j && (j.ok === true || j.ok === 1)) {
                        window.location.reload();
                    } else {
                        try { if (typeof showToast === 'function') showToast('Eliminazione fallita', 'danger'); else alert('Eliminazione fallita'); } catch(e) { alert('Eliminazione fallita'); }
                    }
                }).catch(function(e){
                    console.error('Errore deleteCredential', e);
                    try { if (typeof showToast === 'function') showToast('Errore durante l\'eliminazione', 'danger'); else alert('Errore durante l\'eliminazione'); } catch(er) { alert('Errore durante l\'eliminazione'); }
                });
            }).catch(function(){ /* ignore */ });
        }

        function copyToClipboard(text, label) {
            // Funzione helper per mostrare il messaggio di successo
            const showSuccessMessage = () => {
                const message = `${label || 'Testo'} copiato negli appunti`;
                
                // Mostra solo il feedback visivo
                const feedback = document.getElementById('copyFeedback');
                if (feedback) {
                    document.getElementById('copyMessage').textContent = message;
                    feedback.classList.remove('d-none');
                    feedback.classList.add('show');
                    setTimeout(() => {
                        feedback.classList.remove('show');
                        setTimeout(() => feedback.classList.add('d-none'), 300);
                    }, 2000);
                }
            };

            // Fallback method using temporary input element
            const fallbackCopy = () => {
                const tempInput = document.createElement('textarea');
                tempInput.value = text;
                tempInput.style.position = 'fixed';
                tempInput.style.left = '-9999px';
                tempInput.style.top = '0';
                document.body.appendChild(tempInput);
                tempInput.focus();
                tempInput.select();
                
                try {
                    const successful = document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    
                    if (successful) {
                        showSuccessMessage();
                        return true;
                    } else {
                        console.error('Fallback copy failed');
                        return false;
                    }
                } catch (err) {
                    console.error('Fallback copy error:', err);
                    document.body.removeChild(tempInput);
                    return false;
                }
            };

            // Try modern clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => {
                        showSuccessMessage();
                    })
                    .catch((e) => {
                        console.error('Clipboard API failed, trying fallback:', e);
                        // Try fallback method
                        if (!fallbackCopy()) {
                            // Only show error message if both methods fail
                            try { 
                                if (typeof showToast === 'function') 
                                    showToast('Impossibile copiare negli appunti. Prova a copiare manualmente.', 'warning'); 
                                else 
                                    alert('Impossibile copiare negli appunti. Il testo √®: ' + text); 
                            } catch(er) { 
                                alert('Impossibile copiare negli appunti. Il testo √®: ' + text); 
                            }
                        }
                    });
            } else {
                // Browser doesn't support modern clipboard API, use fallback directly
                if (!fallbackCopy()) {
                    try { 
                        if (typeof showToast === 'function') 
                            showToast('Impossibile copiare negli appunti. Prova a copiare manualmente.', 'warning'); 
                        else 
                            alert('Impossibile copiare negli appunti. Il testo √®: ' + text); 
                    } catch(er) { 
                        alert('Impossibile copiare negli appunti. Il testo √®: ' + text); 
                    }
                }
            }
        }

        function toggleModalPassword() {
            const pwd = document.getElementById('modalPassword');
            const icon = document.getElementById('modalPasswordIcon');
            if (!pwd) return;
            if (pwd.type === 'password') {
                pwd.type = 'text';
                if (icon) icon.className = 'fas fa-eye-slash';
            } else {
                pwd.type = 'password';
                if (icon) icon.className = 'fas fa-eye';
            }
        }

        // performLogout removed from this page; logout is available globally in the main header

        function exportToXlsx() {
            // Trigger server export endpoint mounted under blueprint
            window.location.href = '/passwd/api/export/xlsx';
        }
    </script>
{%- endblock %}

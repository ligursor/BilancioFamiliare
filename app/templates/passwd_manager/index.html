{%- extends 'base.html' -%}

{%- block title -%}Password Manager{%- endblock -%}

{%- block content -%}
    <!-- PWA manifest (kept here for compatibility with the original UI) -->
    <link rel="manifest" href="/passwd/manifest.json">

    <!-- Note: runtime URL prefix shim removed. Client-side calls must target the blueprint-mounted paths directly (e.g. /passwd/api/...) -->

    <!-- styles moved to static/css/templates.css -->

    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <!-- Contenuto organizzato per categoria -->
                <div id="categoryContent">
                    <div class="row mb-5 g-1" id="categoriesGrid">
                        {% for categoria, items in categories.items() %}
                        <div class="category-col mb-1">
                            <div class="card category-card-compact h-100" onclick="selectCategory('{{ categoria }}')">
                                <div class="card-body p-1 text-center">
                                    <div class="mb-1">
                                        <i class="fas fa-folder text-primary" style="font-size: 0.9rem;"></i>
                                    </div>
                                    <h6 class="mb-1 text-truncate category-name" style="font-size: 0.75rem; line-height: 1.2;">{{ categoria }}</h6>
                                    <small class="badge bg-primary" style="font-size: 0.65rem;">{{ items|length }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Contenuto della categoria selezionata -->
                    <div id="selectedCategoryContent" class="d-none mt-3">
                        <div class="row" id="selectedCategoryServices">
                            <!-- I servizi verranno inseriti qui dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback per operazioni di copia -->
    <div id="copyFeedback" class="copy-feedback d-none">
        <i class="fas fa-check"></i> <span id="copyMessage">Copiato negli appunti!</span>
    </div>

    <!-- Pulsanti flottanti in basso a destra -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
        <div class="d-flex flex-column gap-2">
            <button type="button" class="btn btn-success rounded-circle shadow" 
                    onclick="exportToXlsx()" 
                    title="Esporta in Excel protetto con password di login"
                    style="width: 56px; height: 56px;">
                <i class="fas fa-file-excel"></i>
            </button>
            <button type="button" class="btn btn-primary rounded-circle shadow" 
                    onclick="showAddCredentialModal()" 
                    title="Aggiungi Credenziale"
                    style="width: 56px; height: 56px;">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>

    <!-- Modal per aggiungere/modificare credenziale -->
    <div class="modal fade" id="credentialModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="credentialModalTitle">Aggiungi Credenziale</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="credentialForm">
                        <input type="hidden" id="credentialId" value="">
                        
                        <div class="mb-3">
                            <label for="modalCategoria" class="form-label">Categoria *</label>
                            <input type="text" class="form-control" id="modalCategoria" required 
                                   list="categoriesList" placeholder="Es: SOCIAL, BANCOPOSTA, EMAIL...">
                            <datalist id="categoriesList"></datalist>
                        </div>
                        
                        <div class="mb-3">
                            <label for="modalServizio" class="form-label">Servizio *</label>
                            <input type="text" class="form-control" id="modalServizio" required 
                                   placeholder="Es: Facebook, Gmail, Amazon...">
                        </div>
                        
                        <div class="mb-3">
                            <label for="modalUtenza" class="form-label">Utenza</label>
                            <input type="text" class="form-control" id="modalUtenza" 
                                   placeholder="Username, email, numero di telefono...">
                        </div>
                        
                        <div class="mb-3">
                            <label for="modalPassword" class="form-label">Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="modalPassword" 
                                       placeholder="Password o codice di accesso">
                                <button class="btn btn-outline-secondary" type="button" onclick="toggleModalPassword()">
                                    <i class="fas fa-eye" id="modalPasswordIcon"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="modalAltro" class="form-label">Altro</label>
                            <textarea class="form-control" id="modalAltro" rows="3" 
                                      placeholder="Note aggiuntive, PIN, PUK, codici di sicurezza..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-primary" onclick="saveCredential()">
                        <i class="fas fa-save"></i> Salva
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal di conferma eliminazione -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Conferma Eliminazione</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Sei sicuro di voler eliminare la credenziale per <strong id="deleteServiceName"></strong>?</p>
                    <p class="text-muted">Questa azione non pu√≤ essere annullata.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                        <i class="fas fa-trash"></i> Elimina
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal per spostare credenziale -->
    <div class="modal fade" id="moveModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Sposta Credenziale</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Sposta la credenziale <strong id="moveServiceName"></strong> dalla categoria <strong id="moveCurrentCategory"></strong> ad una nuova categoria:</p>
                    
                    <div class="mb-3">
                        <label for="moveToCategory" class="form-label">Nuova Categoria *</label>
                        <input type="text" class="form-control" id="moveToCategory" required 
                               list="moveCategoriesList" placeholder="Es: SOCIAL, BANCOPOSTA, EMAIL...">
                        <datalist id="moveCategoriesList"></datalist>
                        <div class="form-text">Seleziona una categoria esistente o creane una nuova digitando il nome.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-warning" onclick="confirmMove()">
                        <i class="fas fa-exchange-alt"></i> Sposta
                    </button>
                </div>
            </div>
        </div>
    </div>

    

{%- endblock %}

{%- block scripts %}
    <script>
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/passwd/sw.js')
                    .then(function(registration) {
                        console.log('‚úÖ ServiceWorker registrato con successo:', registration.scope);
                        
                        // Controlla se c'√® un nuovo service worker in attesa
                        if (registration.waiting) {
                            console.log('üîÑ Nuovo service worker in attesa, aggiornamento...');
                            registration.waiting.postMessage({command: 'SKIP_WAITING'});
                        }
                        
                        // Ascolta per aggiornamenti del service worker
                        registration.addEventListener('updatefound', () => {
                            console.log('üÜï Nuovo service worker trovato');
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('üîÑ Nuovo service worker installato, forza aggiornamento');
                                    newWorker.postMessage({command: 'SKIP_WAITING'});
                                }
                            });
                        });
                        
                    }, function(err) {
                        console.log('‚ùå ServiceWorker registrazione fallita:', err);
                    });
                    
                // Ascolta per il controllo da parte del nuovo service worker
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('üîÑ Service worker aggiornato, ricarico la pagina...');
                    // Aspetta un momento per assicurarsi che il nuovo SW sia pronto
                    setTimeout(() => {
                        window.location.reload();
                    }, 100);
                });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        let installButton = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            // Previene il prompt automatico
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostra il pulsante di installazione
            showInstallButton();
        });

        function showInstallButton() {
            // Crea e mostra il pulsante di installazione
                if (!installButton && deferredPrompt) {
                const headerButtons = document.querySelector('.d-flex.gap-2');
                installButton = document.createElement('button');
                installButton.className = 'btn btn-primary';
                installButton.title = 'Installa App';
                installButton.innerHTML = '<i class="fas fa-download"></i>';
                installButton.addEventListener('click', installApp);
                
                // Inserisce il pulsante nell'header (append alla fine dei button group)
                if (headerButtons) headerButtons.appendChild(installButton);
            }
        }

        async function installApp() {
            if (!deferredPrompt) return;
            
            // Mostra il prompt di installazione
            deferredPrompt.prompt();
            
            // Aspetta la scelta dell'utente
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('Utente ha accettato l\'installazione');
                showSuccessToast('App installata con successo!');
            } else {
                console.log('Utente ha rifiutato l\'installazione');
            }
            
            // Reset del prompt
            deferredPrompt = null;
            
            // Rimuovi il pulsante di installazione
            if (installButton) {
                installButton.remove();
                installButton = null;
            }
        }

        // Gestione per dispositivi iOS (che non supportano beforeinstallprompt)
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }

        function isInStandaloneMode() {
            return (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || 
                   (window.navigator && window.navigator.standalone);
        }

        // Mostra istruzioni per iOS se non √® gi√† installata
        if (isIOS() && !isInStandaloneMode()) {
            window.addEventListener('load', function() {
                setTimeout(() => {
                    if (!localStorage.getItem('ios-install-dismissed')) {
                        showIOSInstallInstructions();
                    }
                }, 3000);
            });
        }

        function showIOSInstallInstructions() {
            const toast = document.createElement('div');
            toast.className = 'position-fixed bottom-0 start-50 translate-middle-x p-3';
            toast.style.zIndex = '1050';
            toast.style.maxWidth = '90%';
            toast.innerHTML = `
                <div class="toast show" role="alert">
                    <div class="toast-header">
                        <i class="fas fa-mobile-alt text-primary me-2"></i>
                        <strong class="me-auto">Installa l'App</strong>
                        <button type="button" class="btn-close" onclick="dismissIOSInstructions(this)"></button>
                    </div>
                    <div class="toast-body">
                        <small>Tocca <i class="fas fa-share"></i> in Safari e seleziona "Aggiungi alla schermata Home" per installare l'app</small>
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
        }

        function dismissIOSInstructions(button) {
            localStorage.setItem('ios-install-dismissed', 'true');
            const toast = button.closest('.position-fixed');
            if (toast) {
                toast.remove();
            }
        }

        // Variabili globali
        let allCategories = [];
        let allData = [];
        let searchTimeout;
        let deleteCredentialId = null;
        let moveCredentialId = null;
        let selectedCategory = null;

        // Seleziona una categoria e mostra i suoi servizi
        async function selectCategory(categoryName) {
            // Se la categoria √® gi√† selezionata, chiudila
            if (selectedCategory === categoryName) {
                deselectCategory();
                return;
            }
            
            // Rimuovi l'evidenziazione da tutte le card
            document.querySelectorAll('.category-card-compact').forEach(card => {
                card.classList.remove('category-card-active');
            });
            
            selectedCategory = categoryName;
            
            try {
                // Carica tutti i dati se non gi√† caricati
                if (allData.length === 0) {
                    const response = await fetch('/passwd/api/search');
                    allData = await response.json();
                }
                
                // Filtra i servizi per la categoria selezionata
                const categoryServices = allData.filter(item => item.CATEGORIA === categoryName);
                
                // Evidenzia la card della categoria selezionata
                const categoryCards = document.querySelectorAll('.category-card-compact');
                categoryCards.forEach(card => {
                    const categoryText = card.querySelector('.category-name').textContent;
                    if (categoryText === categoryName) {
                        card.classList.add('category-card-active');
                    }
                });
                
                // Mostra il contenuto della categoria (usa la classe d-none per coerenza con Bootstrap)
                const selContent = document.getElementById('selectedCategoryContent');
                if (selContent) selContent.classList.remove('d-none');
                
                // Popola i servizi
                const servicesContainer = document.getElementById('selectedCategoryServices');
                servicesContainer.innerHTML = '';
                
                categoryServices.forEach(item => {
                    const serviceCard = createCompactServiceCard(item);
                    servicesContainer.appendChild(serviceCard);
                });
                
                // Scroll verso il contenuto della categoria
                document.getElementById('selectedCategoryContent').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
                
            } catch (error) {
                console.error('Errore nel caricamento della categoria:', error);
                alert('Errore nel caricamento della categoria');
            }
        }

        // Toggle visibilit√† dettagli sensibili in una card specifica
        function toggleServiceDetails(button) {
            const card = button.closest('.card');
            if (!card) return;
            const sensitiveContent = card.querySelectorAll('.sensitive-content');
            const icon = button.querySelector('i');

            if (sensitiveContent.length === 0) {
                return; // Nessun contenuto sensibile da mostrare
            }

            // Usa la classe 'd-none' (Bootstrap) per determinare lo stato
            const isHidden = sensitiveContent[0].classList.contains('d-none');

            sensitiveContent.forEach(element => {
                if (isHidden) element.classList.remove('d-none');
                else element.classList.add('d-none');
            });

            // Aggiorna l'icona del pulsante e lo stile
            if (!icon) return;
            if (isHidden) {
                // Ora visibile
                icon.className = 'fas fa-eye-slash';
                button.title = 'Nascondi dettagli';
                button.classList.remove('btn-outline-info');
                button.classList.add('btn-info');
            } else {
                // Ora nascosto
                icon.className = 'fas fa-eye';
                button.title = 'Mostra dettagli';
                button.classList.remove('btn-info');
                button.classList.add('btn-outline-info');
            }
        }

        // Deseleziona la categoria
        function deselectCategory() {
            selectedCategory = null;
            const sel = document.getElementById('selectedCategoryContent');
            if (sel) sel.classList.add('d-none');

            // Rimuovi l'evidenziazione da tutte le card
            document.querySelectorAll('.category-card-compact').forEach(card => {
                card.classList.remove('category-card-active');
            });
        }

        // Crea una card compatta per un servizio
        function createCompactServiceCard(item) {
                const col = document.createElement('div');
                // Use col-xl-4 to have 3 cards per row on large/xl screens
                col.className = 'col-md-6 col-lg-4 col-xl-4 mb-3';

            col.innerHTML = `
                <div class="card service-card">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0 text-truncate service-title">
                                <i class="fas fa-cog me-1"></i>${item.SERVIZIO || 'N/A'}
                            </h6>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info btn-sm" onclick="toggleServiceDetails(this)" title="Mostra/Nascondi dettagli">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-primary btn-sm" onclick="editCredential(${item.id})" title="Modifica">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteCredential(${item.id}, '${(item.SERVIZIO || '').replace(/'/g, "\\'")}')" title="Elimina">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        ${item.UTENZA ? `
                        <div class="mb-2">
                            <small class="text-muted d-block">
                                <i class="fas fa-user me-1"></i>Utenza:
                            </small>
                            <div class="d-flex align-items-center">
                                <small class="text-truncate me-2">${item.UTENZA}</small>
                                <button class="btn btn-outline-secondary btn-sm py-0 px-1" 
                                        onclick="copyToClipboard('${item.UTENZA.replace(/'/g, "\\'")}', 'Utenza')" 
                                        title="Copia utenza">
                                    <i class="fas fa-copy" style="font-size: 0.7rem;"></i>
                                </button>
                            </div>
                        </div>` : ''}
                        
                        ${item.PASSWORD ? `
                        <div class="mb-2 sensitive-content d-none">
                            <small class="text-muted d-block">
                                <i class="fas fa-key me-1"></i>Password:
                            </small>
                            <div class="d-flex align-items-center">
                                <small class="me-2 text-truncate">${item.PASSWORD}</small>
                                <button class="btn btn-outline-secondary btn-sm py-0 px-1" 
                                        onclick="copyToClipboard('${item.PASSWORD.replace(/'/g, "\\'")}', 'Password')" 
                                        title="Copia password">
                                    <i class="fas fa-copy" style="font-size: 0.7rem;"></i>
                                </button>
                            </div>
                        </div>` : ''}
                        
                        ${item.ALTRO ? `
                        <div class="mb-0 sensitive-content d-none">
                            <small class="text-muted d-block">
                                <i class="fas fa-info-circle me-1"></i>Altro:
                            </small>
                            <div class="d-flex align-items-start">
                                <small class="me-2 flex-grow-1" style="word-break: break-word;">${item.ALTRO}</small>
                                <button class="btn btn-outline-secondary btn-sm py-0 px-1" 
                                        onclick="copyToClipboard('${item.ALTRO.replace(/'/g, "\\'")}', 'Altro')" 
                                        title="Copia altro">
                                    <i class="fas fa-copy" style="font-size: 0.7rem;"></i>
                                </button>
                            </div>
                        </div>` : ''}
                    </div>
                </div>
            `;

            return col;
        }

        // Carica le categorie al caricamento della pagina
        document.addEventListener('DOMContentLoaded', function() {
            // Verifica se siamo appena loggati (presenza di parametri specifici o session flag)
            const urlParams = new URLSearchParams(window.location.search);
            const isPostLogin = urlParams.has('login') || sessionStorage.getItem('justLoggedIn') === 'true';
            
            if (isPostLogin) {
                // Pulisci il flag e forza reload completo
                sessionStorage.removeItem('justLoggedIn');
                urlParams.delete('login');
                urlParams.delete('t'); // Rimuovi anche il timestamp
                
                // Aggiorna URL senza ricaricare la pagina
                if (window.history && window.history.replaceState) {
                    const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
                    window.history.replaceState({}, document.title, newUrl);
                }
                
                // Forza il reload completo dei dati
                console.log('üîë Post-login rilevato, forcing complete data reload...');
                
                // Imposta un flag per indicare che stiamo facendo il reload post-login
                sessionStorage.setItem('postLoginReload', 'true');
                
                // Forza il reload con delay per assicurarsi che la sessione sia pronta
                setTimeout(() => {
                    forceDataReload();
                }, 200);
            } else {
                // Controlla se abbiamo appena completato un reload post-login
                const isPostLoginReload = sessionStorage.getItem('postLoginReload') === 'true';
                
                if (isPostLoginReload) {
                    sessionStorage.removeItem('postLoginReload');
                    console.log('üîÑ Completamento reload post-login');
                    // Caricamento normale con dati freschi
                    loadWithCacheCheck();
                } else {
                    // Caricamento normale ma con verifica di freshness
                    loadWithCacheCheck();
                }
            }
            
            // Applica layout iniziale
            setTimeout(() => {
                applyCategoryLayout();
            }, 100);
        });
        
        // Caricamento con controllo della cache
        async function loadWithCacheCheck() {
            try {
                // Controlla se i dati sono "freschi" (meno di 30 secondi)
                const lastLoad = localStorage.getItem('lastDataLoad');
                const now = Date.now();
                const isFresh = lastLoad && (now - parseInt(lastLoad)) < 30000;
                
                if (isFresh) {
                    console.log('Dati considerati freschi, caricamento normale');
                    await loadCategories(false);
                    await loadAllData(false);
                    await reloadCategoryView(false);
                } else {
                    console.log('Dati non freschi, forzando reload');
                    await forceDataReload();
                }
                
                // Aggiorna timestamp dell'ultimo caricamento
                localStorage.setItem('lastDataLoad', now.toString());
            } catch (error) {
                console.error('Errore nel caricamento con cache check:', error);
                // Fallback su forceDataReload
                await forceDataReload();
            }
        }
        
        // Riapplica il layout quando la finestra viene ridimensionata
        window.addEventListener('resize', function() {
            applyCategoryLayout();
        });

        // ----- Data loading helpers (provide minimal implementations that were removed) -----
        // For compatibility with older code paths which call forceDataReload(), loadCategories(), loadAllData(), etc.
        async function forceDataReload() {
            try {
                console.log('üîÅ Forzando reload completo dei dati...');
                const resp = await fetch('/passwd/api/search');
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                allData = await resp.json();

                // ricava le categorie dai dati
                const categoriesMap = {};
                allData.forEach(i => {
                    const c = i.CATEGORIA || 'UNCLASSIFIED';
                    categoriesMap[c] = (categoriesMap[c] || 0) + 1;
                });

                allCategories = Object.keys(categoriesMap);

                // aggiorna datalist per i suggerimenti
                const datalist = document.getElementById('categoriesList');
                if (datalist) {
                    datalist.innerHTML = '';
                    allCategories.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c;
                        datalist.appendChild(opt);
                    });
                }

                // renderizza la griglia categorie
                renderCategoriesGrid(categoriesMap);

                // aggiorna la vista della categoria selezionata se presente
                await reloadCategoryView(true);
            } catch (e) {
                console.error('forceDataReload error', e);
            }
        }

        async function loadAllData(force) {
            if (!force && allData && allData.length) return allData;
            try {
                const resp = await fetch('/passwd/api/search');
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                allData = await resp.json();
                return allData;
            } catch (e) {
                console.error('loadAllData error', e);
                return [];
            }
        }

        async function loadCategories(force) {
            if (!force && allCategories && allCategories.length) return allCategories;
            // ensure we have allData
            if (!allData || allData.length === 0) await loadAllData(true);
            const categoriesMap = {};
            (allData || []).forEach(i => {
                const c = i.CATEGORIA || 'UNCLASSIFIED';
                categoriesMap[c] = (categoriesMap[c] || 0) + 1;
            });
            allCategories = Object.keys(categoriesMap);
            renderCategoriesGrid(categoriesMap);
            return allCategories;
        }

        async function reloadCategoryView(force) {
            if (!selectedCategory) return;
            // ensure data available
            if (!allData || allData.length === 0) await loadAllData(true);

            try {
                const servicesContainer = document.getElementById('selectedCategoryServices');
                if (!servicesContainer) return;
                servicesContainer.innerHTML = '';

                const categoryServices = (allData || []).filter(item => item.CATEGORIA === selectedCategory);
                categoryServices.forEach(item => {
                    const card = createCompactServiceCard(item);
                    servicesContainer.appendChild(card);
                });

                const selectedContent = document.getElementById('selectedCategoryContent');
                if (selectedContent) selectedContent.classList.remove('d-none');
            } catch (e) {
                console.error('reloadCategoryView error', e);
            }
        }

        function renderCategoriesGrid(categoriesMap) {
            const grid = document.getElementById('categoriesGrid');
            if (!grid) return;
            grid.innerHTML = '';
            Object.keys(categoriesMap).forEach(c => {
                const col = document.createElement('div');
                col.className = 'category-col mb-1';
                col.innerHTML = `
                    <div class="card category-card-compact h-100" onclick="selectCategory('${c.replace(/'/g, "\\'")}')">
                        <div class="card-body p-1 text-center">
                            <div class="mb-1">
                                <i class="fas fa-folder text-primary" style="font-size: 0.9rem;"></i>
                            </div>
                            <h6 class="mb-1 text-truncate category-name" style="font-size: 0.75rem; line-height: 1.2;">${c}</h6>
                            <small class="badge bg-primary" style="font-size: 0.65rem;">${categoriesMap[c]}</small>
                        </div>
                    </div>
                `;
                grid.appendChild(col);
            });
        }
        
        // ----- rest of the page JS (CRUD, copy, export functions) -----
        // To preserve maintainability, helper functions defined below mirror the original app behavior.

        function applyCategoryLayout(){ /* minimal layout adjust to keep UI consistent */ }

        // Minimal implementations for modal CRUD and helpers so edit/save/delete work.

        function showAddCredentialModal() {
            try {
                document.getElementById('credentialId').value = '';
                document.getElementById('modalCategoria').value = '';
                document.getElementById('modalServizio').value = '';
                document.getElementById('modalUtenza').value = '';
                document.getElementById('modalPassword').value = '';
                document.getElementById('modalAltro').value = '';
                document.getElementById('credentialModalTitle').textContent = 'Aggiungi Credenziale';
                const modal = new bootstrap.Modal(document.getElementById('credentialModal'));
                modal.show();
            } catch (e) {
                console.error('Errore showAddCredentialModal', e);
            }
        }

        function editCredential(id) {
            if (!id) return;
            // Try to fetch decrypted credential from server
            fetch(`/passwd/api/credentials/${id}/decrypted`).then(resp => {
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                return resp.json();
            }).then(item => {
                document.getElementById('credentialId').value = item.id || id;
                document.getElementById('modalCategoria').value = item.CATEGORIA || '';
                document.getElementById('modalServizio').value = item.SERVIZIO || '';
                document.getElementById('modalUtenza').value = item.UTENZA || '';
                document.getElementById('modalPassword').value = item.PASSWORD || '';
                document.getElementById('modalAltro').value = item.ALTRO || '';
                document.getElementById('credentialModalTitle').textContent = 'Modifica Credenziale';
                const modal = new bootstrap.Modal(document.getElementById('credentialModal'));
                modal.show();
            }).catch(err => {
                console.error('Impossibile caricare credenziale', err);
                alert('Impossibile caricare la credenziale per la modifica');
            });
        }

        async function saveCredential() {
            try {
                const id = document.getElementById('credentialId').value;
                const payload = {
                    CATEGORIA: document.getElementById('modalCategoria').value,
                    SERVIZIO: document.getElementById('modalServizio').value,
                    UTENZA: document.getElementById('modalUtenza').value,
                    PASSWORD: document.getElementById('modalPassword').value,
                    ALTRO: document.getElementById('modalAltro').value
                };

                let resp;
                if (id) {
                    resp = await fetch(`/passwd/api/credentials/${id}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                } else {
                    resp = await fetch(`/passwd/api/credentials`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                }

                if (!resp.ok) throw new Error('HTTP ' + resp.status);

                // Close modal and refresh data
                const modalEl = document.getElementById('credentialModal');
                const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                modal.hide();

                // Reload page to reflect changes (simple and reliable)
                window.location.reload();
            } catch (err) {
                console.error('Errore salvataggio credenziale', err);
                alert('Errore nel salvataggio della credenziale');
            }
        }

        function deleteCredential(id, serviceName) {
            if (!confirm(`Eliminare la credenziale ${serviceName || id}?`)) return;
            fetch(`/passwd/api/credentials/${id}`, { method: 'DELETE' }).then(r => r.json()).then(j => {
                if (j && (j.ok === true || j.ok === 1)) {
                    window.location.reload();
                } else {
                    alert('Eliminazione fallita');
                }
            }).catch(e => {
                console.error('Errore deleteCredential', e);
                alert('Errore durante l\'eliminazione');
            });
        }

        function copyToClipboard(text, label) {
            try {
                navigator.clipboard.writeText(text).then(() => {
                    const message = `${label || 'Testo'} copiato negli appunti`;
                    const feedback = document.getElementById('copyFeedback');
                    if (feedback) {
                        document.getElementById('copyMessage').textContent = message;
                        feedback.classList.remove('d-none');
                        setTimeout(() => feedback.classList.add('d-none'), 1500);
                    } else {
                        alert(message);
                    }
                });
            } catch (e) {
                console.error('copyToClipboard failed', e);
                alert(text);
            }
        }

        function toggleModalPassword() {
            const pwd = document.getElementById('modalPassword');
            const icon = document.getElementById('modalPasswordIcon');
            if (!pwd) return;
            if (pwd.type === 'password') {
                pwd.type = 'text';
                if (icon) icon.className = 'fas fa-eye-slash';
            } else {
                pwd.type = 'password';
                if (icon) icon.className = 'fas fa-eye';
            }
        }

        // performLogout removed from this page; logout is available globally in the main header

        function exportToXlsx() {
            // Trigger server export endpoint mounted under blueprint
            window.location.href = '/passwd/api/export/xlsx';
        }
    </script>
{%- endblock %}

{% extends "base.html" %}

{% block title %}Dettaglio {{ nome_mese }} - Gestione Bilancio{% endblock %}

{% block content %}
<script>
    
function modificaTransazione(id, descrizione, importo, data, categoriaId) {
    document.getElementById('edit_descrizione').value = descrizione;
    document.getElementById('edit_importo').value = parseFloat(importo) || 0;
    document.getElementById('edit_data').value = data;
    const editCategoriaSelect = document.getElementById('edit_categoria_id');
    editCategoriaSelect.innerHTML = '';
    categorie.forEach(categoria => {
        const option = document.createElement('option');
        option.value = categoria.id;
        option.textContent = categoria.nome;
        option.selected = categoria.id == categoriaId;
        editCategoriaSelect.appendChild(option);
    });
    const form = document.getElementById('editTransactionForm');
    // Prendi start_date e end_date direttamente dal template
    const startDate = '{{ start_date }}';
    const endDate = '{{ end_date }}';
    form.action = `/dettaglio/${startDate}/${endDate}/modifica_transazione/${id}`;
    new bootstrap.Modal(document.getElementById('editTransactionModal')).show();
}
function modificaTransazioneAttr(btn) {
    modificaTransazione(
        btn.getAttribute('data-id'),
        JSON.parse(btn.getAttribute('data-descrizione')),
        btn.getAttribute('data-importo'),
        JSON.parse(btn.getAttribute('data-data')),
        btn.getAttribute('data-categoria')
    );
}
</script>

<div class="row">
    <div class="col-12">
        <div class="card">
                
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Dettaglio {{ nome_mese }}</h4>
                <div class="d-flex align-items-center">
                    <!-- Frecce navigazione mesi -->
                    <div class="btn-group me-2" role="group">
                        <button data-action="navigate-month" data-direction="-1" class="btn btn-primary btn-sm nav-arrow" title="Mese precedente">
                            <i class="fas fa-chevron-left text-white"></i>
                        </button>
                        <button data-action="navigate-month" data-direction="1" class="btn btn-primary btn-sm nav-arrow" title="Mese successivo">
                            <i class="fas fa-chevron-right text-white"></i>
                        {% include 'bilancio/dettaglio_mese.html' %}
                        <input type="date" class="form-control" id="edit_data" name="data" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_descrizione" class="form-label">Descrizione</label>
                        <input type="text" class="form-control" id="edit_descrizione" name="descrizione" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_categoria_id" class="form-label">Categoria</label>
                        <select class="form-control" id="edit_categoria_id" name="categoria_id" required></select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_importo" class="form-label">Importo (€)</label>
                        <input type="number" class="form-control" id="edit_importo" name="importo" 
                               step="0.01" min="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva Modifiche</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% if not start_date or not end_date %}
<div class="alert alert-danger mt-3">
    Errore: le date del periodo non sono valorizzate correttamente. Controlla la logica backend.
</div>
{% endif %}
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/transazioni-model.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tipo-filter.js') }}"></script>

<!-- Serializzazione categorie in JSON per JS -->
<script type="application/json" id="categorie-data">
    {{ categorie | tojson }}
</script>

<script type="application/json" id="stats-categorie-data">
    {{ stats_categorie | default([]) | tojson }}
</script>

<script>
// Parsing robusto della variabile categorie
var categorie = JSON.parse(document.getElementById('categorie-data').textContent);

// Initialize model if available; legacy globals are proxied by the model
try { /* model script included before this block */ } catch(e){}
// Save initial server-rendered tbody HTML so we can restore on errors
try { const __tb = document.querySelector('#tabella-transazioni tbody'); if (__tb) window.__tabella_initial_html = __tb.innerHTML; } catch(e){}

// Carica le transazioni originali all'avvio
function initTransazioni(attempt = 0) {
    // Prefer serialized JSON block if present
    try {
        const raw = document.getElementById('transazioni-data');
        if (raw && raw.textContent && raw.textContent.trim().length > 0) {
            const parsed = JSON.parse(raw.textContent) || [];
            const mapped = (parsed || []).map(p => ({
                elemento: null,
                id: p.id || null,
                data: p.data || '',
                descrizione: p.descrizione || '',
                categoria: p.categoria || '',
                categoriaId: p.categoriaId || null,
                tipo: p.tipo || 'uscita',
                importo: Number(p.importo) || 0
            }));
            // Use the centralized model to store original and filtered transactions.
            if (window.BilancioTransazioni && typeof window.BilancioTransazioni.setOriginali === 'function') {
                window.BilancioTransazioni.setOriginali(mapped);
            } else {
                // If model not present yet, store as serialized fallback; scripts will prefer the model when it becomes available.
                try { window.__serialized_transazioni_originali = mapped; } catch(e) {}
            }
            // initialized from JSON
            return;
        }
    } catch(e) { /* console.warn removed */ }

    const righe = document.querySelectorAll('#tabella-transazioni tbody tr');
    
    // If no rows found, retry a few times with backoff (handles race conditions where table is rendered slightly later)
    const MAX_ATTEMPTS = 6;
    if (righe.length === 0 && attempt < MAX_ATTEMPTS) {
        const delays = [30, 80, 180, 400, 800, 1200];
        const d = delays[Math.min(attempt, delays.length - 1)];
        setTimeout(() => initTransazioni(attempt + 1), d);
        return;
    }
    const built = Array.from(righe).map(riga => {
        const celle = riga.querySelectorAll('td');
        // try to extract ids placed on the edit button for robust mapping
        const editBtn = riga.querySelector('button[onclick^="modificaTransazioneAttr"]');
        const categoriaId = editBtn ? editBtn.getAttribute('data-categoria') : null;
        const tid = editBtn ? editBtn.getAttribute('data-id') : null;
        return {
            elemento: riga,
            id: tid || null,
            descrizione: celle[0] ? celle[0].textContent.trim() : '',
            data: celle[1] ? celle[1].textContent.trim() : '',
            categoria: celle[2] ? celle[2].textContent.trim() : '',
            categoriaId: categoriaId || null,
            tipo: (celle[3] && celle[3].textContent.includes('Entrata')) ? 'entrata' : 'uscita',
            importo: parseFloat((celle[4] ? celle[4].textContent : '0').replace(/[€+\-\s]/g, '').replace(',', '.')) || 0
        };
    });
    if (window.BilancioTransazioni && typeof window.BilancioTransazioni.setOriginali === 'function') {
        window.BilancioTransazioni.setOriginali(built);
    } else {
        try { window.__serialized_transazioni_originali = built; } catch(e) {}
    }
    // Reset filters to default (Tutte) on page load for monthly detail: clear saved selections
    try {
        sessionStorage.removeItem('dettaglio_selected_tipo');
        // ensure globals used by filter script are in default state
        try { window.__tipoFilter && typeof window.__tipoFilter.updateTipoIcon === 'function' && window.__tipoFilter.updateTipoIcon(false, ''); } catch(e){}
    try { window.__tipoFilter && typeof window.__tipoFilter.updateTipoBadge === 'function' && window.__tipoFilter.updateTipoBadge((window.BilancioTransazioni && typeof window.BilancioTransazioni.getFiltrate === 'function') ? (window.BilancioTransazioni.getFiltrate().length || 0) : 0); } catch(e){}
    } catch(e){}
    // ensure table shows all rows for default view
    try { if (typeof aggiornaTabella === 'function') aggiornaTabella(); } catch(e){}
    // Ensure default view (all transactions visible) by retrying a few times in case other scripts hide rows
    (function ensureDefaultView(attempt){
        try {
            // clear any saved filters
            sessionStorage.removeItem('dettaglio_selected_tipo');
            // force update
            if (typeof aggiornaTabella === 'function') aggiornaTabella();
            if (typeof runApplyFilters === 'function') runApplyFilters();
        } catch(e){}
        if (attempt < 4) {
            const delays = [50, 200, 600, 1200];
            try { setTimeout(function(){ ensureDefaultView(attempt + 1); }, delays[attempt]); } catch(e){}
        }
    })(0);
    // Initialize tipo filter state from sessionStorage and update icon/badge via exported API
    try {
        const storedTipo = sessionStorage.getItem('dettaglio_selected_tipo') || '';
        if (window.__tipoFilter && typeof window.__tipoFilter.updateTipoIcon === 'function') window.__tipoFilter.updateTipoIcon(!!storedTipo, '');
    try { const cnt = (window.BilancioTransazioni && typeof window.BilancioTransazioni.getFiltrate === 'function') ? (window.BilancioTransazioni.getFiltrate().length || 0) : 0; if (window.__tipoFilter && typeof window.__tipoFilter.updateTipoBadge === 'function') window.__tipoFilter.updateTipoBadge(cnt); } catch(e){}
    } catch(e){}
}
// Start initialization (attempts will retry if necessary)
if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', () => initTransazioni()); else initTransazioni();
    // Popola le categorie nel modal di aggiunta
    popolaCategorieSelect('add_categoria_id');
    // Category filter removed; category select for add/edit remains
    // Initialize tipo filter icon and badge using exported API if available (read state from sessionStorage)
    try {
        const storedTipo = sessionStorage.getItem('dettaglio_selected_tipo') || '';
        const active = !!storedTipo;
    const visibleCount = (window.BilancioTransazioni && typeof window.BilancioTransazioni.getFiltrate === 'function') ? (window.BilancioTransazioni.getFiltrate().length || 0) : 0;
    if (window.__tipoFilter && typeof window.__tipoFilter.updateTipoIcon === 'function') window.__tipoFilter.updateTipoIcon(active, '');
    if (window.__tipoFilter && typeof window.__tipoFilter.updateTipoBadge === 'function') window.__tipoFilter.updateTipoBadge(visibleCount);
    } catch(e){}
    
    // Gestisci il checkbox ricorrente
    document.getElementById('add_ricorrente').addEventListener('change', function() {
        const frequenzaContainer = document.getElementById('add_frequenza_container');
        frequenzaContainer.style.display = this.checked ? 'block' : 'none';
    });
    
    // Filtra categorie per tipo
    document.getElementById('add_tipo').addEventListener('change', function() {
        popolaCategorieSelect('add_categoria_id', this.value);
    });
    
    // Gestione apertura modal nuova transazione
    const addModal = document.getElementById('addTransactionModal');
    addModal.addEventListener('show.bs.modal', function() {
        precompilaDataPeriodo();
    });
 

// Listener per il modal di modifica
document.addEventListener('DOMContentLoaded', function() {
    var editModal = document.getElementById('editTransactionModal');
    if (editModal) {
        editModal.addEventListener('show.bs.modal', function() {
            setTimeout(function() {
                // RIMOSSO: setUppercaseListener('edit_descrizione');
            }, 100); // attende che il campo sia popolato
        });
    }
    // Reload automatico dopo modifica transazione
    var editForm = document.getElementById('editTransactionForm');
    if (editForm) {
        editForm.addEventListener('submit', function() {
            setTimeout(function() {
                window.location.reload();
            }, 500);
        });
    }
});

function popolaCategorieSelect(selectId, tipoFiltro = '') {
    const select = document.getElementById(selectId);
    select.innerHTML = '<option value="">Seleziona categoria...</option>';
    
    const categorieFiltrate = tipoFiltro ? 
        categorie.filter(c => c.tipo === tipoFiltro) : 
        categorie;
    
    categorieFiltrate.forEach(categoria => {
        const option = document.createElement('option');
        option.value = categoria.id;
        option.textContent = categoria.nome;
        select.appendChild(option);
    });
}

function precompilaDataPeriodo() {
    const startDate = new Date('{{ start_date }}');
    const endDate = new Date('{{ end_date }}');
    const oggi = new Date();
    
    // Se oggi è nel periodo, usa oggi, altrimenti usa la data di inizio del periodo
    let dataDefault;
    if (oggi >= startDate && oggi <= endDate) {
        dataDefault = oggi;
    } else {
        dataDefault = startDate;
    }
    
    // Formatta la data per l'input date (YYYY-MM-DD)
    const anno = dataDefault.getFullYear();
    const mese = String(dataDefault.getMonth() + 1).padStart(2, '0');
    const giorno = String(dataDefault.getDate()).padStart(2, '0');
    const dataFormattata = `${anno}-${mese}-${giorno}`;
    
    document.getElementById('add_data').value = dataFormattata;
}

// legacy ciclicaFiltroTipo removed; use dropdown-based tipo menu

function applicaFiltriDettaglio() {
    // Defer until model ready
    try {
        const checkReady = () => {
            return (window.BilancioTransazioni && window.BilancioTransazioni.ready);
        };
        if (!checkReady()) { setTimeout(applicaFiltriDettaglio, 80); return; }
    } catch(e){}
    const filtroTipo = sessionStorage.getItem('dettaglio_selected_tipo') || '';
    // Filtra solo per tipo (categoria filter rimosso)

    

    // Prefer model-driven filtering
    if (window.BilancioTransazioni && typeof window.BilancioTransazioni.applyFilters === 'function') {
        try {
            window.BilancioTransazioni.applyFilters({ tipo: filtroTipo || '' });
            try { if (window.__tipoFilter && typeof window.__tipoFilter.updateTipoBadge === 'function') window.__tipoFilter.updateTipoBadge((window.BilancioTransazioni.getFiltrate() || []).length || 0); } catch(e){}
            return;
    } catch(e) { /* console.warn removed */ }
    }

    // Delegate to model where possible; without globals there's no proxy fallback.
    try {
        if (window.BilancioTransazioni && typeof window.BilancioTransazioni.getOriginali === 'function') {
            try {
                const orig = window.BilancioTransazioni.getOriginali() || [];
                const filtered = orig.filter(t => {
                    const matchTipo = filtroTipo ? t.tipo === filtroTipo : true;
                    const matchCat = categoriaVal ? String(t.categoriaId) === String(categoriaVal) || String(t.categoria) === String(getCategoriaNomeById(categoriaVal)) : true;
                    return matchTipo && matchCat;
                });
                if (typeof window.BilancioTransazioni.setFiltrate === 'function') {
                    window.BilancioTransazioni.setFiltrate(filtered);
                }
                try { if (typeof aggiornaTabella === 'function') aggiornaTabella(); } catch(e){}
                try { if (window.__tipoFilter && typeof window.__tipoFilter.updateTipoBadge === 'function') window.__tipoFilter.updateTipoBadge((filtered && filtered.length) || 0); } catch(e){}
            } catch(e) { /* console.warn removed */ }
        } else {
            // Last fallback: DOM-only show/hide (non-authoritative)
            try { if (typeof applyClientSideFilter === 'function') applyClientSideFilter(); } catch(e){}
        }
    } catch(e){}
}

function getCategoriaNomeById(id) {
    const c = categorie.find(x => String(x.id) === String(id));
    return c ? c.nome : '';
}

function ordinaDettaglio(ordine) {
    // Rimuovi evidenziazione da tutte le frecce
    document.querySelectorAll('#sort-data-asc, #sort-data-desc, #sort-importo-asc, #sort-importo-desc').forEach(el => {
        el.classList.remove('text-warning');
        el.classList.add(el.id.includes('data') ? 'text-primary' : 'text-success');
    });
    
    // Evidenzia la freccia selezionata
    const sortId = 'sort-' + ordine.replace('_', '-');
    const sortElement = document.getElementById(sortId);
    if (sortElement) {
        sortElement.classList.remove('text-primary', 'text-success');
        sortElement.classList.add('text-warning');
    }
    
    // Ordina le transazioni: prefer model sort when available
    try {
        if (window.BilancioTransazioni && typeof window.BilancioTransazioni.sortFiltrate === 'function') {
            window.BilancioTransazioni.sortFiltrate(ordine);
            return;
        }
    } catch(e){}
    // Fallback: attempt to sort the model's filtrate via proxy if model isn't available yet
    try {
    const arr = (window.BilancioTransazioni && typeof window.BilancioTransazioni.getFiltrate === 'function') ? window.BilancioTransazioni.getFiltrate() : [];
        arr.sort((a, b) => {
            switch(ordine) {
                case 'data_asc':
                    return convertDataPerOrdinamento(a.data) - convertDataPerOrdinamento(b.data);
                case 'data_desc':
                    return convertDataPerOrdinamento(b.data) - convertDataPerOrdinamento(a.data);
                case 'importo_asc':
                    return (a.importo || 0) - (b.importo || 0);
                case 'importo_desc':
                    return (b.importo || 0) - (a.importo || 0);
                default:
                    return 0;
            }
        });
        // write back via model proxy if available
        try { if (window.BilancioTransazioni && typeof window.BilancioTransazioni.setFiltrate === 'function') window.BilancioTransazioni.setFiltrate(arr); } catch(e) {}
        aggiornaTabella();
    } catch(e) { /* console.warn removed */ }
}

function convertDataPerOrdinamento(dataStr) {
    // Converte da dd/mm/yyyy a yyyymmdd per ordinamento
    const parti = dataStr.split('/');
    return parseInt(parti[2] + parti[1].padStart(2, '0') + parti[0].padStart(2, '0'));
}

function aggiornaTabella() {
    const tbody = document.querySelector('#tabella-transazioni tbody');
    try {
        if (!tbody) return;
        tbody.innerHTML = '';
    const rowsSource = (window.BilancioTransazioni && typeof window.BilancioTransazioni.getFiltrate === 'function') ? window.BilancioTransazioni.getFiltrate() : [];
        // Helper to format dates (accepts YYYY-MM-DD or ISO strings) -> DD/MM/YYYY
        function formatDateForDisplay(d) {
            try {
                if (!d) return '';
                // If already in DD/MM/YYYY, keep it
                if (/^\d{2}\/\d{2}\/\d{4}$/.test(d)) return d;
                // ISO or YYYY-MM-DD
                const iso = String(d).trim();
                const datePart = iso.split('T')[0];
                const parts = datePart.split('-');
                if (parts.length === 3) {
                    return parts[2].padStart(2,'0') + '/' + parts[1].padStart(2,'0') + '/' + parts[0];
                }
                return d;
            } catch(e) { return d; }
        }

        (rowsSource || []).forEach(transazione => {
            // Ricrea la riga HTML da zero
            const tr = document.createElement('tr');
            const _displayDate = formatDateForDisplay(transazione.data);
            tr.innerHTML = `
                <td class="text-start">${transazione.descrizione}</td>
                <td class="text-center">${_displayDate}</td>
                <td class="text-center"><span class="badge ${transazione.tipo === 'entrata' ? 'bg-success' : 'bg-danger'}">${transazione.categoria}</span></td>
                <td class="text-center">${transazione.tipo === 'entrata' ? '<span class="text-success"><i class="fas fa-arrow-up"></i> Entrata</span>' : '<span class="text-danger"><i class="fas fa-arrow-down"></i> Uscita</span>'}</td>
                <td class="text-center ${transazione.tipo === 'entrata' ? 'text-success' : 'text-danger'}">${transazione.tipo === 'entrata' ? '+' : '-'}€ ${Number(transazione.importo || 0).toFixed(2)}</td>
                <td class="text-center">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary btn-sm me-1"
                            title="Modifica transazione"
                            data-id="${transazione.id || ''}"
                            data-descrizione='${JSON.stringify(transazione.descrizione)}'
                            data-importo="${transazione.importo}"
                            data-data='${JSON.stringify(transazione.data)}'
                            data-categoria="${transazione.categoriaId || ''}"
                            data-action="modifica-transazione-attr">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${transazione.id ? `<form method="POST" action="/transazioni/${transazione.id}/elimina" style="display:inline;" data-action="confirm-delete" data-message="Sei sicuro di voler eliminare questa transazione?"><button type="submit" class="btn btn-outline-danger btn-sm"><i class=\"fas fa-trash\"></i></button></form>` : ''}
                    </div>
                </td>
            `;
            try { tbody.appendChild(tr); } catch(e) { /* console.warn removed */ }
        });
    } catch(e) {
    /* console.error removed */
        try { if (window.__tabella_initial_html && tbody) tbody.innerHTML = window.__tabella_initial_html; } catch(e2){}
    }
    
}
// Rendere aggiornaTabella accessibile globalmente (usata dal JS dei filtri)
try { window.aggiornaTabella = aggiornaTabella; } catch(e){}
// Ensure initial render: if model or legacy filtrate is populated, refresh table
    try { if (typeof window.aggiornaTabella === 'function') {
    try { window.aggiornaTabella(); } catch(e){}
} } catch(e){}

// Inizializza i tooltip
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Carica automaticamente le categorie di uscita per il form di aggiunta rapida
    setTimeout(function() {
        popolaCategorieSelect('add_categoria_id', 'uscita');
    }, 100);
});

// Assicura il popolamento delle categorie anche al completo caricamento della pagina
window.addEventListener('load', function() {
    popolaCategorieSelect('add_categoria_id', 'uscita');
});

// Funzione per navigare tra i mesi
function navigateMonth(direction) {
    let currentStartStr = '{{ start_date }}'; // formato YYYY-MM-DD
    let year, month;
    if (/^\d{4}-\d{2}-\d{2}$/.test(currentStartStr)) {
        [year, month] = currentStartStr.split('-').map(Number);
    } else {
        // Fallback: usa la data corrente
        const now = new Date();
        year = now.getFullYear();
        month = now.getMonth() + 1;
    }
    let newYear = year;
    let newMonth = month + direction;
    if (newMonth > 12) {
        newMonth = 1;
        newYear++;
    } else if (newMonth < 1) {
        newMonth = 12;
        newYear--;
    }
    // Calcola mese/anno per end_date (mese successivo)
    let endMonth = newMonth + 1;
    let endYear = newYear;
    if (endMonth > 12) {
        endMonth = 1;
        endYear++;
    }
    // Limiti periodo: dal 27 del mese corrente al 26 del mese successivo
    const startDateStr = `${newYear}-${String(newMonth).padStart(2, '0')}-27`;
    const endDateStr = `${endYear}-${String(endMonth).padStart(2, '0')}-26`;
        window.location.href = `/dettaglio/${startDateStr}/${endDateStr}`;
}

// category filter removed: popolaFiltroCategoria removed
</script>

<!-- Chart.js datalabels plugin (for showing percentages inside segments)
     Load defensively to avoid triggering lockdown/install extensions that modify intrinsics.
     Prefer a local copy at /static/vendor/chartjs-plugin-datalabels.min.js if available. If not,
     attempt CDN but only register the plugin when no SES/lockdown-like globals are detected. -->
<script>
// Helper to inject a script tag and await load/error
function loadScript(src) {
    return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = () => resolve();
        s.onerror = (e) => reject(e);
        document.head.appendChild(s);
    });
}

// Try to load local copy first, then CDN as fallback. But registration of the plugin is
// always guarded by SES/lockdown detection below to avoid noisy console logs from extensions.
 (async function() {
    const localPath = '/static/vendor/chartjs-plugin-datalabels.min.js';
    const cdnPath = 'https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js';
    try {
        // Detect SES/lockdown-like globals early and skip loading plugins if present
        const sesActive = (typeof window.lockdown === 'function') || (typeof window.harden === 'function') || (typeof window.SES !== 'undefined') || !!window.__SES__;
        if (sesActive) {
            /* console.warn removed */
            return;
        }

        // Attempt local load; if it fails, attempt CDN
        await loadScript(localPath).catch(async () => {
            await loadScript(cdnPath).catch(() => {/* ignore - plugin optional */});
        });
    } catch (e) {
        // Any error during plugin load should not break the page; plugin is optional.
    
    }
})();
</script>
<script>
// Chart utilities for uscite per categoria
let _usciteChartInstance = null;
const generateDistinctColors = (n) => {
    const colors = [];
    const goldenAngle = 137.508; // golden angle, buona per distribuire i colori
    for (let i = 0; i < n; i++) {
        const hue = (i * goldenAngle) % 360;
        const sat = 62 + (i % 3 === 0 ? 6 : (i % 2 === 0 ? 0 : -4));
        const light = 48 + (i % 4 === 0 ? -3 : (i % 2 === 0 ? 0 : 3));
        colors.push(`hsl(${hue.toFixed(1)}, ${sat}%, ${light}%)`);
    }
    return colors;
};

function buildUsciteChart(labels, data) {
    const canvas = document.getElementById('uscitePieChart');
    const noDataElem = document.getElementById('uscitePieNoData');
    if (!canvas) return null;

    if (!labels || labels.length === 0) {
        canvas.style.display = 'none';
        if (noDataElem) noDataElem.style.display = '';
        return null;
    }

    canvas.style.display = '';
    if (noDataElem) noDataElem.style.display = 'none';

    const bgColors = generateDistinctColors(labels.length);
    const ctx = canvas.getContext('2d');

    if (_usciteChartInstance) {
        try { _usciteChartInstance.destroy(); } catch (e) {}
        _usciteChartInstance = null;
    }

    // Register datalabels plugin if available -- but avoid registering when SES/lockdown-like intrinsics are present
    try {
        const sesActive = (typeof window.lockdown === 'function') || (typeof window.harden === 'function') || (typeof window.SES !== 'undefined') || !!window.__SES__;
        if (sesActive) {
            // Some browser extensions inject SES/lockdown and then modify intrinsics, which causes noisy logs.
            // Skip registering plugins to avoid triggering those messages.
            /* console.warn removed */
        } else if (window.Chart && typeof window.ChartDataLabels !== 'undefined') {
            try {
                Chart.register(window.ChartDataLabels);
            } catch (regErr) {
                
            }
        }
    } catch(e) {
    
    }

    const total = data.reduce((s, v) => s + (Number(v) || 0), 0);

    // Prepare labels: if DataLabels plugin is not available, append percentuale to labels as a fallback
    let labelsToUse = labels;
    try {
        const datalabelsAvailable = (typeof window.ChartDataLabels !== 'undefined');
        if (!datalabelsAvailable && total > 0) {
            labelsToUse = labels.map((lab, idx) => {
                const v = Number(data[idx]) || 0;
                const pct = total ? (v / total) * 100 : 0;
                return `${lab} (${pct.toFixed(1)}%)`;
            });
        }
    } catch (e) {
        // ignore and fall back to original labels
        labelsToUse = labels;
    }

    _usciteChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labelsToUse,
            datasets: [{
                data: data,
                backgroundColor: bgColors,
                borderColor: '#fff',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                // Data labels inside segments
                datalabels: {
                    color: '#ffffff',
                    formatter: function(value, ctx) {
                        if (!total || total === 0) return '';
                        const pct = (value / total) * 100;
                        // Hide very small slices to avoid overlapping labels
                        return pct >= 2 ? pct.toFixed(1) + '%' : '';
                    },
                    font: { weight: '600', size: 12 },
                    clamp: true,
                    anchor: 'center',
                    align: 'center'
                },
                tooltip: { callbacks: {
                    label: function(context) {
                        const v = context.parsed || 0;
                        return `${context.label}: € ${v.toFixed(2)}`;
                    }
                }}
            }
        }
    });

    return _usciteChartInstance;
}

function updateUsciteChartFromStats(stats) {
    const uscitaStats = stats.filter(s => s.tipo === 'uscita' && (s.totale || 0) > 0);
    const labels = uscitaStats.map(s => s.nome);
    const data = uscitaStats.map(s => Math.abs(parseFloat(s.totale) || 0));
    buildUsciteChart(labels, data);
}

async function refreshUsciteChart(year, month) {
    try {
        const resp = await fetch(`/dettaglio/api/statistiche/${year}/${month}`);
        const payload = await resp.json();
        if (payload && payload.success && payload.stats_categorie) {
            updateUsciteChartFromStats(payload.stats_categorie);
        }
    } catch (err) {
    /* console.error removed */
    }
}

// Init chart on page load from embedded stats_categorie when available, otherwise fetch via API
document.addEventListener('DOMContentLoaded', function() {
    try {
        const raw = document.getElementById('stats-categorie-data');
        const canvasEl = document.getElementById('uscitePieChart');
        if (canvasEl) {
            // ensure visible area
            canvasEl.style.display = '';
            canvasEl.style.minHeight = '220px';
        }
        if (!raw) {
            // try to fetch via API using dataset
            if (canvasEl) {
                const year = parseInt(canvasEl.dataset.anno || '0', 10);
                const month = parseInt(canvasEl.dataset.mese || '0', 10);
                if (year && month) refreshUsciteChart(year, month);
            }
            return;
        }
        const stats = JSON.parse(raw.textContent || '[]');
        try {
            
            
        } catch(e) { /* ignore */ }
        if (stats && stats.length > 0) {
            try {
                updateUsciteChartFromStats(stats);
            } catch (err) {
                /* console.error removed */
            }
        } else {
            // fallback to API if no embedded stats
            if (canvasEl) {
                const year = parseInt(canvasEl.dataset.anno || '0', 10);
                const month = parseInt(canvasEl.dataset.mese || '0', 10);
                if (year && month) refreshUsciteChart(year, month);
            }
        }
    } catch (err) {
    /* console.error removed */
    }
});
</script>

<script>
// Inline editor for monthly budget (moved here to scripts block)
document.addEventListener('DOMContentLoaded', function(){
    document.addEventListener('click', function(e) {
        const btn = e.target.closest && e.target.closest('.btn-edit-budget');
        if (!btn) return;
        const categoria = btn.getAttribute('data-categoria');
        const iniz = btn.getAttribute('data-iniziale') || '0.00';

        const td = btn.closest('td');
        if (!td) return;
        const initSpan = td.querySelector('.iniziale-val');
        if (!initSpan) return;
        if (td.querySelector('.inline-budget-editor')) return;

        const editor = document.createElement('div');
        editor.className = 'inline-budget-editor d-flex align-items-center';
        editor.style.gap = '8px';
        editor.style.transition = 'opacity 180ms ease, transform 180ms ease';
        editor.style.opacity = '0';
        editor.style.transform = 'translateY(-4px)';

        const input = document.createElement('input');
        input.type = 'number';
        input.step = '0.01';
        input.min = '0';
        input.value = iniz.replace(',', '.');
        input.className = 'form-control form-control-sm';
        input.style.width = '120px';

        const saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.className = 'btn btn-success btn-sm d-flex align-items-center justify-content-center';
        saveBtn.innerHTML = '<i class="fas fa-check"></i>';
        saveBtn.title = 'Salva';

        const cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'btn btn-outline-secondary btn-sm d-flex align-items-center justify-content-center';
        cancelBtn.innerHTML = '<i class="fas fa-times"></i>';
        cancelBtn.title = 'Annulla';

        editor.appendChild(input);
        editor.appendChild(saveBtn);
        editor.appendChild(cancelBtn);

        // Nascondi il valore e TUTTI i pulsanti di modifica presenti nel TD
        // mentre l'editor è aperto. Usiamo style.display per non dipendere da
        // classi di utilità esterne (più robusto se bootstrap non è caricato).
        initSpan.style.display = 'none';
        const editButtons = td.querySelectorAll('.btn-edit-budget');
        console.debug('[budget-editor] found edit buttons:', editButtons.length, editButtons);
        editButtons.forEach((b, idx) => {
            try {
                // Forza il nascondimento con inline style important (più robusto)
                b.style.setProperty('display', 'none', 'important');
                b.setAttribute('aria-hidden', 'true');
                b.setAttribute('data-hidden-by-js', '1');
                console.debug(`[budget-editor] hid button ${idx}`, b);
            } catch(e) {
                console.debug('[budget-editor] hide error', e);
            }
        });
        td.appendChild(editor);
        requestAnimationFrame(() => {
            editor.style.opacity = '1';
            editor.style.transform = 'translateY(0)';
        });

        const cleanup = () => {
            editor.style.opacity = '0';
            editor.style.transform = 'translateY(-4px)';
            setTimeout(() => {
                editor.remove();
                initSpan.style.display = '';
                // Ripristina tutti i pulsanti edit nel TD che avevamo nascosto
                const editButtonsRestore = td.querySelectorAll('.btn-edit-budget');
                console.debug('[budget-editor] restoring edit buttons:', editButtonsRestore.length);
                editButtonsRestore.forEach((b, idx) => {
                    try {
                        if (b.getAttribute('data-hidden-by-js')) {
                            b.style.removeProperty('display');
                            b.removeAttribute('data-hidden-by-js');
                        }
                        b.removeAttribute('aria-hidden');
                        console.debug(`[budget-editor] restored button ${idx}`, b);
                    } catch(e) {
                        console.debug('[budget-editor] restore error', e);
                    }
                });
            }, 200);
        };

        cancelBtn.addEventListener('click', cleanup);

        saveBtn.addEventListener('click', async function() {
            try {
                const val = parseFloat(input.value);
                if (isNaN(val)) { alert('Valore non valido'); return; }

                const canvasEl = document.getElementById('uscitePieChart');
                const year = canvasEl ? parseInt(canvasEl.dataset.anno || '0', 10) : 0;
                const month = canvasEl ? parseInt(canvasEl.dataset.mese || '0', 10) : 0;

                const resp = await fetch('{{ url_for("dettaglio_periodo.monthly_budget_update") }}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({categoria_id: categoria, year: year, month: month, importo: val})
                });
                const data = await resp.json();
                if (!data || !data.success) {
                    alert('Errore durante l\'aggiornamento: ' + (data && data.error ? data.error : 'unknown'));
                    // ripristina UI editor / pulsante anche in caso di errore
                    cleanup();
                    return;
                }

                initSpan.textContent = '€ ' + (data.importo || 0).toFixed(2);
                const row = td.parentElement;
                if (data.budget_item && row) {
                    const residuoCell = row.querySelectorAll('td')[4];
                    if (residuoCell) {
                        residuoCell.textContent = '€ ' + ((data.budget_item.residuo || 0).toFixed ? data.budget_item.residuo.toFixed(2) : (data.budget_item.residuo || 0));
                        residuoCell.className = (data.budget_item.residuo < 0) ? 'text-danger' : 'text-success';
                    }
                }
                const usciteElem = document.querySelectorAll('.card-body h4')[2];
                const bilancioElem = document.querySelectorAll('.card-body h4')[3];
                if(usciteElem && typeof data.uscite !== 'undefined') usciteElem.textContent = '€ ' + (data.uscite || 0).toFixed(2);
                if(bilancioElem && typeof data.bilancio !== 'undefined') bilancioElem.textContent = (data.bilancio >=0 ? '+' : '') + '€ ' + (data.bilancio || 0).toFixed(2);

                // Aggiorna il grafico delle uscite per il mese corrente
                try {
                    const canvasEl = document.getElementById('uscitePieChart');
                    const year = canvasEl ? parseInt(canvasEl.dataset.anno || '0', 10) : 0;
                    const month = canvasEl ? parseInt(canvasEl.dataset.mese || '0', 10) : 0;
                    if (typeof refreshUsciteChart === 'function' && year && month) refreshUsciteChart(year, month);
                } catch(e) {
                    // ignore
                }

                cleanup();
            } catch (err) {
                /* console.error removed */
                alert('Errore durante l\'aggiornamento. Controlla la console.');
                // assicurati di ripristinare il pulsante se qualcosa va storto
                try { cleanup(); } catch(e) {}
            }
        });
    });
});
</script>

<style>
.nav-arrow {
    transition: all 0.3s ease;
}

.nav-arrow:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    background-color: #0d6efd !important;
}

.nav-arrow:hover i {
    text-shadow: 0 0 5px rgba(255,255,255,0.8);
}
</style>
{% endblock %}
